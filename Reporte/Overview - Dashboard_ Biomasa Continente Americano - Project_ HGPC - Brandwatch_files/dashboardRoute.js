(function(){define("src/models/DashboardCollection",["backbone","src/globals/flags","src/globals/flagNames","src/models/Dashboard"],function(Backbone,flags,FLAGS,Dashboard){"use strict";return Backbone.Collection.extend({model:Dashboard,sortedBy:"lastSaved",sortedAsc:true,initialize:function initialize(models,options){options=options||{};this.projectId=options.projectId;this.filter=options.filter;this.isLoading=true;this.bind("change",this.updateLoading,this);this.bind("reset",this.updateLoading,this);this.bind("add",this.updateLoading,this);this.bind("remove",this.updateLoading,this)},getByName:function getByName(name){return this.detect(function(cat){return cat.get("name")===name})},updateLoading:function updateLoading(){this.isLoading=false},fetch:function fetch(options){options=options||{};var self=this,success=options.success||function(){};if(!this.projectId){throw new Error("this.projectId must be set!")}this.isLoading=true;options.success=function(){self.updateLoading();success.apply(this,arguments)};Backbone.Collection.prototype.fetch.call(this,options)},url:function url(){var enableSummaryEndpoint=flags.variation(FLAGS.ENABLE_OPTIMISED_DASHBOARD_LIST);if(enableSummaryEndpoint){return"/projects/{projectId}/dashboards/summary"}return"/projects/{projectId}/dashboards"}})});function _toConsumableArray(arr){return _arrayWithoutHoles(arr)||_iterableToArray(arr)||_nonIterableSpread()}function _nonIterableSpread(){throw new TypeError("Invalid attempt to spread non-iterable instance")}function _iterableToArray(iter){if(Symbol.iterator in Object(iter)||Object.prototype.toString.call(iter)==="[object Arguments]")return Array.from(iter)}function _arrayWithoutHoles(arr){if(Array.isArray(arr)){for(var i=0,arr2=new Array(arr.length);i<arr.length;i++){arr2[i]=arr[i]}return arr2}}define("src/helpers/dashboardExports/status",["jquery","bw-fe-helpers/promiseHelper","src/appNotifications"],function($,promiseHelper,appNotifications){"use strict";var POLL_INTERVAL=2*1e3;var SUCCESS_NOTIFICATION_CLASS="notification-success";var ERROR_NOTIFICATION_CLASS="notification-error";var NOTIFICATION_KEY_PREFIX="dashboardExportStatus";var successNotificationCount=0;var pollingTimeout;var exportsToPoll=new Map;function getSuccessLink(projectId,exportId,dashboardName){var successCountText=successNotificationCount<=1?"":"(1 of "+successNotificationCount+") ";var downloadHref="/project/".concat(projectId,"/reports/exports/download/").concat(exportId,".pptx");return"\n            Export ".concat(successCountText,'"').concat(dashboardName,'" complete.\n            <a class="linkwhite js-download" href="').concat(downloadHref,'" target="_blank">Download Now</a>\n        ')}function getFailureLink(dashboardName){return'Export "'.concat(dashboardName,'" failed.')}function showSuccessNotification(projectId,exportId,dashboardName){var key="".concat(NOTIFICATION_KEY_PREFIX,"-").concat(exportId);successNotificationCount++;appNotifications.show({key:key,messageHtml:getSuccessLink(projectId,exportId,dashboardName),cssClass:SUCCESS_NOTIFICATION_CLASS}).one("click",".js-download",downloadHandler.bind(null,key)).one("click",".close",onClose)}function showFailureNotification(exportId,dashboardName){appNotifications.show({key:"".concat(NOTIFICATION_KEY_PREFIX,"-").concat(exportId),messageHtml:getFailureLink(dashboardName),cssClass:ERROR_NOTIFICATION_CLASS})}function removeExportsMissingFromResponse(exportsPending){exportsToPoll.forEach(function(exportToPoll,exportIdToPoll){if(!exportsPending.has(exportIdToPoll)){showFailureNotification(exportIdToPoll,exportToPoll.dashboardName);exportsToPoll.delete(exportIdToPoll)}})}function processResults(results){var exportsPending=new Set;results.forEach(function(_ref){var exportId=_ref.exportId,status=_ref.status;var _ref2=exportsToPoll.get(exportId)||{},projectId=_ref2.projectId,dashboardName=_ref2.dashboardName;if(status==="completed"){showSuccessNotification(projectId,exportId,dashboardName);exportsToPoll.delete(exportId)}else if(status==="failed"){showFailureNotification(exportId,dashboardName);exportsToPoll.delete(exportId)}else if(status===null){exportsPending.add(exportId)}});removeExportsMissingFromResponse(exportsPending);if(_toConsumableArray(exportsToPoll).length){pollingTimeout=setTimeout(poll,POLL_INTERVAL)}}function poll(){var exportIds=_toConsumableArray(exportsToPoll.keys()).map(function(id){return"exportIds=".concat(id)}).join("&");var url="/export-status?".concat(exportIds);clearTimeout(pollingTimeout);return promiseHelper.wrapJqXHR($.get(url)).then(processResults).catch(function(err){console.log(err);pollingTimeout=setTimeout(poll,POLL_INTERVAL)})}function addDashboardExport(exportToPoll){exportsToPoll.set(exportToPoll.exportId,exportToPoll);pollingTimeout=setTimeout(poll,POLL_INTERVAL)}function clearQueue(){exportsToPoll.clear();clearTimeout(pollingTimeout)}function downloadHandler(key){successNotificationCount--;appNotifications.remove(key)}function onClose(){successNotificationCount--}return{addDashboardExport:addDashboardExport,clearQueue:clearQueue,_poll:poll}});define("src/helpers/dashboardExports/supportedExportComponents",["src/globals/flags","src/globals/flagNames"],function(flags,FLAGS){"use strict";function supportedExportComponents(){var additionalComponents=[];var standardComponents=[{componentName:"Key Insights"},{componentName:"Sentiment"},{componentName:"Demographics"},{componentName:"Word Cloud"},{componentName:"Volume Over Time"},{componentName:"Mention List"},{componentName:"Top Authors"},{componentName:"Emoji Cloud"},{componentName:"Video Shares"},{componentName:"Unique Authors Over Time"},{componentName:"Page Types Over Time"}];if(flags.variation(FLAGS.EXPORT_NOTES)){additionalComponents.push({componentName:"Notes"})}return[].concat(standardComponents,additionalComponents)}return supportedExportComponents});define("mustache!templates/dashboardExportConfirm",["lib/mustache"],function(mustache){var escapedTemplate="<p>Your file will be exported and sent to <strong>{{email}}</strong></p>\n<div>\n<p>The following components are currently supported:</p>\n<ul>\n{{#supportedComponents}}\n<li>{{componentName}}</li>\n{{/supportedComponents}}\n</ul>\n</div>\n";return function(data,partials,wrap){return mustache.render(escapedTemplate,data,partials,wrap)}});define("src/helpers/dashboardExports/export",["underscore","src/events/dashboardExportEvents","src/events/globalEventNames","src/helpers/dashboardExports/status","src/globals/me","src/helpers/dashboardExports/supportedExportComponents","mustache!templates/dashboardExportConfirm","bw-fe-helpers/promiseHelper"],function(_,dashboardExportEvents,globalEventNames,dashboardExportStatusHelper,me,supportedExportComponents,dashboardExportConfirmTemplate,promiseHelper){"use strict";var confirmExportModal;function confirmExportDashboard(view){var options=arguments.length>1&&arguments[1]!==undefined?arguments[1]:{};var model;if(options.hasOwnProperty("model")){model=options.model}else{model=view.model}confirmExportModal=displayConfirmExportModal.bind(null,view,model,options);confirmExportModal()}function displayConfirmExportModal(view,model,options){trackDashboardExportInitiated(model);var email=me.get("username");var confirmText=dashboardExportConfirmTemplate({email:email,supportedComponents:supportedExportComponents});view.showConfirmExportNotification({confirmText:confirmText},function(confirmed){if(confirmed){exportDashboard(view,model,options)}})}function exportDashboard(view,model,options){var tabId="";var url="";if(options.hasOwnProperty("tabId")){tabId="&tabId=".concat(options.tabId)}if(model.get("id")===undefined){url="/project/".concat(model.get("projectId"),"/")+"export?format=powerpoint&email=".concat(me.get("username"))+tabId}else{url="/project/".concat(model.get("projectId"),"/dashboard/").concat(model.get("id"))+"/export?format=powerpoint&email=".concat(me.get("username"))+tabId}trackDashboardExportRequested(model);var request={method:"POST",url:url,contentType:"application/json"};var _options$sendDashboar=options.sendDashboardJSON,sendDashboardJSON=_options$sendDashboar===void 0?true:_options$sendDashboar;if(sendDashboardJSON){request.data=JSON.stringify(model.toJSON())}return promiseHelper.ajax(request).then(function(response){var exportId=response.exportId;var dashboardName=model.escape("name");var projectId=model.get("projectId");dashboardExportStatusHelper.addDashboardExport({projectId:projectId,exportId:exportId,dashboardName:dashboardName});view.showPermanentNotification({text:'PowerPoint file for "'+dashboardName+'" is being prepared.'+" We'll email you when it's ready.",type:"notification-info"})}).catch(function(){view.showPermanentNotification({text:"PowerPoint exports not available at this time. Please try again later.",type:"notification-error"})})}function trackDashboardExportRequested(model){dashboardExportEvents.trigger(globalEventNames.DASHBOARD_EXPORTS.EXPORT_REQUESTED,{dashboardId:model.id,dashboardType:_.capitalize(model.get("dashboardType")),projectId:model.get("projectId"),exportFormat:"powerpoint"})}function trackDashboardExportInitiated(model){dashboardExportEvents.trigger(globalEventNames.DASHBOARD_EXPORTS.EXPORT_INITIATED,{dashboardId:model.id,dashboardType:_.capitalize(model.get("dashboardType")),projectId:model.get("projectId"),asyncExports:true,exportFormat:"powerpoint"})}return{confirmExportModal:confirmExportModal,confirmExportDashboard:confirmExportDashboard}});define("src/helpers/dashboardExports/access",["src/globals/flags","src/globals/flagNames","src/globals/theme"],function(flags,FLAGS,theme){"use strict";return{userCanExport:function userCanExport(){if(flags.variation(FLAGS.DASHBOARD_EXPORT_FORCE_WHITELABEL)){return true}if(flags.variation(FLAGS.DASHBOARD_EXPORT)&&theme.isBrandwatchOrGreyLabelTheme()){return true}return false}}});define("src/setupstore/helpers/dashboardTypeHelper",["underscore"],function(_){"use strict";function isWizard(model){var dashboardType=model.get("dashboardType")||"";return _.startsWith(dashboardType,"dashboardWizard_")}return{isWizard:isWizard}});define("mustache!templates/dashboardToolbarContextMenu",["lib/mustache"],function(mustache){var escapedTemplate='{{#canApplyQuery}}\n<li class="js-item context-menu--item customtip" data-action="{{events.CHANGE_DATA_SOURCE}}" title="Apply Data Source to all Dashboard Components">\n<a><span class="icon-bwdata lightgrey smallpadding-right"></span>Data Source</a>\n</li>\n{{/canApplyQuery}}\n\n{{#canEdit}}\n<li class="js-item context-menu--item customtip" data-action="{{events.CHANGE_TIMEZONE}}" title="Apply time zone to Dashboard">\n<a><span class="icon-globe lightgrey smallpadding-right"></span>Time Zone</a>\n</li>\n{{/canEdit}}\n\n{{#showSeparator}}\n<li class="context-menu--item separator"></li>\n{{/showSeparator}}\n\n{{#canRerunDashboardWizard}}\n<li class="js-item context-menu--item customtip" data-action="{{events.REQUEST_RERUN}}" title="Edit your Wizard segmentation and update your Dashboard">\n<a><span class="icon-undo lightgrey smallpadding-right"></span>Rerun Dashboard Wizard</a>\n</li>\n{{/canRerunDashboardWizard}}\n\n{{#canCreate}}\n<li class="js-item context-menu--item customtip" data-action="{{events.REQUEST_TEMPLATE}}" title=\'Download  this Dashboard as a template\'>\n<a><span class="icon-bwdownload lightgrey smallpadding-right"></span>Download as Template</a>\n</li>\n<li class="js-item context-menu--item customtip" data-action="{{events.REQUEST_DUPLICATE}}" title="Make a copy of this Dashboard">\n<a><span class="icon-bwcopy lightgrey smallpadding-right"></span>Duplicate</a>\n</li>\n{{/canCreate}}\n\n{{#canRevert}}\n<li class="context-menu--item separator"></li>\n<li class="js-item context-menu--item iconindent" data-action="{{events.REQUEST_REVERT}}">\n<a class="smallpadding-left"><span class="lightgrey"></span>Revert to a previous version&hellip; <span class="newIcon"></span></a>\n</li>\n{{/canRevert}}\n';return function(data,partials,wrap){return mustache.render(escapedTemplate,data,partials,wrap)}});define("src/views/DashboardToolbarContextMenuView",["jquery","underscore","src/globals/me","src/permissions","src/views/ContextMenuView","src/setupstore/helpers/dashboardTypeHelper","mustache!templates/dashboardToolbarContextMenu","src/packages/customtip"],function($,_,me,permissions,ContextMenuView,dashboardTypeHelper,template){"use strict";var eventNames={CHANGE_DATA_SOURCE:"CHANGE_DATA_SOURCE",CHANGE_TIMEZONE:"CHANGE_TIMEZONE",REQUEST_RERUN:"REQUEST_RERUN",REQUEST_TEMPLATE:"REQUEST_TEMPLATE",REQUEST_DUPLICATE:"REQUEST_DUPLICATE",REQUEST_REVERT:"REQUEST_REVERT"};var DashboardToolbarContextMenuView=ContextMenuView.extend({tagName:"ul",className:"context-menu popupframe",events:{"click .js-item":function onClickItem(e){var $currentTarget=$(e.currentTarget);var action=$currentTarget.data("action");$currentTarget.customtip("hide");e.stopPropagation();this.trigger(action);this.remove()}},constructor:function DashboardToolbarContextMenuView(options){ContextMenuView.apply(this,arguments);options=options||{};if(!options.model){throw new Error("DashboardToolbarContextMenuView requires options.model")}},render:function render(){var model=this.model;var isOwner=model.get("userId")===me.id;var data={name:model.get("name"),events:eventNames,canApplyQuery:permissions.check("see.dashboard.controls.queryField",model),canEdit:permissions.check("edit.dashboard",model),canCreate:permissions.check("edit.dashboard")};data.canRevert=isOwner;data.canRerunDashboardWizard=data.canEdit&&isOwner&&dashboardTypeHelper.isWizard(model);data.showSeparator=data.canCreate||data.canRerunDashboardWizard;this.$el.html(template(data));this.$el.customtip({position:"right"})}});_.extend(DashboardToolbarContextMenuView,eventNames);return DashboardToolbarContextMenuView});define("mustache!templates/shareDashboard",["lib/mustache"],function(mustache){var escapedTemplate='<header>\n<h1 class="popuptitletext singlemargin-bottom draggable">{{title}}</h1>\n</header>\n<div class="overlay hidden"></div>\n<div class="body">\n<form><div class="errorPane notification-error rounded smallpadding-vertical singlepadding-horizontal singlemargin-bottom hidden"></div></form>\n<div class="modeSelectorContainer lightgreybg rounded singlepadding">\n<div class="bold">Give access to</div>\n<select class="modeSelector selectfield smallmargin-top">\n<option value="none">Nobody</option>\n<option value="user">Individual Users</option>\n<option value="project">All Members of Project "{{projectName}}"</option>\n</select>\n<div class="infoContainer dib valignmiddle smallmargin-top">\n<div class="info project hidden">(<b>current</b> and <b>future</b> members of this Project)</div>\n</div>\n</div>\n<div class="modeSettings">\n<div class="hidden none">\n<span>Other users <b>cannot edit or see</b> this Dashboard.</span>\n</div>\n<div class="hidden user">\n{{#canEditUsers}}\n<span class="shareProjectLink absright absbottom pagemargin-right pagemargin-bottom">\nCan\'t find a user? <a class="shareProject">Edit Project Members</a> <a class="help icon-bwhelp" data-key="edit-project-sharing"></a>\n</span>\n{{/canEditUsers}}\n</div>\n<div class="hidden project singlemargin-left">\n<label class="singlemargin-vertical">Share in:</label>\n<fieldset>\n<input type="radio" name="projectPermission" id="view" value="view" checked />\n<label for="view" class="selected">View mode</label>\n<span>Members of this Project can only change the date range <a class="help icon-bwhelp" data-key="share-dashboard-project-view"></a></span>\n<input type="radio" name="projectPermission" id="analyst" value="analyst" />\n<label for="analyst">Analyst mode</label>\n<span>Members of this Project can apply Filters and change mentions data <a class="help icon-bwhelp" data-key="share-dashboard-project-analyst"></a></span>\n</fieldset>\n</div>\n</div>\n</div>\n<footer class="doublemargin-top">\n<button class="save defaultbutton" disabled>Apply &amp; Save Dashboard</button>\n<button class="cancel button singlemargin-left">Cancel</button>\n<div class="loading-small singlemargin-left hidden"></div>\n<div class="clearboth"></div>\n</footer>\n';return function(data,partials,wrap){return mustache.render(escapedTemplate,data,partials,wrap)}});define("mustache!templates/shareClientList",["lib/mustache"],function(mustache){var escapedTemplate='<div class="loading">Loading Users List</div>\n<div class="hidden userList">\n<div class="permissionSelector dropdown vhidden singlemargin-top smallpadding-vertical singlepadding-horizontal dib">\n<button class="dropdown-toggle button" data-toggle="dropdown">Change Permission<span class="smallpadding-horizontal icon-chevron-down"></span></button>\n<ul class="context-menu popupframe modular">\n<li class="context-menu--item unshared">Set as <b>Unshared</b></li>\n<li class="context-menu--item view">Set as <b>View</b></li>\n<li class="context-menu--item analyst">Set as <b>Analyst</b></li>\n</ul>\n<div class="count grey smallpadding-left dib"></div>\n</div>\n<div class="singlepadding-vertical floatright">\n<input type="text" class="threecol iconfield search" placeholder="Search Users" />\n</div>\n<div class="listHeader">\n<div class="dib cb"><input type="checkbox" class="toggleSelectAll customtip" title="Select all" /></div>\n<div class="dib projectheader singlepadding-right">Project Members</div>\n<span class="smalladding-horizontal">Unshared <a class="help icon-bwhelp" data-key="share-dashboard-unshared-column"></a></span>\n<span class="singlepadding-horizontal">View <a class="help icon-bwhelp" data-key="share-dashboard-view-column"></a></span>\n<span class="singlepadding-horizontal">Analyst <a class="help icon-bwhelp" data-key="share-dashboard-analyst-column"></a></span>\n</div>\n<div class="listBody">\n<fieldset>\n<ul class="clients"></ul>\n</fieldset>\n</div>\n<div class="js-noresultsfromsearch singlemargin-top grey hidden">No Users found.</div>\n</div>\n';return function(data,partials,wrap){return mustache.render(escapedTemplate,data,partials,wrap)}});define("mustache!templates/shareClientListClient",["lib/mustache"],function(mustache){var escapedTemplate='<li class="{{type}}" data-clientid="{{id}}">\n<span>{{name}}</span>\n<a class="toggleSelectClient">Select all in client</a>\n</li>\n';return function(data,partials,wrap){return mustache.render(escapedTemplate,data,partials,wrap)}});define("mustache!templates/shareClientListUser",["lib/mustache"],function(mustache){var escapedTemplate='<li class="js-entry" data-userid="{{id}}" data-filter="{{filterText}}">\n<div class="dib cb valigntop"><input type="checkbox" id="select-{{id}}" class="customtip" title="Select for bulk changes"></div>\n<div class="dib user"><span class="email customtip" title="{{name}}">{{email}}</span><span class="role customtip ellipsistooltip" title="{{role}}">({{role}}  user)</span></div>\n<div class="dib customtip" title="Don\'t share Dashboard">\n<label><input type="radio" name="user-{{id}}" value="none" checked /><i class="tinymargin-left iconsmall icon-lock"></i></label>\n</div>\n<div class="dib customtip" title="Share Dashboard in view mode">\n<label><input type="radio" name="user-{{id}}" value="view" /><i class="tinymargin-left iconsmall icon-bwusers"></i></label>\n</div>\n<div class="dib customtip" title="{{analystTitle}}" >\n<label><input type="radio" name="user-{{id}}" value="analyst" {{analystState}} /><i class="tinymargin-left iconsmall icon-bwusers"></i></label>\n</div>\n</li>\n';return function(data,partials,wrap){return mustache.render(escapedTemplate,data,partials,wrap)}});define("css!css/shareClientList.css",["css!css/compiled.css"],function(){});define("css!lib/jquery.clearabletext/jquery.clearableText.css",["css!lib/jquery.clearabletext/compiled.css"],function(){});(function($){"use strict";$.fn.clearableTextField=function(){var $this=$(this);if($this.length<=0){return}$this.on("keyup change paste cut input",function(){trigger($this)});$this.each(function(){$this.data("original-padding-right",$this.css("padding-right"));addClearButton($this)})};function trigger(input){var clearButton=input.closest(".clearButtonWrapper").find(".textClearButton");if(input.val().length>0){clearButton.show();updateClearButtonPosition(input,clearButton)}else{clearButton.hide()}}function updateClearButtonPosition(input,clearButton){var pos=input.position(),offset=Math.round((input.outerHeight(true)-clearButton.outerHeight())/2);clearButton.css({top:pos.top+offset})}function addClearButton(input,setFocus){var wrap=input.parent(),clearButton,w;if(!wrap.hasClass("clearButtonWrapper")){wrap=input.wrap('<div class="clearButtonWrapper" />')}input.after("<div class='textClearButton'></div>");clearButton=input.next();w=clearButton.outerHeight();input.css("padding-right",input.data("original-padding-right")+w+4);updateClearButtonPosition(input,clearButton);clearButton.click(function(){input.val("");trigger(input);input.change();input.focus()});if(!input.val().length){clearButton.hide()}if(setFocus&&!_.isUndefined(setFocus)){input.focus()}}})(jQuery);define("lib/jquery.clearabletext/jquery.clearableText",function(){});(function($,_,window){"use strict";$.fn.kruddysearch=function(opt){if(_.isUndefined(opt)){return this.each(function(){$(this).trigger("applyFilter")})}var timeout;var val="";var options=_.defaults(opt,{delay:100,listContainerSelector:null,itemSelector:null,noResultsSelector:"",on:"keyup input mouseup change",clearable:true,hiddenClass:"hidden",filterData:"filter",onBefore:null,onAfter:null});function showNoResults(bool){if(_.isString(options.noResultsSelector)&&options.noResultsSelector){var el=$(options.listContainerSelector).find(options.noResultsSelector);if(bool){el.removeClass("hidden")}else{el.addClass("hidden")}}}function applyFilter(){var $items=$(options.listContainerSelector).find(options.itemSelector),noResults=$items.length>0&&val!=="";$items.each(function(){var $el=$(this);var data=$el.attr("data-"+options.filterData);if(data&&data.indexOf(val)>-1){$el.removeClass(options.hiddenClass);noResults=false}else{$el.addClass(options.hiddenClass)}});showNoResults(noResults);if(_.isFunction(options.onAfter)){options.onAfter()}}function triggerFilter(immediate){if(_.isFunction(options.onBefore)){options.onBefore()}if(immediate){applyFilter()}else{window.clearTimeout(timeout);timeout=window.setTimeout(function(){applyFilter()},options.delay)}}var el=$(this);if(options.clearable&&el.clearableTextField){el.clearableTextField()}return this.each(function(){var self=$(this);self.on(options.on,function(){var oldVal=val;val=self.val().toLowerCase();if(oldVal!==val){triggerFilter()}});self.on("applyFilter",function(){val=self.val().toLowerCase();triggerFilter(true)});if(self.val().trim()!==""){val=self.val().toLowerCase();triggerFilter(true)}else{showNoResults(false)}})}})($,_,this);define("lib/jquery.kruddysearch",function(){});define("src/packages/kruddysearch",["css!lib/jquery.clearabletext/jquery.clearableText.css","lib/jquery.clearabletext/jquery.clearableText","lib/jquery.kruddysearch"],function(){"use strict"});define("src/views/ShareClientListView",["backbone","underscore","jquery","src/globals/me","src/globals/myClient","src/globals/currentProject","mustache!templates/shareClientList","mustache!templates/shareClientListClient","mustache!templates/shareClientListUser","src/models/ProjectSharing","css!css/shareClientList.css","src/packages/dropdownmenus","src/packages/customtip","src/packages/kruddysearch"],function(Backbone,_,$,me,myClient,currentProject,shareClientList,clientTemplate,userTemplate,ProjectSharing){"use strict";function bulkSetPermission(permission,view){var selection=view.$('.users input[type="checkbox"]:checked');selection.closest("li").find('input[type="radio"][value="'+permission+'"]:not(:disabled)').prop("checked",true);view.onChangePermission()}function showUserListLoadingIndicator(view){view.$(".loading").removeClass("hidden");view.$(".userList").addClass("hidden");view.$el.addClass("isLoading")}function hideUserListLoadingIndicator(view){view.$(".loading").addClass("hidden");view.$(".userList").removeClass("hidden");view.$el.removeClass("isLoading")}function getFullName(user){return(user.userFirstName+" "+user.userSurname).trim()}function createNewUser(user){var uiRole=user.userUiRole,fullName=getFullName(user),newUser={id:user.userId,name:fullName,email:user.username,filterText:fullName.toLowerCase()+" "+user.username,role:uiRole||"regular",analystState:uiRole==="view"?"disabled":"",analystTitle:uiRole==="view"?"Can't share in analyst mode with view user":"Share Dashboard in analyst mode"};newUser.role=newUser.role==="superadmin"?"admin":newUser.role;return newUser}function createNewClient(user,clientName,type){return{id:user.clientId,name:clientName,type:type,users:[]}}function getUserData(users){return users.closest("li").toArray().map(function(listElement){var $listElement=$(listElement);return{id:$listElement.data("userid"),email:$listElement.find(".email").text()}})}function setUsersAsChecked(ids,view,domElement){if(!ids||!ids.length){return}ids.forEach(function(id){view.$('li[data-userid="'+id+'"]').find(domElement).prop("checked",true)})}function markUsersAsUnchecked($users,view){$users.prop("checked",false);$users.closest("li").removeClass("selected");view.togglePermissionsButton();view.$(".toggleSelectAll").prop("checked",false)}function markUsersAsChecked($users,view){$users.each(function(index,user){var $user=$(user);if($user.closest("li").hasClass("hidden")){return}$user.prop("checked",true);$user.closest("li").addClass("selected")});view.togglePermissionsButton();if(view.$('.users input[type="checkbox"]').not(":checked").length===0){view.$(".toggleSelectAll").prop("checked",true)}}function initSearch(oldSearchTerm,view){view.$("input.search").val(oldSearchTerm).kruddysearch({listContainerSelector:view.$(".userList"),itemSelector:".js-entry",noResultsSelector:".js-noresultsfromsearch"})}return Backbone.View.extend({className:"shareClientListView",events:{"change .toggleSelectAll":"onToggleSelectAllUsers","click .toggleSelectClient":"onToggleSelectAllPerClient",'change .users input[type="checkbox"]':"onToggleUserCheckbox",'change .users input[type="radio"]':"onChangePermission","click .permissionSelector .unshared":"onBulkUnshare","click .permissionSelector .view":"onBulkShareView","click .permissionSelector .analyst":"onBulkShareAnalyst","click .textClearButton":"onClearText","keyup .search":"onEmptySearchField"},initialize:function initialize(){this.users={}},onBulkUnshare:function onBulkUnshare(){bulkSetPermission("none",this)},onBulkShareView:function onBulkShareView(){bulkSetPermission("view",this)},onBulkShareAnalyst:function onBulkShareAnalyst(){bulkSetPermission("analyst",this)},onChangePermission:function onChangePermission(){this.trigger("selectionChanged")},fetchAllClientsAndUsers:function fetchAllClientsAndUsers(){var view=this,activeUserId=me.id,myClientId=myClient.id,projectSharing=new ProjectSharing([],{projectId:currentProject.id,sharedOnly:true});projectSharing.fetch({success:function success(users){var clients,newUser;clients=_(users.toJSON()).chain().sortBy(function(user){return user.clientName.toLowerCase()}).reduce(function(memo,user){var client,clientName=user.clientName,clientType=myClientId===user.clientId?"client":"subclient";if(!memo[clientType]){memo[clientType]={}}if(!memo[clientType][clientName]){client=createNewClient(user,clientName,clientType);memo[clientType][clientName]=client}if(user.userId!==activeUserId){newUser=createNewUser(user);memo[clientType][clientName].users.push(newUser);view.users[newUser.id]=getFullName(user)}return memo},{client:[],subclient:[]}).reduce(function(memo,clientList){return memo.concat(_(clientList).values())},[]).value();view.renderClientUsers(clients)}})},renderClientUsers:function renderClientUsers(clients){var view=this,$clientList=view.$(".listBody .clients"),totalClients=clients.length;clients.forEach(function(client){var clientId=client.id,$userList=$('<ul class="users"></ul>'),$clientDom;$clientList.append(clientTemplate(client,false));$clientDom=view.$(".clients li[data-clientid="+clientId+"]");if(client.users.length){$userList.append(_(client.users).chain().sortBy(function(user){return user.email.toLowerCase()}).map(function(user){return userTemplate(user,false)}).value().join("\n"))}else{$userList.append('<li><span class="noUsers">No other users have access to the current project.</span></li>');$clientDom.addClass("empty")}$clientDom.addClass("fetched").append($userList);if($clientDom.siblings(".fetched").length+1===totalClients){hideUserListLoadingIndicator(view);view.trigger("renderComplete")}});$clientList.customtip()},setSharedViewUserIds:function setSharedViewUserIds(viewUserIds){var view=this,domSelector='input[value="view"]';setUsersAsChecked(viewUserIds,view,domSelector)},getSharedViewUsers:function getSharedViewUsers(){var viewUsers=this.$('input[value="view"]:checked');return getUserData(viewUsers)},setSharedAnalystUserIds:function setSharedAnalystUserIds(analystUserIds){var view=this,domSelector='input[value="analyst"]:not(:disabled)';setUsersAsChecked(analystUserIds,view,domSelector)},getSharedAnalystUsers:function getSharedAnalystUsers(){var analystUsers=this.$('input[value="analyst"]:checked');return getUserData(analystUsers)},onToggleSelectAllUsers:function onToggleSelectAllUsers(e){var $users=this.$('.users input[type="checkbox"]');if($(e.target).is(":checked")){markUsersAsChecked($users,this);return}markUsersAsUnchecked($users,this)},onToggleSelectAllPerClient:function onToggleSelectAllPerClient(e){var $clientUsers=$(e.target).parent().find('.users input[type="checkbox"]'),$selectedClientUsers=$clientUsers.filter(":checked");if($selectedClientUsers.length<$clientUsers.length){markUsersAsChecked($clientUsers,this);return}markUsersAsUnchecked($clientUsers,this)},onToggleUserCheckbox:function onToggleUserCheckbox(e){var $target=$(e.target);if($target.is(":checked")){markUsersAsChecked($target,this);return}markUsersAsUnchecked($target,this)},togglePermissionsButton:function togglePermissionsButton(){var $selectedUsers=this.$('.users input[type="checkbox"]:checked'),$permissionSelector=this.$(".permissionSelector");if($selectedUsers.length){$permissionSelector.find(".count").text("for "+$selectedUsers.length+($selectedUsers.length===1?" user":" users"));$permissionSelector.removeClass("vhidden");return}$permissionSelector.addClass("vhidden")},refreshUserList:function refreshUserList(){showUserListLoadingIndicator(this);this.$(".listBody .clients").empty();this.fetchAllClientsAndUsers();this.$(".permissionSelector").addClass("hidden");this.$(".toggleSelectAll").prop("checked",false)},onEmptySearchField:function onEmptySearchField(e){if(e.currentTarget.value!==""){return}this.onClearText()},onClearText:function onClearText(){this.$(".toggleSelectAll").prop("checked",false)},render:function render(){var $el=this.$el,oldSearchTerm=this.$("input.search").val();$el.html(shareClientList());this.$(".permissionSelector button").dropdown();showUserListLoadingIndicator(this);this.fetchAllClientsAndUsers();this.$el.customtip();initSearch(oldSearchTerm,this)}})});define("css!css/shareDashboardView.css",["css!css/compiled.css"],function(){});define("src/views/ShareDashboardView",["underscore","jquery","app","src/permissions","src/globals/authorGroups","src/globals/siteGroups","src/globals/currentProject","mustache!templates/shareDashboard","src/views/ValidatingFormView","src/views/ProjectAccessPermissionView","src/views/ShareClientListView","src/globals/locationGroups","src/events/dashboardEvents","src/events/globalEventNames","css!css/shareDashboardView.css","src/packages/modalDialogs","src/packages/customtip","lib/jquery.confirm"],function(_,$,app,permissions,authorGroups,siteGroups,currentProject,shareDashboard,ValidatingFormView,ProjectAccessPermissionView,ShareClientListView,locationGroups,dashboardEvents,globalEventNames){"use strict";var ShareDashboardView;function symDiff(array1,array2){return _.union(_.difference(array1,array2),_.difference(array2,array1))}return ShareDashboardView=ValidatingFormView.extend({className:"shareDashboardView",events:{"click .save":"onSave","click .close":"onClose","click .cancel":"onClose","change .modeSelector":"onChangeSharingMode","change input[name=projectPermission]":"onSelectProjectPermission","click .shareProject":"onClickShareProject"},initialize:function initialize(){if(!permissions.check("edit.dashboard")){throw new Error("You do not have permission to share this Dashboard")}if(!this.model){throw new Error("options.model must be defined")}ValidatingFormView.prototype.initialize.apply(this,arguments);var self=this,initSharedStatus=this.mapSharingSettings();this.shareMode=initSharedStatus.shareMode;this.projectPermission=initSharedStatus.projectPermission;this.viewUserIds=initSharedStatus.viewUserIds;this.analystUserIds=initSharedStatus.analystUserIds;this.clientListView=new ShareClientListView;this.clientListView.on("renderComplete",function(){self.setUserListMaxHeight();self.recreateSelection()});this.clientListView.on("selectionChanged",this.selectionChanged,this)},mapSharingSettings:function mapSharingSettings(){var sharedStatus=this.model.getShared(),lookupObj={none:{shareMode:"none"},view:{shareMode:"project",projectPermission:"view"},analyst:{shareMode:"project",projectPermission:"analyst"},user:{shareMode:"user",viewUserIds:this.model.get("viewUsers"),analystUserIds:this.model.get("analystUsers")}};return lookupObj[sharedStatus]||lookupObj.none},onChangeSharingMode:function onChangeSharingMode(event){var $el=$(event.target);this.setSharingMode($el.val());this.selectionChanged()},setSharingMode:function setSharingMode(mode){var $modeSelectorContainer=this.$(".modeSelectorContainer"),$modeSelector=this.$(".modeSelector"),$modeSettings=this.$(".modeSettings");$modeSelector.val(mode);$modeSelectorContainer.find(".info").addClass("hidden");$modeSelectorContainer.find(".info."+mode).removeClass("hidden");$modeSettings.children().addClass("hidden");$modeSettings.find("."+mode).removeClass("hidden");if(mode==="user"&&!this.isUserListRendered){this.clientListView.render();this.isUserListRendered=true}if(mode==="project"){this.recreateSelection()}this.shareMode=mode},onSelectProjectPermission:function onSelectProjectPermission(event){var $target=$(event.target);this.highlightProjectPermission($target.next());this.selectionChanged()},highlightProjectPermission:function highlightProjectPermission($selection){$selection.siblings("label").removeClass("selected");$selection.addClass("selected")},recreateSelection:function recreateSelection(){if(this.shareMode==="project"){this.highlightProjectPermission(this.$('.modeSettings .project input[id="'+this.projectPermission+'"]').prop("checked",true).next());return}if(this.shareMode==="user"){this.clientListView.setSharedViewUserIds(this.viewUserIds);this.clientListView.setSharedAnalystUserIds(this.analystUserIds)}},getShareSettings:function getShareSettings(){var settings={};if(this.shareMode==="none"){settings.sharedWith="none";return settings}if(this.shareMode==="project"){settings.sharedWith=this.$('.modeSettings .project input[name="projectPermission"]:checked').val();return settings}if(this.shareMode==="user"){settings.sharedWith="user";settings.viewUsers=this.clientListView.getSharedViewUsers();settings.analystUsers=this.clientListView.getSharedAnalystUsers();return settings}},selectionChanged:function selectionChanged(){var viewSettings=this.getShareSettings(),modelShared=this.model.get("sharedWith"),modelViewUsers=this.model.get("viewUsers"),modelAnalystUsers=this.model.get("analystUsers");if(modelShared===viewSettings.sharedWith&&modelShared!=="user"){this.$(".save").prop("disabled",true);return}if(modelShared==="user"&&viewSettings.sharedWith==="user"&&!symDiff(modelViewUsers,viewSettings.viewUsers).length&&!symDiff(modelAnalystUsers,viewSettings.analystUsers).length){this.$(".save").prop("disabled",true);return}this.$(".save").prop("disabled",false)},showOverlay:function showOverlay(isLoading){this.$(".overlay").removeClass("hidden");if(isLoading){this.$(".loading-small").removeClass("hidden")}},hideOverlay:function hideOverlay(){this.$(".overlay").addClass("hidden");this.$(".loading-small").addClass("hidden")},onClickShareProject:function onClickShareProject(){var self=this,view;view=ProjectAccessPermissionView.show({project:currentProject,modalOpts:{top:100}});view.on("confirmed",function(){self.clientListView.refreshUserList()},this)},onSave:function onSave(e){e.preventDefault();this.saveShareSettings(this.getShareSettings())},warnOfUnsharedGroups:function warnOfUnsharedGroups(cb){var groups=this.model.getGroups(),privateLocationGroups=locationGroups.getPrivateGroups(groups.locationGroups),privateSiteGroups=siteGroups.getPrivateGroups(groups.siteGroups),privateAuthorGroups=authorGroups.getPrivateGroups(groups.authorGroups);if(!privateLocationGroups.length&&!privateSiteGroups.length&&!privateAuthorGroups.length){cb(true);return}var text="<p>This Dashboard uses following private Lists:</p><br/>";function getNames(groups){var veryLong=_.isArray(groups)&&groups.length>10,names=_(groups).chain().first(10).map(function(g){return g.get("name")}).value().join(", ");if(veryLong){names+=", ..."}return names}if(privateLocationGroups.length){text+="<p><strong>Location Lists: </strong>"+getNames(privateLocationGroups)+"</p>"}if(privateSiteGroups.length){text+="<p><strong>Site Lists: </strong>"+getNames(privateSiteGroups)+"</p>"}if(privateAuthorGroups.length){text+="<p><strong>Author Lists: </strong>"+getNames(privateAuthorGroups)+"</p>"}text+="<br/><p>These Lists will not be visible to others."+" Do you want to share these Lists to be visible to others before sharing the Dashboard?</p>";$.confirm({title:"Share unshared Lists?",text:text,escape:false},function(confirm){if(confirm){_([].concat(privateLocationGroups,privateSiteGroups,privateAuthorGroups)).each(function(group){group.save({name:group.get("name"),locations:group.get("locations"),shared:"readonly"})})}cb(confirm)})},saveShareSettings:function saveShareSettings(settings){var self=this,settingsForSync=settings,isNew=this.model.isNew();if(settingsForSync.viewUsers){settingsForSync.viewUsers=_(settingsForSync.viewUsers).pluck("id")}if(settingsForSync.analystUsers){settingsForSync.analystUsers=_(settingsForSync.analystUsers).pluck("id")}this.warnOfUnsharedGroups(function(continueSaving){if(!continueSaving){return}settingsForSync.lastModified=(new Date).getTime();if(settingsForSync.sharedWith!=="user"){self.model.set({viewUsers:[],analystUsers:[]},{silent:true})}self.showOverlay(true);self.model.fetch({success:function success(){self.model.save(settingsForSync,{wait:true,success:function success(model,response){self.model.trigger("shareSettingsChanged",{model:self.model,settings:settings,users:self.clientListView.users});var trackData=_.pick(response,["dashboardType","projectId","analystUsers","viewUsers","sharedWith"]);dashboardEvents.trigger(globalEventNames.DASHBOARDS.DASHBOARD_SHARED,_.extend(trackData,{dashboardId:self.model.id}));self.remove();if(isNew){return app.navigateToDashboard(self.model.get("projectId"),self.model.id,self.model.currentTabId,{trigger:false})}},error:function error(model,response){self.hideOverlay();self.onServerError(model,response);self.setUserListMaxHeight()}})},error:function error(model,response){self.hideOverlay();self.onServerError(model,response);self.setUserListMaxHeight()}})})},onClose:function onClose(){this.remove()},render:function render(){var data={title:"Dashboard Sharing Settings",dashboardTitle:this.model.get("name"),projectName:currentProject.get("name"),canEditUsers:permissions.check("edit.client.users")};this.$el.html(shareDashboard(data));this.$(".modeSettings .user").prepend(this.clientListView.el);this.setSharingMode(this.shareMode)},remove:function remove(){this.$el.removeModal();this.clientListView.off("renderComplete");this.clientListView.off("selectionChanged");this.clientListView.remove();this.trigger("closed");ValidatingFormView.prototype.remove.call(this)},setUserListMaxHeight:function setUserListMaxHeight(){var maxHeight=this.getMaxHeight();var $userList=this.$(".user .listBody");var offsetTop=$userList.position().top;var offsetBottom=this.$("footer").outerHeight()+$userList.next().outerHeight();var userListMaxHeight=maxHeight-offsetTop-offsetBottom-36;$userList.css("max-height",userListMaxHeight)},getMaxHeight:function getMaxHeight(){var winHeight=$(window).height(),$modalContainer=this.$el.parent(),position=$modalContainer.position()||{},padding=parseInt(position.top,10)||0;return Math.round(winHeight-padding*2)}},{show:function show(options){var view=new ShareDashboardView(options);view.$el.showModal({className:"shareDashboardModal popup widepopup",fitToWindow:false,top:45,left:"center",keepCentered:false,draggable:".draggable",maxWidth:750,onClose:function onClose(){view.remove()}});view.render();return view}})});define("mustache!templates/globalInputs",["lib/mustache"],function(mustache){var escapedTemplate='<form class="controls">\n<div>\n</div>\n</form>\n';return function(data,partials,wrap){return mustache.render(escapedTemplate,data,partials,wrap)}});define("src/views/GlobalInputsView",["backbone","underscore","jquery","src/events/dashboardEvents","src/events/globalEventNames","src/globals/currentDashboard","src/models/Controls","mustache!templates/globalInputs","jquery.showRelativeTo"],function(Backbone,_,$,dashboardEvents,globalEventNames,currentDashboard,Controls,template){"use strict";var DASHBOARD_EVENT_NAMES=globalEventNames.DASHBOARDS;return Backbone.View.extend({constructor:function GlobalInputsView(options){this.tabWideIsEnabled=!!options.tabWideIsEnabled;Backbone.View.apply(this,arguments)},className:"globalControls popupframe doublepadding",template:template,events:function events(){return{"click .applyChanges":"onApplyChanges","click .close":"onClose"}},initialize:function initialize(options){if(!options||!options.model){throw new Error("options.model must be set!")}if(options.title){this.title=options.title}if(options.subtitle){this.subtitle=options.subtitle}this.dashboard=options.dashboard=options.model;this.model=this.getControlsModel();this.setupInputViews(options)},getControlsModel:function getControlsModel(){return new Controls(this.dashboard.get("settings"),{supportsQueryGroups:true,timezone:currentDashboard.getTimezone()})},remove:function remove(){this.model.unbind("change",this.changesApplied,this);Backbone.View.prototype.remove.call(this);this.trigger("remove")},render:function render(){var $this=this.$el;$this.html(this.template(this.getTemplateData()));this.model.on("change",this.changesApplied,this)},getTemplateData:function getTemplateData(){return{title:this.title,subtitle:this.subtitle}},setupInputViews:function setupInputViews(){throw new Error("setupInputViews method should be overridden!")},getSettings:function getSettings(){throw new Error("getSettings method should be overridden!")},getAnalyticsData:function getAnalyticsData(){return{}},onApplyChanges:function onApplyChanges(e){e.preventDefault();if(this.model.set(this.getSettings(),{validate:true})){var eventData=Object.assign({tabLevel:this.tabWideIsEnabled},this.getAnalyticsData());dashboardEvents.trigger(DASHBOARD_EVENT_NAMES.GLOBAL_SETTINGS_APPLIED,eventData);this.remove()}},onChangesMade:function onChangesMade(){this.toggleHighlightApplyChanges("on")},changesApplied:function changesApplied(e){this.toggleHighlightApplyChanges("off");this.updateDashboard(e)},toggleHighlightApplyChanges:function toggleHighlightApplyChanges(state){var applyButtons=this.$(".applyChanges:not(.ignoreHighlight)");if(state==="on"){applyButtons.addClass("highlighted")}else{applyButtons.removeClass("highlighted")}},updateDashboard:function updateDashboard(settings){var attrs=settings.changedAttributes();if(attrs.queryId){attrs.currentMode="query"}else if(attrs.queryGroupId){attrs.currentMode="queryGroup"}this.dashboard.updateGlobalControls(attrs)},onClose:function onClose(e){e.preventDefault();this.remove()}},{show:function show(options){if(!options||!options.GlobalInputsViewClass){throw new Error("options.GlobalInputsViewClass must be set!")}if(this.existingControls){this.existingControls.remove();delete this.existingControls}var self=this,view=this.existingControls=new options.GlobalInputsViewClass(options),remove=view.remove;view.$el.showRelativeTo({target:options.target,container:options.container||"body",zIndex:20,removeOnScroll:false});view.render();view.remove=function(){view.$el.removeRelativeTo();$("body").off("click.globalControls");remove.call(this);delete self.existingControls};_.defer(function(){$("body").on("click.globalControls",function(event){var $target=$(event.target);if($.mask.isLoaded()&&!$target.closest(".dashboardToolbar").length){return}if($target.closest(".globalControls").length||!$target.closest(document.documentElement).length){return}view.remove()})});return view}})});define("src/models/GlobalDateInputsControls",["src/models/Controls"],function(Controls){"use strict";return Controls.extend({supportsQueryGroups:true,dataSpec:function dataSpec(){var dataSpec=Controls.prototype.dataSpec.apply(this,arguments);delete dataSpec.queryId;return dataSpec}})});define("mustache!templates/globalDateInputs",["lib/mustache"],function(mustache){var escapedTemplate='{{#title}}\n<h1 class="popuptitletext singlemargin-bottom">{{title}}</h1>\n<a class="tinypopup--close close lightgrey icon-remove singlepadding"></a>\n{{/title}}\n<div class="notifications">\n\t<div class="notification-info bigline bigline notification rounded smallpadding-vertical singlepadding-horizontal relative clearright">\n\t\t<ul class="notification-items notification-items--single-line floatleft">\n\t\t\t<li class="notification-item">\n\t\t\t\t<span class="notification-item__text">Changing the date range here will override the date range of all Components at this level.</span>\n</li>\n</ul>\n<div class="clearleft"></div>\n\t</div>\n</div>\n<form class="controls">\n<div>\n<fieldset class="dateinputs lastInSet">\n</fieldset>\n<p class="apply doublemargin-top">\n<button class="applyChanges defaultbutton">Apply</button>\n<button class="close button singlemargin-left">Cancel</button>\n</p>\n</div>\n</form>\n';return function(data,partials,wrap){return mustache.render(escapedTemplate,data,partials,wrap)}});define("src/views/GlobalDateInputsView",["underscore","src/globals/currentDashboard","src/views/GlobalInputsView","src/models/GlobalDateInputsControls","src/controls/views/ControlsViewDateInputs","mustache!templates/globalDateInputs","jquery.showRelativeTo"],function(_,currentDashboard,GlobalInputsView,GlobalDateInputsControls,ControlsViewDateInputs,template){"use strict";var GlobalDateInputsView=GlobalInputsView.extend({template:template,title:"Apply Date to all Components",remove:function remove(){if(this.dateInputs){this.dateInputs.off("changesMade",this.onChangesMade,this);this.dateInputs.remove();delete this.dateInputs}GlobalInputsView.prototype.remove.apply(this,arguments)},render:function render(){GlobalInputsView.prototype.render.apply(this,arguments);this.$(".dateinputs").prepend(this.dateInputs.el);this.dateInputs.render()},getControlsModel:function getControlsModel(){return new GlobalDateInputsControls(this.dashboard.get("settings"),{timezone:currentDashboard.getTimezone()})},getAnalyticsData:function getAnalyticsData(){return{changesApplied:"date range",modifiedDateRange:this.model.get("dateRange")}},setupInputViews:function setupInputViews(){this.dateInputs=new ControlsViewDateInputs({model:this.model,timezone:this.dashboard.getTimezone(),dashboard:this.dashboard})},getSettings:function getSettings(){return _.extend({lastUpdated:(new Date).getTime()},this.dateInputs.getValues())},updateDashboard:function updateDashboard(settings){var attrs=settings.changedAttributes();this.dashboard.updateGlobalControls(attrs)}},{show:function show(options){options=options||{};options.GlobalInputsViewClass=GlobalDateInputsView;return GlobalInputsView.show(options)}});return GlobalDateInputsView});define("mustache!src/controls/templates/queryGroupInputs",["lib/mustache"],function(mustache){var escapedTemplate='{{#showLabel}}\n<label class="db smallpadding-bottom">{{labelText}}</label>\n{{/showLabel}}\n{{#showHelpKey}}\n<a class="help icon-bwhelp singlemargin-right" data-key="{{helpKey}}" tabindex="-1"></a>\n{{/showHelpKey}}\n<select class="queryGroup selectfield" name="queryGroupId" {{#canSelectMultiple}}multiple{{/canSelectMultiple}}>\n{{^canSelectMultiple}}\n<option value="">Select Group</option>\n{{/canSelectMultiple}}\n{{#queryGroups}}\n<option value="{{id}}" {{selected}}>{{name}}</option>\n{{/queryGroups}}\n</select>\n{{^canSelectMultiple}}\n<a class="editQueryGroup icon-pencil grey customtip smallpadding-left" tabindex="-1" title="Edit Group"></a>\n{{/canSelectMultiple}}\n';return function(data,partials,wrap){return mustache.render(escapedTemplate,data,partials,wrap)}});define("src/controls/views/QueryGroupInputs",["backbone","underscore","jquery","selleckt","src/controls/controlsEvents","mustache!src/controls/templates/queryGroupInputs","text!src/controls/templates/queryselection/querySelectorItem.template","text!src/controls/templates/queryselection/querySelectorItemsPopup.template","text!src/controls/templates/queryselection/querySelectorMain.template","text!src/controls/templates/queryselection/querySelectorSelection.template","customtip","css!src/controls/css/sellecktPopup.css"],function(Backbone,_,$,selleckt,controlsEvents,queryGroupInputsTemplate,querySelectorItemTemplate,querySelectorItemsPopupTemplate,querySelectorMainTemplate,querySelectorSelectionTemplate){"use strict";function getSelleckt(view){return view.selleckt}return Backbone.View.extend({className:"queryGroupInputs inputWrapper relative",events:function events(){return{"click a.editQueryGroup":"onEditQueryGroup","click .js-edit":"onClickMultiSellecktEditGroup"}},constructor:function QueryGroupInputs(options){Backbone.View.apply(this,arguments);if(!options||!options.queryGroups){throw new TypeError("options.queryGroups must be defined")}this.queryGroups=options.queryGroups;this.helpKey=options.helpKey;this.labelText=options.labelText||"Select Group";this.canSelectMultiple=!!options.canSelectMultiple;this.showHelpKey="showHelpKey"in options?options.showHelpKey:true;this.isEnabled="isEnabled"in options?options.isEnabled:true;this.showLabel="showLabel"in options?options.showLabel:true;this.listenTo(this.model,"change",this.updateValues);this.listenTo(this.model,"invalid",this.showErrors);this.listenTo(this.queryGroups,"add remove change:name reset",this.render);this.listenTo(this.queryGroups,"add",this.onQueryGroupAdded)},remove:function remove(){var selleckt=getSelleckt(this);if(selleckt){selleckt.destroy()}Backbone.View.prototype.remove.call(this)},onEditQueryGroup:function onEditQueryGroup(e){e.preventDefault();var queryGroupId=this.$("[name=queryGroupId]").val(),queryGroup=this.queryGroups.get(queryGroupId);if(queryGroup){controlsEvents.trigger("editQueryGroup",queryGroup)}},onClickMultiSellecktEditGroup:function onClickMultiSellecktEditGroup(e){var queryGroupId=$(e.currentTarget).closest(".selectionItem").data("value"),queryGroup=this.queryGroups.get(queryGroupId);controlsEvents.trigger("editQueryGroup",queryGroup)},onQueryGroupAdded:function onQueryGroupAdded(model){this.$("[name=queryGroupId]").val(model.id)},onCreateQueryGroup:function onCreateQueryGroup(e){e.preventDefault();this.stopListening(this.queryGroups,"add",this.onQueryGroupAdded);this.listenToOnce(this.queryGroups,"add",this.onQueryGroupAdded);controlsEvents.trigger("createQueryGroup",this.queryGroups)},updateValues:function updateValues(){var queryGroupId=this.model.get("queryGroupId")||"",$queryGroupId=this.$("[name=queryGroupId]");this.$(".invalid").removeClass("invalid");if($queryGroupId.val()!==queryGroupId.toString()){$queryGroupId.val(queryGroupId).change()}},showErrors:function showErrors(model,errors){if(!_.isArray(errors)){return}if(errors.indexOf("queryGroupId")>-1){this.$("[name=queryGroupId]").addClass("invalid");getSelleckt(this).$sellecktEl.addClass("invalid")}},render:function render(){if(!this.isEnabled){this.$el.empty();return}var queryGroupIds=this.$("[name=queryGroupId]").val()||this.model.get("queryGroupId")||this.model.get("groupID");var selectedQueryGroupIds=_([].concat(queryGroupIds)).map(function(id){return parseInt(id,10)}),data={queryGroups:_(this.queryGroups.toJSON()).map(function(group){return{id:group.id,name:group.name,selected:selectedQueryGroupIds.indexOf(group.id)>-1?"selected":""}}),canSelectMultiple:this.canSelectMultiple,showLabel:this.showLabel,labelText:this.labelText,helpKey:this.helpKey||"filters-query-group",showHelpKey:this.showHelpKey};var onCreateQueryGroup=_.bind(this.onCreateQueryGroup,this);this.$el.html(queryGroupInputsTemplate(data));this.$el.customtip();this.initEditQueryGroupLink();if(this.selleckt){this.selleckt.destroy()}this.selleckt=selleckt.create({$selectEl:this.$("select"),className:"selleckt modular dib fullwidth",multiple:this.canSelectMultiple,enableSearch:true,placeholderText:"Select Group",mainTemplate:querySelectorMainTemplate,selectionTemplate:querySelectorSelectionTemplate,itemTemplate:querySelectorItemTemplate,popupTemplate:querySelectorItemsPopupTemplate,popupTemplateData:{footer:this.canSelectMultiple?"":'<a class="newQueryGroup"><span class="iconsmaller icon-plus smallpadding-right" />New Query Group</a>'}});this.selleckt.render();this.selleckt.on("onPopupCreated",function(popup){var $popupEl=popup.$popup;$popupEl.on("click",".newQueryGroup",onCreateQueryGroup)})},initEditQueryGroupLink:function initEditQueryGroupLink(){var self=this,editLink=self.$("a.editQueryGroup"),toggleEditLink=function toggleEditLink(){editLink.toggleClass("enabled",!!$(this).val())};if(this.queryGroupSelector){this.queryGroupSelector.off()}this.queryGroupSelector=this.$("[name=queryGroupId]");this.queryGroupSelector.change(toggleEditLink);toggleEditLink.call(this.queryGroupSelector)},getValues:function getValues(){if(!this.isEnabled){return{queryGroupId:this.model.get("queryGroupId")}}var queryGroups=_.map([].concat(this.$("[name=queryGroupId]").val()||[]),function(id){return parseInt(id,10)});return{queryGroupId:this.canSelectMultiple?queryGroups:queryGroups[0]||""}}})});define("mustache!templates/globalQueryInputs",["lib/mustache"],function(mustache){var escapedTemplate='<div class="globalControls doublepadding">\n{{#title}}\n<h1 class="popuptitletext singlemargin-bottom threecolmax">{{title}}</h1>\n<a class="tinypopup--close close lightgrey icon-remove singlepadding"></a>\n{{/title}}\n<form class="controls">\n<nav class="singlemargin-top">\n<div class="groupTabs horizontal-navigation">\n<a class="js-data-tab singlepadding-horizontal horizontal-navigation--item navbuttonshade dib">Data</a>\n<a class="js-group-tab singlepadding-horizontal horizontal-navigation--item navbuttonshade dib">Group</a>\n</div>\n</nav>\n<div>\n<fieldset class="queryinputs lastInSet">\n</fieldset>\n<p class="apply doublemargin-top">\n<button class="applyChanges defaultbutton">Apply</button>\n<button class="close button singlemargin-left">Cancel</button>\n</p>\n</div>\n</form>\n</div>';return function(data,partials,wrap){return mustache.render(escapedTemplate,data,partials,wrap)}});function _defineProperty(obj,key,value){if(key in obj){Object.defineProperty(obj,key,{value:value,enumerable:true,configurable:true,writable:true})}else{obj[key]=value}return obj}define("src/views/GlobalQueryInputsView",["underscore","src/permissions","src/globals/queries","src/globals/queryGroups","src/views/GlobalInputsView","src/controls/views/ControlsViewQueryInputs","src/controls/views/QueryGroupInputs","mustache!templates/globalQueryInputs","css!css/groupTabs.css"],function(_,permissions,queries,queryGroups,GlobalInputsView,ControlsViewQueryInputs,QueryGroupInputs,template){"use strict";var GlobalQueryInputsView;var VIEW_SELECTORS={DATA_TAB:".js-data-tab",GROUP_TAB:".js-group-tab"};var DATA_SOURCE_MODES={DATA:"data",GROUP:"group"};var CSS_CLASSES={ACTIVE:"active",HIDDEN:"hidden"};function showDataTab(view){view._dataSourceMode=DATA_SOURCE_MODES.DATA;view.model.set({currentMode:"query"},{silent:true});view.$(VIEW_SELECTORS.GROUP_TAB).removeClass(CSS_CLASSES.ACTIVE);if(view.queryGroupInputs){view.queryGroupInputs.$el.addClass(CSS_CLASSES.HIDDEN)}view.$(VIEW_SELECTORS.DATA_TAB).addClass(CSS_CLASSES.ACTIVE);if(view.queryInputs){view.queryInputs.$el.removeClass(CSS_CLASSES.HIDDEN)}}function showGroupTab(view){view._dataSourceMode=DATA_SOURCE_MODES.GROUP;view.model.set({currentMode:"queryGroup"},{silent:true});view.$(VIEW_SELECTORS.DATA_TAB).removeClass(CSS_CLASSES.ACTIVE);if(view.queryInputs){view.queryInputs.$el.addClass(CSS_CLASSES.HIDDEN)}view.$(VIEW_SELECTORS.GROUP_TAB).addClass(CSS_CLASSES.ACTIVE);if(view.queryGroupInputs){view.queryGroupInputs.$el.removeClass(CSS_CLASSES.HIDDEN)}}function getSettingsInDataMode(view,attrs){var queryIdValues=view.queryInputs.getValues();var queryId=queryIdValues.queryId;var modelQueryId=view.model.get("queryId");if(queryIdValues.queryId===modelQueryId){return attrs}if(modelQueryId&&Array.isArray(queryId)){modelQueryId=[].concat(modelQueryId);if(queryId.length===modelQueryId.length&&queryId.length===_.intersection(queryId,modelQueryId).length){return attrs}}return Object.assign({},attrs,queryIdValues)}function getSettingsInGroupMode(view,attrs){var queryGroupIdValues=view.queryGroupInputs.getValues();if(queryGroupIdValues.queryGroupId===view.model.get("queryGroupId")){return attrs}return Object.assign({},attrs,queryGroupIdValues)}return GlobalQueryInputsView=GlobalInputsView.extend({template:template,title:"Apply Data Source to all Components",className:"popupframe",events:function events(){var _Object$assign;return Object.assign((_Object$assign={},_defineProperty(_Object$assign,"click ".concat(VIEW_SELECTORS.DATA_TAB),showDataTab.bind(null,this)),_defineProperty(_Object$assign,"click ".concat(VIEW_SELECTORS.GROUP_TAB),showGroupTab.bind(null,this)),_Object$assign),GlobalInputsView.prototype.events.call())},remove:function remove(){if(this.queryInputs){this.queryInputs.off("changesMade",this.onChangesMade,this);this.queryInputs.remove();delete this.queryInputs}if(this.queryGroupInputs){this.queryGroupInputs.off("changesMade",this.onChangesMade,this);this.queryGroupInputs.remove();delete this.queryGroupInputs}GlobalInputsView.prototype.remove.apply(this,arguments)},render:function render(){GlobalInputsView.prototype.render.apply(this,arguments);this.$(".queryinputs").append(this.queryInputs.el);this.queryInputs.render();this.$(".queryinputs").append(this.queryGroupInputs.el);this.queryGroupInputs.render();showDataTab(this)},getAnalyticsData:function getAnalyticsData(){return{changesApplied:"data source",dataSourceType:this.model.get("currentMode")}},setupInputViews:function setupInputViews(){var viewOptions={model:this.model,dashboard:this.dashboard};this.queryInputs=new ControlsViewQueryInputs(Object.assign({},viewOptions,{allowMultipleSelection:true,canEditQueries:permissions.check("edit.queries"),queries:queries,inputLabel:"Select Data Source",helpKey:"filters-query-name-global"}));this.queryInputs.on("changesMade",this.onChangesMade,this);this.queryGroupInputs=new QueryGroupInputs(Object.assign({},viewOptions,{queryGroups:queryGroups,labelText:"Select Query Group",helpKey:"filters-query-group-global"}));this.queryGroupInputs.on("changesMade",this.onChangesMade,this)},getSettings:function getSettings(){var attrs={lastUpdated:(new Date).getTime()};if(this._dataSourceMode===DATA_SOURCE_MODES.DATA){return getSettingsInDataMode(this,attrs)}if(this._dataSourceMode===DATA_SOURCE_MODES.GROUP){return getSettingsInGroupMode(this,attrs)}return attrs}},{show:function show(options){options=options||{};options.GlobalInputsViewClass=GlobalQueryInputsView;return GlobalInputsView.show(options)}})});define("src/models/GlobalFiltersControls",["src/models/Controls"],function(Controls){"use strict";return Controls.extend({supportsQueryGroups:true,dataSpec:function dataSpec(){var dataSpec=Controls.prototype.dataSpec.apply(this,arguments);delete dataSpec.queryId;return dataSpec}})});define("mustache!templates/globalFilterInputs",["lib/mustache"],function(mustache){var escapedTemplate='{{#title}}\n<h1 class="popuptitletext doublemargin-bottom singlemargin-right">{{title}}</h1>\n<a class="tinypopup--close close lightgrey icon-remove singlepadding"></a>\n{{/title}}\n{{#hasActionsContextMenu}}\n<div class="global-filters--subheader">\n<h2 class="global-filters--subheader__title">{{subtitle}}</h2>\n<div class="global-filters--subheader__more">\n<a class="js-filter-actions global-filters--subheader__filter-actions">More Actions<span class="smallmargin-left icon-chevron-down"></span></a>\n</div>\n</div>\n{{/hasActionsContextMenu}}\n<form class="controls clearboth">\n<div>\n<div class="filters singlepadding-top">\n<p></p>\n</div>\n<p class="apply doublemargin-top">\n<button class="applyChanges floatleft defaultbutton">Apply</button>\n<button class="close floatleft button singlemargin-left">Cancel</button>\n{{#canClearFilters}}\n<a class="clearFilters db floatright hugeline">{{clearFiltersButtonLabel}}</a>\n{{/canClearFilters}}\n</p>\n</div>\n</form>\n';return function(data,partials,wrap){return mustache.render(escapedTemplate,data,partials,wrap)}});function _objectWithoutProperties(source,excluded){if(source==null)return{};var target=_objectWithoutPropertiesLoose(source,excluded);var key,i;if(Object.getOwnPropertySymbols){var sourceSymbolKeys=Object.getOwnPropertySymbols(source);for(i=0;i<sourceSymbolKeys.length;i++){key=sourceSymbolKeys[i];if(excluded.indexOf(key)>=0)continue;if(!Object.prototype.propertyIsEnumerable.call(source,key))continue;target[key]=source[key]}}return target}function _objectWithoutPropertiesLoose(source,excluded){if(source==null)return{};var target={};var sourceKeys=Object.keys(source);var key,i;for(i=0;i<sourceKeys.length;i++){key=sourceKeys[i];if(excluded.indexOf(key)>=0)continue;target[key]=source[key]}return target}function _objectSpread(target){for(var i=1;i<arguments.length;i++){var source=arguments[i]!=null?arguments[i]:{};var ownKeys=Object.keys(source);if(typeof Object.getOwnPropertySymbols==="function"){ownKeys=ownKeys.concat(Object.getOwnPropertySymbols(source).filter(function(sym){return Object.getOwnPropertyDescriptor(source,sym).enumerable}))}ownKeys.forEach(function(key){_defineProperty(target,key,source[key])})}return target}function _defineProperty(obj,key,value){if(key in obj){Object.defineProperty(obj,key,{value:value,enumerable:true,configurable:true,writable:true})}else{obj[key]=value}return obj}define("src/views/GlobalFilterInputsView",["underscore","q","jquery","src/permissions","src/globals/currentDashboard","src/globals/categories","src/globals/metrics","src/globals/siteGroups","src/globals/languages","src/globals/locationGroups","src/globals/authorGroups","src/globals/tags","src/globals/workflow","src/globals/me","src/globals/professions","src/globals/interests","src/globals/currentProject","src/globals/flags","src/globals/flagNames","src/globals/classifications","src/models/GlobalFiltersControls","src/models/LogoQueryCollection","src/views/GlobalInputsView","src/views/FilterActionsContextMenu","src/controls/filters/SentimentFilters","src/controls/filters/SentimentAndEmotionsFilters","src/controls/filters/PageAndMentionTypeFilters","src/controls/filters/ForumThreadFilters","src/controls/filters/BlogFilters","src/controls/filters/TwitterFilters","src/controls/filters/InstagramFilters","src/controls/filters/AuthorFilters","src/controls/filters/LanguageFilters","src/controls/filters/LocationFilters","src/views/filters/WorkflowFilters","src/controls/filters/CategoryFilters","src/controls/filters/TagFilters","src/controls/filters/SiteFilters","src/controls/filters/LogoVersionsFilters","src/controls/filters/ReachFilters","src/controls/filters/FacebookFilters","bw-fe-helpers/validationHelpers","mustache!templates/globalFilterInputs","jquery.showRelativeTo","src/packages/modalDialogs","lib/jquery.notify"],function(_,Q,$,permissions,currentDashboard,categories,globalMetrics,globalSiteGroups,globalLanguages,globalLocationGroups,globalAuthorGroups,globalTags,globalWorkflow,globalMe,professions,interests,currentProject,flags,FLAGS,globalClassifications,GlobalFiltersControls,LogoQueryCollection,GlobalInputsView,FilterActionsContextMenu,SentimentFilters,SentimentAndEmotionsFilters,PageAndMentionTypeFilters,ForumThreadFilters,BlogFilters,TwitterFilters,InstagramFilters,AuthorFilters,LanguageFilters,LocationFilters,WorkflowFilters,CategoryFilters,TagFilters,SiteFilters,LogoVersionsFilters,ReachFilters,FacebookFilters,validationHelpers,template){"use strict";var QUICK_NOTIFICATION_DURATION=2e3;var GlobalFilterInputsView=GlobalInputsView.extend({template:template,title:"Apply Filters",subtitle:"Dashboard Filters",events:function events(){return _objectSpread({},GlobalInputsView.prototype.events.call(this),{"click .js-filter-actions":"onClickFilterActions","click .clearFilters":"clearFilters"})},constructor:function GlobalFilterInputsView(options){if(options.tabWideIsEnabled){this.helpPopupApplyButton="tab-filters";this.clearFiltersButtonLabel="Clear Filters"}else{this.helpPopupApplyButton="global-filters";this.clearFiltersButtonLabel="Clear all Filters"}if(options.ownerId){this.ownerId=options.ownerId}GlobalInputsView.apply(this,arguments);this.canClearFilters=permissions.check("see.dashboard.controls.clearFilters",this.dashboard)},remove:function remove(){var self=this;if(this.filterActionContextMenu){this.filterActionContextMenu.remove();this.filterActionContextMenu=undefined}if(this.filters){this.filters.forEach(function(filter){filter.unbind("changesMade",self.onChangesMade,this);filter.remove()});delete this.filters}GlobalInputsView.prototype.remove.apply(this,arguments)},render:function render(){var _this=this;var self=this;GlobalInputsView.prototype.render.apply(this,arguments);return this.filtersReadyPromise.then(function(){_this.filters.forEach(function(filter){self.$(".filters").append(filter.el);filter.bind("changesMade",self.onChangesMade,self);filter.render()})})},getTemplateData:function getTemplateData(){return _objectSpread({},GlobalInputsView.prototype.getTemplateData.apply(this,arguments),{hasActionsContextMenu:true,canClearFilters:this.canClearFilters,clearFiltersButtonLabel:this.clearFiltersButtonLabel,helpPopupApplyButton:this.helpPopupApplyButton})},getControlsModel:function getControlsModel(){return new GlobalFiltersControls(this.dashboard.get("settings"),{timezone:currentDashboard.getTimezone()})},onClickFilterActions:function onClickFilterActions(){var _this2=this;var _this$getSettings=this.getSettings(),lastUpdated=_this$getSettings.lastUpdated,settings=_objectWithoutProperties(_this$getSettings,["lastUpdated"]);Object.keys(settings).forEach(function(key){if(validationHelpers.isNullOrEmpty(settings[key])){delete settings[key]}});this.filterActionContextMenu=FilterActionsContextMenu.show({$target:this.$(".js-filter-actions"),currentFilterValues:settings});this.listenToOnce(this.filterActionContextMenu,"copied",this.onFiltersCopied.bind(this));this.listenToOnce(this.filterActionContextMenu,"paste",this.onPasteFilters.bind(this));this.listenToOnce(this.filterActionContextMenu,"clear",this.clearFilters.bind(this));this.listenToOnce(this.filterActionsContextMenu,"remove",function(){_this2.stopListening(_this2.filterActionsContextMenu);_this2.filterActionsContextMenu=undefined})},onFiltersCopied:function onFiltersCopied(){$.notify({text:"Filter settings copied",duration:QUICK_NOTIFICATION_DURATION,className:"notification-info"})},onPasteFilters:function onPasteFilters(filterValues){var emptyFilterSettings=this.filters.map(function(filter){return filter.getValues()}).reduce(function(memo,values){Object.keys(values).forEach(function(key){if(!validationHelpers.isNullOrEmpty(values[key])){memo[key]=Array.isArray(values[key])?[]:""}});return memo},{});this.model.set(_objectSpread({},emptyFilterSettings,filterValues));this.remove();$.notify({text:"Filter settings pasted",duration:QUICK_NOTIFICATION_DURATION,className:"notification-success"})},getAnalyticsData:function getAnalyticsData(){var filterNamesByFilterGroup=this.filters.map(function(filterView){return filterView.getAppliedFilterNames()});return{changesApplied:"filters",modifiedFilters:_.flatten(filterNamesByFilterGroup)}},setupInputViews:function setupInputViews(){var _this3=this;if(permissions.check("see.dashboard.controls.advancedFilters",this.dashboard)){var viewOptions={model:this.model,dashboard:this.dashboard,userId:globalMe.id,ownerId:this.ownerId,showHelp:permissions.check("see.dashboard.controls.help",this.dashboard)};var sentimentFiltersOptions=Object.assign({},viewOptions,{metrics:globalMetrics});var pageAndMentionTypeFiltersOptions=Object.assign({},viewOptions,{metrics:globalMetrics});var categoryFiltersOptions=Object.assign({},viewOptions,{categories:categories});var siteFilters=Object.assign({},viewOptions,{siteGroups:globalSiteGroups,showHelp:permissions.check("see.dashboard.controls.help",currentDashboard),userId:globalMe.id,canEditGroups:permissions.check("edit.groups",currentDashboard)});var authorFiltersOptions=Object.assign({},viewOptions,{authorGroups:globalAuthorGroups,canEditGroups:permissions.check("edit.groups")});var twitterFiltersOptions=Object.assign({},viewOptions,{professions:professions,interests:interests,locationGroups:globalLocationGroups,userId:globalMe.id,ownerId:this.ownerId});var instagramFiltersOptions=Object.assign({},viewOptions,{hideSubTypeFilter:true});var locationFiltersOptions=Object.assign({},viewOptions,{locationGroups:globalLocationGroups});var tagFiltersOptions=Object.assign({},viewOptions,{tagCollection:globalTags});var workflowFiltersOptions=Object.assign({},viewOptions,{workflow:globalWorkflow});var logoVersionsFiltersOptions=Object.assign({},viewOptions,{collection:new LogoQueryCollection([],{projectId:currentProject.id})});var emotionsFiltersOptions=_.extend({},viewOptions,{emotions:globalClassifications.getEmotionLabels(),metrics:globalMetrics});var facebookFiltersOptions=Object.assign({},viewOptions,{hideSubTypeFilter:true});var deferred=Q.defer();var enableReachMetric=flags.variation(FLAGS.ENABLE_REACH_METRIC);var features=[];if(enableReachMetric){features.push(new ReachFilters(viewOptions))}this.filters=[new CategoryFilters(categoryFiltersOptions),new TagFilters(tagFiltersOptions),new PageAndMentionTypeFilters(pageAndMentionTypeFiltersOptions),flags.variation(FLAGS.ENABLE_EMOTIONS)?new SentimentAndEmotionsFilters(emotionsFiltersOptions):new SentimentFilters(sentimentFiltersOptions),new AuthorFilters(authorFiltersOptions),new LocationFilters(locationFiltersOptions),new WorkflowFilters(workflowFiltersOptions),new SiteFilters(siteFilters),new TwitterFilters(twitterFiltersOptions),new FacebookFilters(facebookFiltersOptions),new InstagramFilters(instagramFiltersOptions),new ForumThreadFilters(viewOptions),new BlogFilters(viewOptions),new LogoVersionsFilters(logoVersionsFiltersOptions)].concat(features);globalLanguages.load(function(err,languages){if(err){deferred.reject();return}var languageFiltersOptions=Object.assign({},viewOptions,{languageCollection:languages});_this3.filters.splice(6,0,new LanguageFilters(languageFiltersOptions));deferred.resolve()});this.filtersReadyPromise=deferred.promise}else{this.filters=[];this.filtersReadyPromise=Promise.resolve()}},getSettings:function getSettings(){var filters=this.filters.reduce(function(values,filter){var filterValues=filter.getValues();_.chain(filterValues).keys().each(function(key){if(values[key]){values[key]=[].concat(values[key]).concat(filterValues[key])}else{values[key]=filterValues[key]}});return values},{});return _.extend({lastUpdated:(new Date).getTime()},filters)},clearFilters:function clearFilters(e){e&&e.preventDefault();var settings=this.model;var settingsAsJson=settings.toJSON();var defaultFilterSettings=_.isFunction(settings.defaults)?settings.defaults():settings.defaults;var defaultKeys=_.keys(defaultFilterSettings||{});var filterKeys=_.chain(this.filters).map(function(filter){filter.hideValidationErrors();return filter.getValues()}).reduce(function(memo,values){_.forEach(values,function(value,key){if(defaultKeys.indexOf(key)===-1){memo[key]=""}});return memo},{}).value();var flatFilterKeys=_.chain(filterKeys).keys().flatten().value();var flatNonFilterKeys=_.chain(settingsAsJson).keys().difference(flatFilterKeys).value();var nonFilterSettings=_.defaults(_.pick(settingsAsJson,flatNonFilterKeys),defaultFilterSettings);settings.clear({silent:true});settings.set(nonFilterSettings,{silent:true});settings.set(filterKeys,{unset:true});this.remove()}},{show:function show(options){options=options||{};options.GlobalInputsViewClass=GlobalFilterInputsView;return GlobalInputsView.show(options)}});return GlobalFilterInputsView});define("mustache!templates/globalTimezoneSelectionView",["lib/mustache"],function(mustache){var escapedTemplate='<h1 class="popuptitletext singlemargin-bottom global-timezone-selection-view--title">Apply Time Zone to Dashboard</h1>\n<a class="tinypopup--close close lightgrey icon-remove singlepadding"></a>\n\n<p class="global-timezone-selection-view--description">The data in this Dashboard will be calculated based on this time zone.</p>\n\n<div class="timezone-radio-buttons-container"></div>\n\n<div class="doublemargin-top">\n<button class="applyChanges defaultbutton" disabled>Apply Time Zone</button>\n<button class="close button singlemargin-left">Cancel</button>\n</div>';return function(data,partials,wrap){return mustache.render(escapedTemplate,data,partials,wrap)}});define("css!css/globalTimezoneSelectionView.css",["css!css/compiled.css"],function(){});define("src/views/GlobalTimezoneSelectionView",["src/globals/currentProject","src/events/dashboardEvents","src/events/globalEventNames","src/views/GlobalInputsView","src/views/TimezoneSelectionRadioButtons","bw-fe-helpers/urlHelper","bw-fe-helpers/timezoneDateHelper","mustache!templates/globalTimezoneSelectionView","css!css/globalTimezoneSelectionView.css","jquery.showRelativeTo"],function(currentProject,dashboardEvents,globalEventNames,GlobalInputsView,TimezoneSelectionRadioButtons,urlHelper,timezoneDateHelper,template){"use strict";var GlobalTimezoneSelectionView=GlobalInputsView.extend({template:template,className:[GlobalInputsView.prototype.className,"global-timezone-selection-view"].join(" "),constructor:function GlobalTimezoneSelectionView(){GlobalInputsView.apply(this,arguments)},setupInputViews:function setupInputViews(){var projectTimezone=currentProject.getTimezone();this.timezoneRadioButtons=new TimezoneSelectionRadioButtons({preselectedTimezone:this.dashboard.getTimezone(),defaultTimezone:projectTimezone,defaultTimezoneLabel:"Project default: "+timezoneDateHelper.getTimezoneNameWithOffset(projectTimezone),preferCustomOption:this.dashboard.isProjectsTimezoneOverriden()});this.listenTo(this.timezoneRadioButtons,"selected-timezone-changed",this.onSelectedTimezoneChanged)},remove:function remove(){this.timezoneRadioButtons.remove();GlobalInputsView.prototype.remove.apply(this,arguments)},render:function render(){GlobalInputsView.prototype.render.apply(this,arguments);this.timezoneRadioButtons.render();this.$(".timezone-radio-buttons-container").append(this.timezoneRadioButtons.$el)},onSelectedTimezoneChanged:function onSelectedTimezoneChanged(timezone,isDefault){var preventApplyChanges=false;this._selectedTimezone=isDefault?null:timezone;if(!timezone||!isDefault&&timezone===this.dashboard.get("dashboardTimezone")){preventApplyChanges=true}this.$(".applyChanges").prop("disabled",preventApplyChanges)},onApplyChanges:function onApplyChanges(){var self=this;var eventArgs={oldDashboardTimezone:this.dashboard.get("dashboardTimezone"),source:"dashboard",action:function action(){urlHelper.reloadURL(true);self.remove()}};if(!this._selectedTimezone){this.dashboard.set("dashboardTimezone",null)}else{this.dashboard.set("dashboardTimezone",this._selectedTimezone)}dashboardEvents.trigger(globalEventNames.DASHBOARDS.TIMEZONE_UPDATED,eventArgs);this.remove()}},{show:function show(options){options=options||{};options.GlobalInputsViewClass=GlobalTimezoneSelectionView;return GlobalInputsView.show(options)}});return GlobalTimezoneSelectionView});define("mustache!templates/dashboardSearchInput",["lib/mustache"],function(mustache){var escapedTemplate='<div class="searchInput">\n{{#showHelp}}\n<a class="help smallpadding-top smallmargin-right icon-bwhelp" data-key="{{helpKey}}" ></a>\n{{/showHelp}}\n<span class="searchIcon"></span>\n<div class="editor searchField monospacefont {{^search}}empty{{/search}}">{{search}}</div>\n<input class="search-input" type="hidden" name="search" value="{{search}}">\n<button class="button ignoreHighlight" value="Go" {{^fieldEnabled}}disabled="true"{{/fieldEnabled}}>Go</button>\n</div>\n';return function(data,partials,wrap){return mustache.render(escapedTemplate,data,partials,wrap)}});define("src/views/DashboardSearchInputView",["underscore","jquery","src/views/ControlsViewSearchInput","mustache!templates/dashboardSearchInput"],function(_,$,ControlsViewSearchInput,template){"use strict";return ControlsViewSearchInput.extend({className:"searchBox modular expanded",helpKey:"dashboard-search",getTemplateData:function getTemplateData(data){var templateData=ControlsViewSearchInput.prototype.getTemplateData.call(this,data);var settings=this.model.get("settings")||{};templateData.search=settings.search||"";return templateData},initialize:function initialize(options){options.dashboard=options.model;ControlsViewSearchInput.prototype.initialize.call(this,options)},render:function render(){var data=this.getTemplateData(this.model.toJSON());var $el=this.$el;var editorDiv=this.editorDiv;if(editorDiv){editorDiv.detach()}$el.html(template(data)).customtip();if(editorDiv){this.$(".editor").replaceWith(editorDiv)}else{editorDiv=this.$(".editor")}editorDiv.toggleClass("disabled",!this.fieldEnabled());this.initAceEditor(editorDiv)},handleEditorClick:function handleEditorClick(){this.aceEditor&&this.aceEditor.focus()},initAceEditor:function initAceEditor(editorDiv){if(!this.fieldEnabled()||this.aceEditor){return}editorDiv.acify({autoResize:false,onReady:_.bind(function(opts){this.aceEditor=opts.editor;this.editorDiv=$(opts.editor.container);this.aceEditor.on("focus",_.bind(this.markNotEmpty,this))},this),onBlur:_.bind(this.updateSearchTerm,this)})},markNotEmpty:function markNotEmpty(){this.editorDiv&&this.editorDiv.removeClass("empty")},updateSearchTerm:function updateSearchTerm(){ControlsViewSearchInput.prototype.updateSearchTerm.call(this);var currentValue=this.aceEditor.getValue()||"";if(currentValue.trim().length===0){this.editorDiv.addClass("empty")}else{this.markNotEmpty()}}})});define("src/helpers/categoriesHelper",[],function(){"use strict";function findParentCategory(categories,selected){var category=categories.find(function(cat){return cat.get("children").some(function(child){return selected.indexOf(child.id)>-1})});return category}return{findParentCategory:findParentCategory}});define("src/views/rulestable/helper",["underscore","src/globals/categories","src/helpers/categoriesHelper"],function(_,categories,categoriesHelper){"use strict";function getCategoryRuleText(ruleAction){var categoryIds=[].concat(ruleAction.addCategories),childCategories,parentCategory=categoriesHelper.findParentCategory(categories,categoryIds);if(parentCategory){childCategories=_(parentCategory.get("children")).chain().filter(function(child){return categoryIds.indexOf(child.id)!==-1}).pluck("name").value()}if(!childCategories||!childCategories.length){return""}return"Add "+(childCategories.length===1?'Category "':'Categories "')+childCategories.join('", "')+'"'}function getClassificationsText(classifications,action){var emotionPrefix="emotions:";var label=classifications.length>1?"Emotions":"Emotion";return"".concat(action," ").concat(label," ").concat(classifications.map(function(classification){return'"'.concat(_.capitalize(classification.substring(emotionPrefix.length)),'"')}).join(", "))}function getTagRuleText(ruleAction){var tags=[].concat(ruleAction.addTag),pluralisedLabel=tags.length===1?"tag":"tags",tagsList=tags.join('", "');return"Add "+pluralisedLabel+' "'+tagsList+'"'}function getRuleText(model){var ruleAction=model.get("ruleAction");if(!ruleAction){return""}if(ruleAction.addCategories){return getCategoryRuleText(ruleAction)}if(ruleAction.addTag&&ruleAction.addTag.length){return getTagRuleText(ruleAction)}if(ruleAction.addClassifications){return getClassificationsText(ruleAction.addClassifications,"Add")}if(ruleAction.removeClassifications){return getClassificationsText(ruleAction.removeClassifications,"Remove")}if(ruleAction.sentiment){return"Set "+ruleAction.sentiment+" sentiment"}if(ruleAction.locationName){return'Set Location to "'+ruleAction.locationName+'"'}if(ruleAction.starred){return"Set starred"}if(ruleAction.assignment){return'Set assignee to "'+ruleAction.assignment+'"'}if(ruleAction.priority){return"Set priority to "+ruleAction.priority+""}if(ruleAction.status){return"Set status to "+ruleAction.status+""}if(ruleAction.checked===true){return"Set checked"}if(ruleAction.checked===false){return"Set unchecked"}return""}return{getRuleText:getRuleText}});define("mustache!src/setupstore/templates/dashboardInfoTable",["lib/mustache"],function(mustache){var escapedTemplate='<table class="fullwidth textleft">\n<thead>\n<tr class="rowborder">\n<th class="cellpadding"><span class="columngroupheader">Dashboard Name</span></th>\n<th class="cellpadding"><span class="columngroupheader">Owner</span></th>\n<th class="cellpadding"><span class="columngroupheader">Used Query</span></th>\n</tr>\n</thead>\n<tbody class="grey">\n<tr class="rowborder">\n<td class="cellpadding">{{name}}</td>\n<td class="cellpadding">{{owner}}</td>\n<td class="cellpadding">{{query}}</td>\n</tr>\n</tbody>\n</table>\n';return function(data,partials,wrap){return mustache.render(escapedTemplate,data,partials,wrap)}});define("mustache!src/setupstore/templates/dashboardRulesTable",["lib/mustache"],function(mustache){var escapedTemplate='<table class="fullwidth textleft">\n<thead>\n<tr class="rowborder">\n<th class="cellpadding"><span class="columngroupheader">Rule Name</span></th>\n<th class="cellpadding"><span class="columngroupheader">Action</span></th>\n</tr>\n</thead>\n<tbody class="grey">\n{{#rules}}\n<tr class="rowborder">\n<td class="cellpadding">{{name}}</td>\n<td class="cellpadding">{{action}}</td>\n</tr>\n{{/rules}}\n</tbody>\n</table>\n';return function(data,partials,wrap){return mustache.render(escapedTemplate,data,partials,wrap)}});define("mustache!src/setupstore/templates/dashboardCategoriesTable",["lib/mustache"],function(mustache){var escapedTemplate='<table class="fullwidth textleft">\n<thead>\n<tr class="rowborder">\n<th class="cellpadding"><span class="columngroupheader">Category</span></th>\n<th class="cellpadding"><span class="columngroupheader">Subcategories</span></th>\n</tr>\n</thead>\n<tbody class="grey">\n{{#categories}}\n<tr class="rowborder">\n<td class="cellpadding">{{name}}</td>\n<td class="cellpadding">{{children}}</td>\n</tr>\n{{/categories}}\n</tbody>\n</table>\n';return function(data,partials,wrap){return mustache.render(escapedTemplate,data,partials,wrap)}});define("mustache!src/setupstore/templates/dashboardAuthorListsTable",["lib/mustache"],function(mustache){var escapedTemplate='<table class="fullwidth textleft">\n<thead>\n<tr class="rowborder">\n<th class="cellpadding"><span class="columngroupheader">List Name</span></th>\n<th class="cellpadding"><span class="columngroupheader">Authors</span></th>\n</tr>\n</thead>\n<tbody class="grey">\n{{#authorLists}}\n<tr class="rowborder">\n<td class="cellpadding">{{name}}</td>\n<td class="cellpadding">{{authors}}</td>\n</tr>\n{{/authorLists}}\n</tbody>\n</table>\n';return function(data,partials,wrap){return mustache.render(escapedTemplate,data,partials,wrap)}});define("mustache!src/setupstore/templates/dashboardInfo",["lib/mustache"],function(mustache){var escapedTemplate='<div class="b-dashboardinfo">\n<h1 class="draggable popuptitletext singlemargin-bottom">Rerun Dashboard Wizard</h1>\n<p class="singlemargin-bottom grey">If you want to change your Wizard Dashboard or the items created with it, you can simply rerun the Dashboard Wizard. Please note that this will overwrite items that were previously created by the Dashboard Wizard.</p>\n<p class="singlemargin-bottom grey">Below you can find what has been created by the Dashboard Wizard.</p>\n<div class="lightgreybg singlepadding-horizontal singlepadding-top">\n{{#dashboardTable}}\n<div class="js-section b-dashboardinfo__section singlepadding-bottom">\n<p>\n<b>Dashboard</b> - Set of charts and tables that allow you to analyze the mentions found by your Query.\n<a class="js-toggle-table b-dashboardinfo__toggle"><span class="js-toggle-label">Show</span> Dashboard</a>\n</p>\n<div class="b-dashboardinfo__table singlepadding-horizontal smallpadding-bottom singlemargin-top">{{{dashboardTable}}}</div>\n</div>\n{{/dashboardTable}}\n{{#categoriesTable}}\n<div class="js-section b-dashboardinfo__section singlepadding-bottom">\n<p>\n<b>Categories</b> - A structured way to sort your data by Products, Hashtags & Key People.\n<a class="js-toggle-table b-dashboardinfo__toggle"><span class="js-toggle-label">Show</span> Categories</a>\n</p>\n<div class="b-dashboardinfo__table singlepadding-horizontal smallpadding-bottom singlemargin-top">{{{categoriesTable}}}</div>\n</div>\n{{/categoriesTable}}\n{{#rulesTable}}\n<div class="js-section b-dashboardinfo__section singlepadding-bottom">\n<p>\n<b>Rules</b> - Allow you to automatically perform actions on mentions.\n<a class="js-toggle-table b-dashboardinfo__toggle"><span class="js-toggle-label">Show</span> Rules</a>\n</p>\n<div class="b-dashboardinfo__table singlepadding-horizontal smallpadding-bottom singlemargin-top">{{{rulesTable}}}</div>\n</div>\n{{/rulesTable}}\n{{#authorListsTable}}\n<div class="js-section b-dashboardinfo__section singlepadding-bottom">\n<p>\n<b>Author Lists</b> - A list of Authors that can be used to filter mentions posted by particular people.\n<a class="js-toggle-table b-dashboardinfo__toggle"><span class="js-toggle-label">Show</span> Lists</a>\n</p>\n<div class="b-dashboardinfo__table singlepadding-horizontal smallpadding-bottom singlemargin-top">{{{authorListsTable}}}</div>\n</div>\n{{/authorListsTable}}\n</div>\n<div class="doublemargin-top">\n<button class="js-rerun singlemargin-right button defaultbutton">Rerun Dashboard Wizard</button>\n<button class="js-close singlemargin-right button">Cancel</button>\n</div>\n</div>\n';return function(data,partials,wrap){return mustache.render(escapedTemplate,data,partials,wrap)}});define("css!src/setupstore/css/dashboardinfo.css",["css!src/setupstore/css/compiled.css"],function(){});define("src/setupstore/views/DashboardInfoView",["jquery","underscore","backbone","bw-fe-helpers/promiseHelper","src/mixins/mixin","src/mixins/withPopup","src/helpers/dashboard-wizard/dashboardWizardHelper","src/globals/currentProject","src/globals/me","src/views/rulestable/helper","mustache!src/setupstore/templates/dashboardInfoTable","mustache!src/setupstore/templates/dashboardRulesTable","mustache!src/setupstore/templates/dashboardCategoriesTable","mustache!src/setupstore/templates/dashboardAuthorListsTable","mustache!src/setupstore/templates/dashboardInfo","css!src/setupstore/css/dashboardinfo.css"],function($,_,Backbone,promiseHelper,mixin,withPopup,dashboardWizardHelper,currentProject,me,rulesTableHelper,renderDashboardInfoTable,renderDashboardRulesTable,renderDashboardCategoriesTable,renderDashboardAuthorListsTable,renderDashboardInfo){"use strict";var VIEW_SELECTORS={SECTION:".js-section",LABEL:".js-toggle-label"};var VIEW_LABELS={SHOW:"Show",HIDE:"Hide"};function fetchSetupTemplates(view){view.templatesLoading=true;promiseHelper.ajax({url:"/setupstore-api/setuptemplates"}).then(function(templates){view.templates=templates}).finally(function(){view.templatesLoading=false;view.render()})}function fetchSetupDetails(view){view.setupDetailsLoading=true;promiseHelper.ajax({url:"/setupstore-api/setups/dashboard/"+view.dashboardId}).then(function(setupDetails){view.setupDetails=setupDetails}).finally(function(){view.setupDetailsLoading=false;view.render()})}function getTemplateByType(templateType,templates){return _(templates).findWhere({templateType:templateType})}function getDashboardTable(setupDetails){var owner=setupDetails.createdByUsername;var data={name:setupDetails.dashboardName,owner:owner===me.get("username")?"You":owner,query:setupDetails.queryName};return renderDashboardInfoTable(data)}function getRulesTable(rules){var data=rules.map(function(rule){return{name:rule.name,action:rulesTableHelper.getRuleText(new Backbone.Model(rule))}});return data.length?renderDashboardRulesTable({rules:data}):undefined}function getCategoriesTable(categories){var data=categories.map(function(category){return{name:category.name,children:_(category.children).pluck("name").join(", ")}});return data.length?renderDashboardCategoriesTable({categories:data}):undefined}function getAuthorListsTable(authorLists){var data=authorLists.map(function(list){return{name:list.name,authors:list.authors.join(", ")}});return data.length?renderDashboardAuthorListsTable({authorLists:data}):undefined}function onClickClose(view){view.remove()}function onClickOpenWizard(view){var template=getTemplateByType(view.setupDetails.setupTemplateType,view.templates);if(!template){throw new Error("No template found for template name "+view.setupDetails.setupTemplateType)}dashboardWizardHelper.start({templateId:template.id,templateType:template.templateType,projectId:currentProject.id,setupId:view.setupDetails.id,queryId:view.setupDetails.queryId,source:"Rerun Dialog"},function(){view.remove()})}function onClickToggleTable(view,e){var expandedClass="b-dashboardinfo__section--expanded";var $target=$(e.currentTarget);var $section=$target.closest(VIEW_SELECTORS.SECTION);var $label=$target.children(VIEW_SELECTORS.LABEL);if($section.hasClass(expandedClass)){$section.removeClass(expandedClass);$label.text(VIEW_LABELS.SHOW);return}view.$(VIEW_SELECTORS.SECTION).removeClass(expandedClass);view.$(VIEW_SELECTORS.LABEL).text(VIEW_LABELS.SHOW);$section.addClass(expandedClass);$label.text(VIEW_LABELS.HIDE)}var DashboardInfoView=Backbone.View.extend({events:function events(){return{"click .js-rerun":onClickOpenWizard.bind(null,this),"click .js-close":onClickClose.bind(null,this),"click .js-toggle-table":onClickToggleTable.bind(null,this)}},constructor:function DashboardInfoView(options){if(!options||!options.dashboardId){throw new Error("DashboardInfoView requires options.dashboardId to be set")}this.dashboardId=options.dashboardId;fetchSetupTemplates(this);fetchSetupDetails(this);Backbone.View.apply(this,arguments)},render:function render(){var $el=this.$el;var setupDetails;var data;if(this.templatesLoading||this.setupDetailsLoading){return $el.html("Loading&hellip;")}setupDetails=this.setupDetails;data={dashboardTable:getDashboardTable(setupDetails),rulesTable:getRulesTable(setupDetails.rules),categoriesTable:getCategoriesTable(setupDetails.categories),authorListsTable:getAuthorListsTable(setupDetails.authorLists)};$el.html(renderDashboardInfo(data))}},{show:function show(options){var view=new DashboardInfoView(options);view.render();view.showAsPopup({top:120,className:"popup widepopup"});return view}});mixin(DashboardInfoView,withPopup);return DashboardInfoView});(function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t():"function"==typeof define&&define.amd?define("popper",t):e.Popper=t()})(this,function(){"use strict";function e(e){return e&&"[object Function]"==={}.toString.call(e)}function t(e,t){if(1!==e.nodeType)return[];var o=getComputedStyle(e,null);return t?o[t]:o}function o(e){return"HTML"===e.nodeName?e:e.parentNode||e.host}function n(e){if(!e)return document.body;switch(e.nodeName){case"HTML":case"BODY":return e.ownerDocument.body;case"#document":return e.body}var i=t(e),r=i.overflow,p=i.overflowX,s=i.overflowY;return/(auto|scroll)/.test(r+s+p)?e:n(o(e))}function r(e){var o=e&&e.offsetParent,i=o&&o.nodeName;return i&&"BODY"!==i&&"HTML"!==i?-1!==["TD","TABLE"].indexOf(o.nodeName)&&"static"===t(o,"position")?r(o):o:e?e.ownerDocument.documentElement:document.documentElement}function p(e){var t=e.nodeName;return"BODY"!==t&&("HTML"===t||r(e.firstElementChild)===e)}function s(e){return null===e.parentNode?e:s(e.parentNode)}function d(e,t){if(!e||!e.nodeType||!t||!t.nodeType)return document.documentElement;var o=e.compareDocumentPosition(t)&Node.DOCUMENT_POSITION_FOLLOWING,i=o?e:t,n=o?t:e,a=document.createRange();a.setStart(i,0),a.setEnd(n,0);var l=a.commonAncestorContainer;if(e!==l&&t!==l||i.contains(n))return p(l)?l:r(l);var f=s(e);return f.host?d(f.host,t):d(e,s(t).host)}function a(e){var t=1<arguments.length&&void 0!==arguments[1]?arguments[1]:"top",o="top"===t?"scrollTop":"scrollLeft",i=e.nodeName;if("BODY"===i||"HTML"===i){var n=e.ownerDocument.documentElement,r=e.ownerDocument.scrollingElement||n;return r[o]}return e[o]}function l(e,t){var o=2<arguments.length&&void 0!==arguments[2]&&arguments[2],i=a(t,"top"),n=a(t,"left"),r=o?-1:1;return e.top+=i*r,e.bottom+=i*r,e.left+=n*r,e.right+=n*r,e}function f(e,t){var o="x"===t?"Left":"Top",i="Left"==o?"Right":"Bottom";return parseFloat(e["border"+o+"Width"],10)+parseFloat(e["border"+i+"Width"],10)}function m(e,t,o,i){return J(t["offset"+e],t["scroll"+e],o["client"+e],o["offset"+e],o["scroll"+e],ie()?o["offset"+e]+i["margin"+("Height"===e?"Top":"Left")]+i["margin"+("Height"===e?"Bottom":"Right")]:0)}function h(){var e=document.body,t=document.documentElement,o=ie()&&getComputedStyle(t);return{height:m("Height",e,t,o),width:m("Width",e,t,o)}}function c(e){return se({},e,{right:e.left+e.width,bottom:e.top+e.height})}function g(e){var o={};if(ie())try{o=e.getBoundingClientRect();var i=a(e,"top"),n=a(e,"left");o.top+=i,o.left+=n,o.bottom+=i,o.right+=n}catch(e){}else o=e.getBoundingClientRect();var r={left:o.left,top:o.top,width:o.right-o.left,height:o.bottom-o.top},p="HTML"===e.nodeName?h():{},s=p.width||e.clientWidth||r.right-r.left,d=p.height||e.clientHeight||r.bottom-r.top,l=e.offsetWidth-s,m=e.offsetHeight-d;if(l||m){var g=t(e);l-=f(g,"x"),m-=f(g,"y"),r.width-=l,r.height-=m}return c(r)}function u(e,o){var i=ie(),r="HTML"===o.nodeName,p=g(e),s=g(o),d=n(e),a=t(o),f=parseFloat(a.borderTopWidth,10),m=parseFloat(a.borderLeftWidth,10),h=c({top:p.top-s.top-f,left:p.left-s.left-m,width:p.width,height:p.height});if(h.marginTop=0,h.marginLeft=0,!i&&r){var u=parseFloat(a.marginTop,10),b=parseFloat(a.marginLeft,10);h.top-=f-u,h.bottom-=f-u,h.left-=m-b,h.right-=m-b,h.marginTop=u,h.marginLeft=b}return(i?o.contains(d):o===d&&"BODY"!==d.nodeName)&&(h=l(h,o)),h}function b(e){var t=e.ownerDocument.documentElement,o=u(e,t),i=J(t.clientWidth,window.innerWidth||0),n=J(t.clientHeight,window.innerHeight||0),r=a(t),p=a(t,"left"),s={top:r-o.top+o.marginTop,left:p-o.left+o.marginLeft,width:i,height:n};return c(s)}function w(e){var i=e.nodeName;return"BODY"===i||"HTML"===i?!1:"fixed"===t(e,"position")||w(o(e))}function y(e,t,i,r){var p={top:0,left:0},s=d(e,t);if("viewport"===r)p=b(s);else{var a;"scrollParent"===r?(a=n(o(t)),"BODY"===a.nodeName&&(a=e.ownerDocument.documentElement)):"window"===r?a=e.ownerDocument.documentElement:a=r;var l=u(a,s);if("HTML"===a.nodeName&&!w(s)){var f=h(),m=f.height,c=f.width;p.top+=l.top-l.marginTop,p.bottom=m+l.top,p.left+=l.left-l.marginLeft,p.right=c+l.left}else p=l}return p.left+=i,p.top+=i,p.right-=i,p.bottom-=i,p}function E(e){var t=e.width,o=e.height;return t*o}function v(e,t,o,i,n){var r=5<arguments.length&&void 0!==arguments[5]?arguments[5]:0;if(-1===e.indexOf("auto"))return e;var p=y(o,i,r,n),s={top:{width:p.width,height:t.top-p.top},right:{width:p.right-t.right,height:p.height},bottom:{width:p.width,height:p.bottom-t.bottom},left:{width:t.left-p.left,height:p.height}},d=Object.keys(s).map(function(e){return se({key:e},s[e],{area:E(s[e])})}).sort(function(e,t){return t.area-e.area}),a=d.filter(function(e){var t=e.width,i=e.height;return t>=o.clientWidth&&i>=o.clientHeight}),l=0<a.length?a[0].key:d[0].key,f=e.split("-")[1];return l+(f?"-"+f:"")}function O(e,t,o){var i=d(t,o);return u(o,i)}function L(e){var t=getComputedStyle(e),o=parseFloat(t.marginTop)+parseFloat(t.marginBottom),i=parseFloat(t.marginLeft)+parseFloat(t.marginRight),n={width:e.offsetWidth+i,height:e.offsetHeight+o};return n}function x(e){var t={left:"right",right:"left",bottom:"top",top:"bottom"};return e.replace(/left|right|bottom|top/g,function(e){return t[e]})}function S(e,t,o){o=o.split("-")[0];var i=L(e),n={width:i.width,height:i.height},r=-1!==["right","left"].indexOf(o),p=r?"top":"left",s=r?"left":"top",d=r?"height":"width",a=r?"width":"height";return n[p]=t[p]+t[d]/2-i[d]/2,n[s]=o===s?t[s]-i[a]:t[x(s)],n}function T(e,t){return Array.prototype.find?e.find(t):e.filter(t)[0]}function D(e,t,o){if(Array.prototype.findIndex)return e.findIndex(function(e){return e[t]===o});var i=T(e,function(e){return e[t]===o});return e.indexOf(i)}function C(t,o,i){var n=void 0===i?t:t.slice(0,D(t,"name",i));return n.forEach(function(t){t["function"]&&console.warn("`modifier.function` is deprecated, use `modifier.fn`!");var i=t["function"]||t.fn;t.enabled&&e(i)&&(o.offsets.popper=c(o.offsets.popper),o.offsets.reference=c(o.offsets.reference),o=i(o,t))}),o}function N(){if(!this.state.isDestroyed){var e={instance:this,styles:{},arrowStyles:{},attributes:{},flipped:!1,offsets:{}};e.offsets.reference=O(this.state,this.popper,this.reference),e.placement=v(this.options.placement,e.offsets.reference,this.popper,this.reference,this.options.modifiers.flip.boundariesElement,this.options.modifiers.flip.padding),e.originalPlacement=e.placement,e.offsets.popper=S(this.popper,e.offsets.reference,e.placement),e.offsets.popper.position="absolute",e=C(this.modifiers,e),this.state.isCreated?this.options.onUpdate(e):(this.state.isCreated=!0,this.options.onCreate(e))}}function k(e,t){return e.some(function(e){var o=e.name,i=e.enabled;return i&&o===t})}function W(e){for(var t=[!1,"ms","Webkit","Moz","O"],o=e.charAt(0).toUpperCase()+e.slice(1),n=0;n<t.length-1;n++){var i=t[n],r=i?""+i+o:e;if("undefined"!=typeof document.body.style[r])return r}return null}function P(){return this.state.isDestroyed=!0,k(this.modifiers,"applyStyle")&&(this.popper.removeAttribute("x-placement"),this.popper.style.left="",this.popper.style.position="",this.popper.style.top="",this.popper.style[W("transform")]=""),this.disableEventListeners(),this.options.removeOnDestroy&&this.popper.parentNode.removeChild(this.popper),this}function B(e){var t=e.ownerDocument;return t?t.defaultView:window}function H(e,t,o,i){var r="BODY"===e.nodeName,p=r?e.ownerDocument.defaultView:e;p.addEventListener(t,o,{passive:!0}),r||H(n(p.parentNode),t,o,i),i.push(p)}function A(e,t,o,i){o.updateBound=i,B(e).addEventListener("resize",o.updateBound,{passive:!0});var r=n(e);return H(r,"scroll",o.updateBound,o.scrollParents),o.scrollElement=r,o.eventsEnabled=!0,o}function I(){this.state.eventsEnabled||(this.state=A(this.reference,this.options,this.state,this.scheduleUpdate))}function M(e,t){return B(e).removeEventListener("resize",t.updateBound),t.scrollParents.forEach(function(e){e.removeEventListener("scroll",t.updateBound)}),t.updateBound=null,t.scrollParents=[],t.scrollElement=null,t.eventsEnabled=!1,t}function R(){this.state.eventsEnabled&&(cancelAnimationFrame(this.scheduleUpdate),this.state=M(this.reference,this.state))}function U(e){return""!==e&&!isNaN(parseFloat(e))&&isFinite(e)}function Y(e,t){Object.keys(t).forEach(function(o){var i="";-1!==["width","height","top","right","bottom","left"].indexOf(o)&&U(t[o])&&(i="px"),e.style[o]=t[o]+i})}function j(e,t){Object.keys(t).forEach(function(o){var i=t[o];!1===i?e.removeAttribute(o):e.setAttribute(o,t[o])})}function F(e,t,o){var i=T(e,function(e){var o=e.name;return o===t}),n=!!i&&e.some(function(e){return e.name===o&&e.enabled&&e.order<i.order});if(!n){var r="`"+t+"`";console.warn("`"+o+"`"+" modifier is required by "+r+" modifier in order to work, be sure to include it before "+r+"!")}return n}function K(e){return"end"===e?"start":"start"===e?"end":e}function q(e){var t=1<arguments.length&&void 0!==arguments[1]&&arguments[1],o=ae.indexOf(e),i=ae.slice(o+1).concat(ae.slice(0,o));return t?i.reverse():i}function V(e,t,o,i){var n=e.match(/((?:\-|\+)?\d*\.?\d*)(.*)/),r=+n[1],p=n[2];if(!r)return e;if(0===p.indexOf("%")){var s;switch(p){case"%p":s=o;break;case"%":case"%r":default:s=i}var d=c(s);return d[t]/100*r}if("vh"===p||"vw"===p){var a;return a="vh"===p?J(document.documentElement.clientHeight,window.innerHeight||0):J(document.documentElement.clientWidth,window.innerWidth||0),a/100*r}return r}function z(e,t,o,i){var n=[0,0],r=-1!==["right","left"].indexOf(i),p=e.split(/(\+|\-)/).map(function(e){return e.trim()}),s=p.indexOf(T(p,function(e){return-1!==e.search(/,|\s/)}));p[s]&&-1===p[s].indexOf(",")&&console.warn("Offsets separated by white space(s) are deprecated, use a comma (,) instead.");var d=/\s*,\s*|\s+/,a=-1===s?[p]:[p.slice(0,s).concat([p[s].split(d)[0]]),[p[s].split(d)[1]].concat(p.slice(s+1))];return a=a.map(function(e,i){var n=(1===i?!r:r)?"height":"width",p=!1;return e.reduce(function(e,t){return""===e[e.length-1]&&-1!==["+","-"].indexOf(t)?(e[e.length-1]=t,p=!0,e):p?(e[e.length-1]+=t,p=!1,e):e.concat(t)},[]).map(function(e){return V(e,n,t,o)})}),a.forEach(function(e,t){e.forEach(function(o,i){U(o)&&(n[t]+=o*("-"===e[i-1]?-1:1))})}),n}function G(e,t){var o,i=t.offset,n=e.placement,r=e.offsets,p=r.popper,s=r.reference,d=n.split("-")[0];return o=U(+i)?[+i,0]:z(i,p,s,d),"left"===d?(p.top+=o[0],p.left-=o[1]):"right"===d?(p.top+=o[0],p.left+=o[1]):"top"===d?(p.left+=o[0],p.top-=o[1]):"bottom"===d&&(p.left+=o[0],p.top+=o[1]),e.popper=p,e}for(var _=Math.min,X=Math.floor,J=Math.max,Q="undefined"!=typeof window&&"undefined"!=typeof document,Z=["Edge","Trident","Firefox"],$=0,ee=0;ee<Z.length;ee+=1)if(Q&&0<=navigator.userAgent.indexOf(Z[ee])){$=1;break}var i,te=Q&&window.Promise,oe=te?function(e){var t=!1;return function(){t||(t=!0,window.Promise.resolve().then(function(){t=!1,e()}))}}:function(e){var t=!1;return function(){t||(t=!0,setTimeout(function(){t=!1,e()},$))}},ie=function(){return void 0==i&&(i=-1!==navigator.appVersion.indexOf("MSIE 10")),i},ne=function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")},re=function(){function e(e,t){for(var o,n=0;n<t.length;n++)o=t[n],o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(e,o.key,o)}return function(t,o,i){return o&&e(t.prototype,o),i&&e(t,i),t}}(),pe=function(e,t,o){return t in e?Object.defineProperty(e,t,{value:o,enumerable:!0,configurable:!0,writable:!0}):e[t]=o,e},se=Object.assign||function(e){for(var t,o=1;o<arguments.length;o++)for(var i in t=arguments[o],t)Object.prototype.hasOwnProperty.call(t,i)&&(e[i]=t[i]);return e},de=["auto-start","auto","auto-end","top-start","top","top-end","right-start","right","right-end","bottom-end","bottom","bottom-start","left-end","left","left-start"],ae=de.slice(3),le={FLIP:"flip",CLOCKWISE:"clockwise",COUNTERCLOCKWISE:"counterclockwise"},fe=function(){function t(o,i){var n=this,r=2<arguments.length&&void 0!==arguments[2]?arguments[2]:{};ne(this,t),this.scheduleUpdate=function(){return requestAnimationFrame(n.update)},this.update=oe(this.update.bind(this)),this.options=se({},t.Defaults,r),this.state={isDestroyed:!1,isCreated:!1,scrollParents:[]},this.reference=o&&o.jquery?o[0]:o,this.popper=i&&i.jquery?i[0]:i,this.options.modifiers={},Object.keys(se({},t.Defaults.modifiers,r.modifiers)).forEach(function(e){n.options.modifiers[e]=se({},t.Defaults.modifiers[e]||{},r.modifiers?r.modifiers[e]:{})}),this.modifiers=Object.keys(this.options.modifiers).map(function(e){return se({name:e},n.options.modifiers[e])}).sort(function(e,t){return e.order-t.order}),this.modifiers.forEach(function(t){t.enabled&&e(t.onLoad)&&t.onLoad(n.reference,n.popper,n.options,t,n.state)}),this.update();var p=this.options.eventsEnabled;p&&this.enableEventListeners(),this.state.eventsEnabled=p}return re(t,[{key:"update",value:function(){return N.call(this)}},{key:"destroy",value:function(){return P.call(this)}},{key:"enableEventListeners",value:function(){return I.call(this)}},{key:"disableEventListeners",value:function(){return R.call(this)}}]),t}();return fe.Utils=("undefined"==typeof window?global:window).PopperUtils,fe.placements=de,fe.Defaults={placement:"bottom",eventsEnabled:!0,removeOnDestroy:!1,onCreate:function(){},onUpdate:function(){},modifiers:{shift:{order:100,enabled:!0,fn:function(e){var t=e.placement,o=t.split("-")[0],i=t.split("-")[1];if(i){var n=e.offsets,r=n.reference,p=n.popper,s=-1!==["bottom","top"].indexOf(o),d=s?"left":"top",a=s?"width":"height",l={start:pe({},d,r[d]),end:pe({},d,r[d]+r[a]-p[a])};e.offsets.popper=se({},p,l[i])}return e}},offset:{order:200,enabled:!0,fn:G,offset:0},preventOverflow:{order:300,enabled:!0,fn:function(e,t){var o=t.boundariesElement||r(e.instance.popper);e.instance.reference===o&&(o=r(o));var i=y(e.instance.popper,e.instance.reference,t.padding,o);t.boundaries=i;var n=t.priority,p=e.offsets.popper,s={primary:function(e){var o=p[e];return p[e]<i[e]&&!t.escapeWithReference&&(o=J(p[e],i[e])),pe({},e,o)},secondary:function(e){var o="right"===e?"left":"top",n=p[o];return p[e]>i[e]&&!t.escapeWithReference&&(n=_(p[o],i[e]-("right"===e?p.width:p.height))),pe({},o,n)}};return n.forEach(function(e){var t=-1===["left","top"].indexOf(e)?"secondary":"primary";p=se({},p,s[t](e))}),e.offsets.popper=p,e},priority:["left","right","top","bottom"],padding:5,boundariesElement:"scrollParent"},keepTogether:{order:400,enabled:!0,fn:function(e){var t=e.offsets,o=t.popper,i=t.reference,n=e.placement.split("-")[0],r=X,p=-1!==["top","bottom"].indexOf(n),s=p?"right":"bottom",d=p?"left":"top",a=p?"width":"height";return o[s]<r(i[d])&&(e.offsets.popper[d]=r(i[d])-o[a]),o[d]>r(i[s])&&(e.offsets.popper[d]=r(i[s])),e}},arrow:{order:500,enabled:!0,fn:function(e,o){var i;if(!F(e.instance.modifiers,"arrow","keepTogether"))return e;var n=o.element;if("string"==typeof n){if(n=e.instance.popper.querySelector(n),!n)return e}else if(!e.instance.popper.contains(n))return console.warn("WARNING: `arrow.element` must be child of its popper element!"),e;var r=e.placement.split("-")[0],p=e.offsets,s=p.popper,d=p.reference,a=-1!==["left","right"].indexOf(r),l=a?"height":"width",f=a?"Top":"Left",m=f.toLowerCase(),h=a?"left":"top",g=a?"bottom":"right",u=L(n)[l];d[g]-u<s[m]&&(e.offsets.popper[m]-=s[m]-(d[g]-u)),d[m]+u>s[g]&&(e.offsets.popper[m]+=d[m]+u-s[g]),e.offsets.popper=c(e.offsets.popper);var b=d[m]+d[l]/2-u/2,w=t(e.instance.popper),y=parseFloat(w["margin"+f],10),E=parseFloat(w["border"+f+"Width"],10),v=b-e.offsets.popper[m]-y-E;return v=J(_(s[l]-u,v),0),e.arrowElement=n,e.offsets.arrow=(i={},pe(i,m,Math.round(v)),pe(i,h,""),i),e},element:"[x-arrow]"},flip:{order:600,enabled:!0,fn:function(e,t){if(k(e.instance.modifiers,"inner"))return e;if(e.flipped&&e.placement===e.originalPlacement)return e;var o=y(e.instance.popper,e.instance.reference,t.padding,t.boundariesElement),i=e.placement.split("-")[0],n=x(i),r=e.placement.split("-")[1]||"",p=[];switch(t.behavior){case le.FLIP:p=[i,n];break;case le.CLOCKWISE:p=q(i);break;case le.COUNTERCLOCKWISE:p=q(i,!0);break;default:p=t.behavior}return p.forEach(function(s,d){if(i!==s||p.length===d+1)return e;i=e.placement.split("-")[0],n=x(i);var a=e.offsets.popper,l=e.offsets.reference,f=X,m="left"===i&&f(a.right)>f(l.left)||"right"===i&&f(a.left)<f(l.right)||"top"===i&&f(a.bottom)>f(l.top)||"bottom"===i&&f(a.top)<f(l.bottom),h=f(a.left)<f(o.left),c=f(a.right)>f(o.right),g=f(a.top)<f(o.top),u=f(a.bottom)>f(o.bottom),b="left"===i&&h||"right"===i&&c||"top"===i&&g||"bottom"===i&&u,w=-1!==["top","bottom"].indexOf(i),y=!!t.flipVariations&&(w&&"start"===r&&h||w&&"end"===r&&c||!w&&"start"===r&&g||!w&&"end"===r&&u);(m||b||y)&&(e.flipped=!0,(m||b)&&(i=p[d+1]),y&&(r=K(r)),e.placement=i+(r?"-"+r:""),e.offsets.popper=se({},e.offsets.popper,S(e.instance.popper,e.offsets.reference,e.placement)),e=C(e.instance.modifiers,e,"flip"))}),e},behavior:"flip",padding:5,boundariesElement:"viewport"},inner:{order:700,enabled:!1,fn:function(e){var t=e.placement,o=t.split("-")[0],i=e.offsets,n=i.popper,r=i.reference,p=-1!==["left","right"].indexOf(o),s=-1===["top","left"].indexOf(o);return n[p?"left":"top"]=r[o]-(s?n[p?"width":"height"]:0),e.placement=x(t),e.offsets.popper=c(n),e}},hide:{order:800,enabled:!0,fn:function(e){if(!F(e.instance.modifiers,"hide","preventOverflow"))return e;var t=e.offsets.reference,o=T(e.instance.modifiers,function(e){return"preventOverflow"===e.name}).boundaries;if(t.bottom<o.top||t.left>o.right||t.top>o.bottom||t.right<o.left){if(!0===e.hide)return e;e.hide=!0,e.attributes["x-out-of-boundaries"]=""}else{if(!1===e.hide)return e;e.hide=!1,e.attributes["x-out-of-boundaries"]=!1}return e}},computeStyle:{order:850,enabled:!0,fn:function(e,t){var o=t.x,i=t.y,n=e.offsets.popper,p=T(e.instance.modifiers,function(e){return"applyStyle"===e.name}).gpuAcceleration;void 0!==p&&console.warn("WARNING: `gpuAcceleration` option moved to `computeStyle` modifier and will not be supported in future versions of Popper.js!");var s,d,a=void 0===p?t.gpuAcceleration:p,l=r(e.instance.popper),f=g(l),m={position:n.position},h={left:X(n.left),top:X(n.top),bottom:X(n.bottom),right:X(n.right)},c="bottom"===o?"top":"bottom",u="right"===i?"left":"right",b=W("transform");if(d="bottom"==c?-f.height+h.bottom:h.top,s="right"==u?-f.width+h.right:h.left,a&&b)m[b]="translate3d("+s+"px, "+d+"px, 0)",m[c]=0,m[u]=0,m.willChange="transform";else{var w="bottom"==c?-1:1,y="right"==u?-1:1;m[c]=d*w,m[u]=s*y,m.willChange=c+", "+u}var E={"x-placement":e.placement};return e.attributes=se({},E,e.attributes),e.styles=se({},m,e.styles),e.arrowStyles=se({},e.offsets.arrow,e.arrowStyles),e},gpuAcceleration:!0,x:"bottom",y:"right"},applyStyle:{order:900,enabled:!0,fn:function(e){return Y(e.instance.popper,e.styles),j(e.instance.popper,e.attributes),e.arrowElement&&Object.keys(e.arrowStyles).length&&Y(e.arrowElement,e.arrowStyles),e},onLoad:function(e,t,o,i,n){var r=O(n,t,e),p=v(o.placement,r,t,e,o.modifiers.flip.boundariesElement,o.modifiers.flip.padding);return t.setAttribute("x-placement",p),Y(t,{position:"absolute"}),o},gpuAcceleration:void 0}}},fe});define("src/models/MyUser",["backbone","src/globals/me"],function(Backbone,me){"use strict";return Backbone.Model.extend({url:"/user",getTag:function getTag(key){return(this.get("tags")||{})[key]},setTag:function setTag(key,value){var tags=this.get("tags")||{};tags[key]=(value||"").toString();this.set("tags",tags)},saveTag:function saveTag(key,value){var _this=this;var options=arguments.length>2&&arguments[2]!==undefined?arguments[2]:{};var _success=options.success||function(){};var error=options.error||function(){};this.fetch({error:error,success:function success(){me.setTag(key,value);_this.setTag(key,value);_this.save({error:error,success:_success})}})},parse:function parse(attrs){delete attrs.password;return attrs}})});define("src/guider/helper/offset",[],function(){"use strict";function calculateOffset(_ref){var placement=_ref.placement,top=_ref.top,left=_ref.left,_ref$offset=_ref.offset,offset=_ref$offset===void 0?0:_ref$offset,_ref$translation=_ref.translation,translation=_ref$translation===void 0?0:_ref$translation;var newTop;var newLeft;if(placement==="top"){newTop=top-offset;newLeft=left+translation}else if(placement==="bottom"){newTop=top+offset;newLeft=left+translation}else if(placement==="left"){newLeft=left-offset;newTop=top+translation}else if(placement==="right"){newLeft=left+offset;newTop=top+translation}return{top:newTop,left:newLeft}}return{calculateOffset:calculateOffset}});define("mustache!src/guider/templates/image-insights-dashboard-picker",["lib/mustache"],function(mustache){var escapedTemplate="<p><strong>New!</strong> Use the Images Dashboard to get a specialized view of the data in your Logo Query. Now includes <strong>Instagram</strong> data!</p>\n";return function(data,partials,wrap){return mustache.render(escapedTemplate,data,partials,wrap)}});define("mustache!src/guider/templates/image-insights-logo-dashboard",["lib/mustache"],function(mustache){var escapedTemplate='<h3 class="singlemargin-bottom biggertext">&#x1f44b; <strong>New!</strong> Now with Instagram Data</h3>\n<p>The Images Dashboard now includes Instagram data! We recommend building a new Dashboard to see unique Instagram analytics.</p>\n';return function(data,partials,wrap){return mustache.render(escapedTemplate,data,partials,wrap)}});define("mustache!src/guider/templates/image-insights-quick-search",["lib/mustache"],function(mustache){var escapedTemplate="<p>Search the Image Wall by any keyword or hashtag. You can also exclude a hashtag.</p>\n<br/>\n<p>For example type: NOT hashtags:icecream</p>";return function(data,partials,wrap){return mustache.render(escapedTemplate,data,partials,wrap)}});define("mustache!src/guider/templates/sourceagnostic-image-wall",["lib/mustache"],function(mustache){var escapedTemplate='<h1 class="bold popuptitletext">New! One Image Wall for all sources</h1>\n<p class="singlepadding-top">Your Logo Queries now include data from all page types, letting you see when your logo is appearing on news sites, blogs, forums, and more!</p>\n<p class="singlepadding-vertical">To show off this change we now have a single Image Wall Component, showing a view of all the images in your Logo Query regardless of where they\'re from. If you\'d like to see data from just one source, simply add a Page Type filter to the Component.</p>\n';return function(data,partials,wrap){return mustache.render(escapedTemplate,data,partials,wrap)}});define("src/guider/helper/templates",["mustache!src/guider/templates/image-insights-dashboard-picker","mustache!src/guider/templates/image-insights-logo-dashboard","mustache!src/guider/templates/image-insights-quick-search","mustache!src/guider/templates/sourceagnostic-image-wall"],function(imageInsightsDashboardPickerTemplate,imageInsightsLogoDashboard,imageInsightsQuickSearch,sourceagnosticImageWall){"use strict";var map=new Map;map.set("image-insights-dashboard-picker",imageInsightsDashboardPickerTemplate);map.set("image-insights-logo-dashboard",imageInsightsLogoDashboard);map.set("image-insights-quick-search",imageInsightsQuickSearch);map.set("sourceagnostic-image-wall",sourceagnosticImageWall);return map});define("mustache!src/guider/guider",["lib/mustache"],function(mustache){var escapedTemplate='<div class="popper-guider__wrapper js-wrapper">\n<button class="popper-guider__close js-close"></button>\n<div class="popper-guider__content">{{{content}}}</div>\n<div class="popper-guider__arrow"></div>\n<button class="popper-guider__button button defaultbutton js-dismiss">Got it!</button>\n</div>\n';return function(data,partials,wrap){return mustache.render(escapedTemplate,data,partials,wrap)}});define("css!src/guider/guider.css",["css!src/guider/compiled.css"],function(){});function _defineProperty(obj,key,value){if(key in obj){Object.defineProperty(obj,key,{value:value,enumerable:true,configurable:true,writable:true})}else{obj[key]=value}return obj}define("src/guider/GuiderView",["jquery","backbone","popper","src/controls/lib/paramAssert","src/globals/me","src/models/MyUser","src/events/guiderEvents","src/events/globalEventNames","src/guider/helper/offset","src/guider/helper/templates","mustache!src/guider/guider","css!src/guider/guider.css"],function($,Backbone,Popper,paramAssert,me,MyUser,guiderEvents,globalEventNames,offsetHelper,GUIDERS,template){"use strict";var _events;var GUIDER_EVENTS=globalEventNames.GUIDER;var VIEW_SELECTORS={CLOSE:".js-close",DISMISS:".js-dismiss",WRAPPER:".js-wrapper"};var PLACEMENTS=["top","left","bottom","right","auto"];function getPrefixedGuiderKey(key){return"guider-".concat(key)}function dismissGuider(view){view.remove();view.myUser.saveTag(getPrefixedGuiderKey(view.guiderKey),true);guiderEvents.trigger(GUIDER_EVENTS.GUIDER_DISMISSED,{guiderKey:view.guiderKey})}function removeGuider(view){view.remove();guiderEvents.trigger(GUIDER_EVENTS.GUIDER_CLOSED,{guiderKey:view.guiderKey})}function initializePopper(view,target){var $arrowElement=view.$(".popper-guider__arrow");view.element=new Popper(target,view.el,{placement:view.placement,removeOnDestroy:true,modifiers:{offset:{enabled:true,fn:function fn(data){var placement=data.placement,popper=data.offsets.popper;var offset=offsetHelper.calculateOffset({placement:placement,top:popper.top,left:popper.left,offset:view.offset,translation:view.translation});data.offsets.popper=Object.assign({},popper,offset);return data}},arrow:{enabled:true,element:$arrowElement[0]}}})}function delayGuiderInitialization(view,target){if(document.body.contains(target)){initializePopper(view,target)}else{window.requestAnimationFrame(function(){delayGuiderInitialization(view,target)})}}function setupChangeObserver(view,$target){if(!window.MutationObserver){return}view.targetOffset=$target.offset();view.observer=new window.MutationObserver(function(){var _$target$offset=$target.offset(),top=_$target$offset.top,left=_$target$offset.left;if(top===view.targetOffset.top&&left===view.targetOffset.left){return}view.targetOffset={top:top,left:left};view.element&&view.element.update()});startObserver(view)}function startObserver(view){if(!view.observer){return}view.observer.observe(document.body,{childList:true,subtree:true})}function stopObserver(view){if(!view.observer){return}view.observer.disconnect();view.observer=null}function doesGuiderExist(key){return GuiderView.existingGuiders.includes(key)}function addToExistingGuiders(key){GuiderView.existingGuiders.push(key)}function removeFromExistingGuiders(key){if(!doesGuiderExist(key)){return}GuiderView.existingGuiders.splice(GuiderView.existingGuiders.indexOf(key),1)}var GuiderView=Backbone.View.extend({className:"popper-guider",events:(_events={},_defineProperty(_events,"click ".concat(VIEW_SELECTORS.DISMISS),function click(){dismissGuider(this)}),_defineProperty(_events,"click ".concat(VIEW_SELECTORS.CLOSE),function click(){removeGuider(this)}),_events),constructor:function GuiderView(){var options=arguments.length>0&&arguments[0]!==undefined?arguments[0]:{};Backbone.View.apply(this,arguments);paramAssert.isNotDefined(options.guiderKey,"A unique key must be passed to GuiderView");if(!GUIDERS.has(options.guiderKey)){throw new TypeError("Key ".concat(options.guiderKey," does not exist"))}if(options.placement&&!PLACEMENTS.includes(options.placement)){throw new TypeError("options.placement must be one of ".concat(PLACEMENTS.join(", ")," (").concat(options.placement," passed)"))}if(options.offset&&!Number.isInteger(options.offset)){throw new TypeError("options.offset must be an integer")}if(options.translation&&!Number.isInteger(options.translation)){throw new TypeError("options.translation must be an integer")}if(options.width&&!Number.isInteger(options.width)){throw new TypeError("options.width must be an integer")}this.guiderKey=options.guiderKey;this.placement=options.placement||"auto";this.offset=options.offset;this.translation=options.translation;this.width=options.width;this.myUser=new MyUser},render:function render($target){paramAssert.isNotDefined($target,"A target must be passed to GuiderView#render");if(me.getTag(getPrefixedGuiderKey(this.guiderKey))){return}if(doesGuiderExist(this.guiderKey)){return}addToExistingGuiders(this.guiderKey);this.$el.html(template({content:GUIDERS.get(this.guiderKey)}));if(this.width){this.$(VIEW_SELECTORS.WRAPPER).css("max-width","".concat(this.width,"px"))}document.body.appendChild(this.el);delayGuiderInitialization(this,$target[0]);setupChangeObserver(this,$target);guiderEvents.trigger(GUIDER_EVENTS.GUIDER_OPENED,{guiderKey:this.guiderKey})},show:function show(){if(!this.element){return}$(this.element.popper).removeClass("hidden");startObserver(this)},hide:function hide(){if(!this.element){return}$(this.element.popper).addClass("hidden");stopObserver(this)},remove:function remove(){if(this.element){this.element.destroy();this.element=null}stopObserver(this);removeFromExistingGuiders(this.guiderKey);Backbone.View.prototype.remove.call(this)}},{existingGuiders:[]});return GuiderView});define("mustache!templates/dashboardToolbar",["lib/mustache"],function(mustache){var escapedTemplate='<div class="dashboard-toolbar-notifications pagemargin-right smallmargin-bottom singlemargin-left"></div>\n<div class="floatleft js-title-container">\n<h1 class="navigation--color1 pagetitletext singlepadding-horizontal singlemargin-bottom js-guider">\n{{#canEdit}}\n<a class=\'js-name customtip navigation--color1 editabletext textellipsis dib eightcolmax\' data-at="dashboard-title" title=\'Rename Dashboard\'>{{name}}</a>\n{{/canEdit}}\n{{^canEdit}}\n<span class=\'textellipsis dib eightcolmax\' title=\'{{name}}\'>{{name}}</span>\n{{/canEdit}}\n</h1>\n</div>\n{{#canSearchGlobally}}\n<div class="js-close singlepadding-left floatright pagemargin-right">\n<a class="customtip iconmedium grey icon-remove" data-tip-position="left" title="Close Dashboard"></a>\n</div>\n{{/canSearchGlobally}}\n<ul class="grey rowborder smallpadding-bottom clearboth">\n{{#canEdit}}\n<li class="js-save-indicator singlepadding-right floatleft {{#canSearchGlobally}}centre-vertical{{/canSearchGlobally}}">\n<a class="js-save disabled disabledcolor saved icontoolbar bwicon icon-bwsave-ok grey customtip" data-at="dashboard-save" title="Dashboard was last saved {{lastSaved}}">\n<span class="dib smallmargin-bottom mediumtext valignmiddle">Save</span>\n</a>\n</li>\n{{/canEdit}}\n\n{{#canShare}}\n<li class="toolbar--separator singlepadding-horizontal floatleft {{#canSearchGlobally}}centre-vertical{{/canSearchGlobally}}">\n<a class="js-share customtip icontoolbar grey bwicon icon-bwusers" title=\'{{shareIconTooltip}}\'>\n<span class="dib smallmargin-bottom mediumtext valignmiddle">Share</span>\n</a>\n</li>\n{{/canShare}}\n\n<li class="toolbar--separator singlepadding-horizontal floatleft {{#canSearchGlobally}}centre-vertical{{/canSearchGlobally}}">\n<a class="js-refresh icontoolbar grey bwicon icon-bwreload customtip" title="Reload Data">\n<span class="dib smallmargin-bottom mediumtext valignmiddle">Refresh</span>\n</a>\n</li>\n\n{{#canApplyDateRange}}\n<li class="js-item toolbar--separator singlepadding-horizontal floatleft {{#canSearchGlobally}}centre-vertical{{/canSearchGlobally}}">\n<a class="icontoolbar grey bwicon icon-bwcalendar customtip" title="Apply date range to all Dashboard Components">\n<span class=" smallmargin-bottom mediumtext valignmiddle">Date Range</span>\n</a>\n</li>\n{{/canApplyDateRange}}\n\n{{#canExport}}\n<li class="toolbar--separator singlepadding-horizontal floatleft {{#canSearchGlobally}}centre-vertical{{/canSearchGlobally}}">\n<a class="js-export icontoolbar grey bwicon icon-bwdownload customtip" title=\'Export Dashboard "{{name}}" to PowerPoint\'>\n<span class="dib smallmargin-bottom mediumtext valignmiddle">Export</span>\n</a>\n</li>\n{{/canExport}}\n{{#canSearchGlobally}}\n{{#canApplyFilters}}\n<li class="toolbar--separator singlepadding-horizontal floatleft centre-vertical">\n<a class="js-filters icontoolbar grey icon-bwfilter customtip" title="Apply filters to all Dashboard Components">\n<span class="dib smallmargin-bottom valignmiddle mediumtext">Filters</span>\n<span class="dib smallmargin-bottom valignmiddle iconsmall icon-chevron-down"></span>\n</a>\n</li>\n{{/canApplyFilters}}\n{{/canSearchGlobally}}\n\n<li class="toolbar--separator singlepadding-horizontal floatleft {{#canSearchGlobally}}centre-vertical{{/canSearchGlobally}}">\n<a class="js-more-actions icontoolbar grey icon-bwthree-dots">\n<span class="dib smallmargin-bottom mediumtext valignmiddle">More</span>\n</a>\n</li>\n\n{{^canSearchGlobally}}\n<li class="toolbar--separator singlepadding-horizontal floatright">\n<a class="js-close customtip iconmedium grey icon-remove" title="Close Dashboard"></a>\n</li>\n{{#canApplyFilters}}\n<li class="toolbar--separator singlepadding-horizontal floatright">\n<a class="js-filters icontoolbar grey icon-bwfilter customtip" title="Apply filters to all Dashboard Components">\n<span class="dib smallmargin-bottom valignmiddle mediumtext">Filters</span>\n<span class="dib smallmargin-bottom valignmiddle iconsmall icon-chevron-down"></span>\n</a>\n</li>\n{{/canApplyFilters}}\n{{/canSearchGlobally}}\n{{#canSearchGlobally}}\n<li class="singlepadding-left doublepadding-bottom floatright js-search"></li>\n{{/canSearchGlobally}}\n</ul>\n';return function(data,partials,wrap){return mustache.render(escapedTemplate,data,partials,wrap)}});define("css!css/dashboardToolbar.css",["css!css/compiled.css"],function(){});define("src/views/DashboardToolbarView",["backbone","underscore","jquery","moment","src/events/globalEventNames","src/events/quickSearchEvents","src/globals/currentProject","src/globals/currentDashboard","src/globals/theme","src/globals/me","src/helpers/dashboardExports/access","src/helpers/dashboardExports/export","src/permissions","src/views/DashboardToolbarContextMenuView","src/views/ShareDashboardView","src/views/GlobalInputsView","src/views/GlobalDateInputsView","src/views/GlobalQueryInputsView","src/views/GlobalFilterInputsView","src/views/GlobalTimezoneSelectionView","src/views/DashboardSearchInputView","src/setupstore/views/DashboardInfoView","src/DashboardConfiguration","src/guider/GuiderView","src/ReactAppLoader","mustache!templates/dashboardToolbar","src/packages/spin","bw-fe-helpers/timezoneDateHelper","src/packages/customtip","lib/jquery.showNotification","css!css/dashboardToolbar.css"],function(Backbone,_,$,moment,globalEventNames,quickSearchEvents,currentProject,currentDashboard,theme,me,dashboardExportsAccessHelper,dashboardExportsHelper,permissions,DashboardToolbarContextMenuView,ShareDashboardView,GlobalInputsView,GlobalDateInputsView,GlobalQueryInputsView,GlobalFilterInputsView,GlobalTimezoneSelectionView,DashboardSearchInputView,DashboardInfoView,DashboardConfiguration,GuiderView,ReactAppLoader,template,spin,timezoneDateHelper){"use strict";var VIEW_SELECTORS={GUIDER:".js-guider"};function makeSharingMessage(model,settings,userList){var unshared=settings.sharedWith==="none";var viewMode=settings.sharedWith==="view";var analystMode=settings.sharedWith==="analyst";var analysts=settings.analystUsers||[];var viewers=settings.viewUsers||[];var totalShared=analysts.length+viewers.length;var namedUsers=_(analysts.concat(viewers)).chain().first(2).map(function(id){return userList[id]}).value();var message='Your Dashboard "'+model.escape("name")+'" has been ';var remainder;if(unshared){return'Your Dashboard "'+model.escape("name")+'" has been unshared'}if(viewMode){return message+'shared with all users of the current Project in "View-Only" mode'}if(analystMode){return message+'shared with all users of the current Project in "Analyst" mode'}if(!totalShared){return'The sharing settings have been updated for your Dashboard "'+model.escape("name")+'"'}if(totalShared===1){return message+"shared with "+namedUsers[0]}if(totalShared===2){return message+"shared with "+namedUsers.join(" and ")}remainder=totalShared-2;return message+"shared with "+namedUsers.join(", ")+" and "+remainder+" other user"+(remainder>1?"s":"")}function makePrettyDate(date){return timezoneDateHelper.prettifyDate(date,{timezone:currentProject.getTimezone()})}function getShareIconTooltip(){return"Share this Dashboard with other users"}function showSaveInProgressState(view){view.$(".js-save-indicator").spin(Object.assign({lines:12,width:1,speed:1,top:-3},spin.defaults)).find("a").removeClass("saved").addClass("saving disabled disabledcolor").attr("title","Saving dashboard").customtip()}function showSaveNotification(view){var changed=view.model.changed;var shareChange=changed&&(changed.analystUsers||changed.viewUsers||changed.sharedWith);if(shareChange){return}view.$(".dashboard-toolbar-notifications").showNotification({text:'Your Dashboard "'+view.model.escape("name")+'" has been saved',duration:5e3,cssClass:"notification-success"})}function showShareNotification(view,options){view.$(".dashboard-toolbar-notifications").showNotification({text:makeSharingMessage(options.model,options.settings,options.users),duration:5e3,cssClass:"notification-success"})}function updateName(view){var model=view.model;var name=model.get("name");view.$(".js-name").text(name);view.$(".js-share.customtip").attr("title",getShareIconTooltip()).customtip()}function renameDashboard(view){var model=view.model;$.prompt({text:"Rename Dashboard",okText:"Rename",intro:"Dashboard name",maxLength:model.dashboardNameMaxLength,selectText:true,validate:model.validateDashboardName.bind(model)},model.get("name"),function(err,newName){if(err||!newName){return}view.model.set({name:newName})})}function saveDashboard(view,$target){if($target.hasClass("disabled")){return}view.trigger("saveRequested")}function shareDashboard(view){ShareDashboardView.show({model:view.model})}function refreshDashboard(view){view.trigger("refreshRequested")}function closeDashboard(view){view.trigger("closeRequested")}function trackQuickSearchSubmitted(model){var term=arguments.length>1&&arguments[1]!==undefined?arguments[1]:"";quickSearchEvents.trigger(globalEventNames.QUICK_SEARCH.QUICK_SEARCH_SUBMITTED,{dashboard:model.id,projectId:model.get("projectId"),term:term})}function exportTemplate(view){var data=view.model.toJSON();var dashboardConfig=new DashboardConfiguration({tabs:data.tabs},true);var $form=$('<form id="dashboardDownload" method="post" action="/download/dashboardtemplate" target="_blank" />');dashboardConfig.createTemplateConfig({dashboardName:undefined,projectId:undefined,showAnnotations:true,settings:data.settings},function(err,spec){$('<input type="hidden" name="data"/>').val(JSON.stringify({name:_.slugify(theme.productName+" "+data.name+" template"),spec:spec})).appendTo($form);$("body").append($form);$form.submit();$form.remove()})}function revertDashboardVersion(view){view.dashboardRevert=new ReactAppLoader("dashboardRevert");view.dashboardRevert.render({messageBus:view.messageBus,projectId:currentDashboard.get("projectId"),dashboardId:currentDashboard.id});view.$el.append(view.dashboardRevert.$el)}function saveAs(view){view.trigger("copyRequested")}function showDashboardInfo(view){DashboardInfoView.show({dashboardId:view.model.id})}function setDirty(view){view._dirty=true}function unsetDirty(view){view._dirty=false}function showGlobalInputView(view,$target,GlobalInputViewClass){if(GlobalInputsView.existingControls instanceof GlobalInputViewClass){GlobalInputsView.existingControls.remove();delete GlobalInputsView.existingControls;return}GlobalInputViewClass.show({model:view.model,target:$target,ownerId:view.model.getOwner()})}function showMoreActions(view,$target){var menu;if(view.contextMenuView&&view.contextMenuView.isShown()){view.contextMenuView.remove();view.contextMenuView=undefined;return}menu=view.contextMenuView=DashboardToolbarContextMenuView.show({$target:$target,model:view.model});view.listenTo(menu,DashboardToolbarContextMenuView.CHANGE_DATA_SOURCE,showGlobalInputView.bind(null,view,$target,GlobalQueryInputsView));view.listenTo(menu,DashboardToolbarContextMenuView.CHANGE_TIMEZONE,showGlobalInputView.bind(null,view,$target,GlobalTimezoneSelectionView));view.listenTo(menu,DashboardToolbarContextMenuView.REQUEST_RERUN,showDashboardInfo.bind(null,view));view.listenTo(menu,DashboardToolbarContextMenuView.REQUEST_TEMPLATE,exportTemplate.bind(null,view));view.listenTo(menu,DashboardToolbarContextMenuView.REQUEST_DUPLICATE,saveAs.bind(null,view));view.listenTo(menu,DashboardToolbarContextMenuView.REQUEST_REVERT,revertDashboardVersion.bind(null,view))}function handleRemoveDialog(view){view.dashboardRevert.remove();view.dashboardRevert=null}function handleReloadDashboard(projectId,dashboardId){require("src/routes/dashboardRoute").loadDashboard(projectId,dashboardId.toString(),true);$.notify({text:"Your Dashboard has been reverted to a previous version",className:"notification-success"})}return Backbone.View.extend({tagName:"header",className:"dashboardToolbar modular doublepadding-left pagepadding-top singlepadding-bottom",globalInputsContainer:"#wrapper",events:{"click .js-name":function onClickRename(){renameDashboard(this)},"click .js-save":function onClickSave(e){saveDashboard(this,$(e.currentTarget))},"click .js-share":function onClickShare(){shareDashboard(this)},"click .js-refresh":function onClickRefresh(){refreshDashboard(this)},"click .js-export":function onClickItem(){dashboardExportsHelper.confirmExportDashboard(this)},"click .js-more-actions":function onClickShowMoreActions(e){showMoreActions(this,$(e.currentTarget))},"click .js-filters":function onClickFilters(e){showGlobalInputView(this,$(e.currentTarget),GlobalFilterInputsView)},"click .js-close":function onClickClose(){closeDashboard(this)},"click .js-item":function onClickItem(e){showGlobalInputView(this,$(e.currentTarget),GlobalDateInputsView)}},constructor:function DashboardToolbarView(options){var _this=this;Backbone.View.apply(this,arguments);if(!options||!options.model){throw new Error("options.model must be set")}if(this.model.isNew()){setDirty(this)}if(me.get("uiRole")!=="viewMetricsOnly"){this.initialiseSearchInput()}this.guider=new GuiderView({guiderKey:"image-insights-logo-dashboard",placement:"bottom",offset:5,width:430});this.messageBus=Object.assign({},Backbone.Events);this.listenTo(this.messageBus,"remove-dialog",function(){return handleRemoveDialog(_this)});this.listenTo(this.messageBus,"reload-dashboard",function(projectId,dashboardId){return handleReloadDashboard(projectId,dashboardId)});this.listenTo(this.model,"saving",showSaveInProgressState.bind(null,this));this.listenTo(this.model,"sync",showSaveNotification.bind(null,this));this.listenTo(this.model,"shareSettingsChanged",showShareNotification.bind(null,this));this.listenTo(this.model,"change:name",updateName.bind(null,this))},initialiseSearchInput:function initialiseSearchInput(){var _this2=this;this.searchInput=new DashboardSearchInputView({expandDirection:"left",expanderClassName:"dashboardSearchTermExpander singlepadding",model:this.model});this.listenTo(this.searchInput,"search",function(){var values=_this2.searchInput.getValues();_this2.model.updateGlobalControls({search:values.search});trackQuickSearchSubmitted(_this2.model,values.search)},this)},showPermanentNotification:function showPermanentNotification(options){this.$(".dashboard-toolbar-notifications").showNotification({text:options.text,cssClass:options.type||"notification-info"})},showSaveDashboardNotification:function showSaveDashboardNotification(options,callback){var context=this;$.confirm({dialogClass:"popup smallpopup",closeButtonClass:"popup--close singlepadding",title:"Unsaved Changes",text:'Dashboard "'+context.model.escape("name")+'" has '+"<strong>unsaved changes</strong> Please <strong>save"+" before exporting</strong>.",escape:false,buttons:options.buttons},callback)},showConfirmExportNotification:function showConfirmExportNotification(options,callback){$.confirm({dialogClass:"standardpopup dashboard-export-modal",title:'<span class="pagetitletext">Export PowerPoint File</span>',text:options.confirmText,escape:false,replaceNewLinesWithBreaks:false,buttons:[{text:"Request PPT File",className:"ok",value:true,keyCode:13},{text:"Close",className:"cancel",value:false,keyCode:27}]},callback)},remove:function remove(){if(GlobalInputsView.existingControls){GlobalInputsView.existingControls.remove();delete GlobalInputsView.existingControls}if(this.searchInput){this.searchInput.remove();this.searchInput=undefined}this.guider.remove();Backbone.View.prototype.remove.call(this)},render:function render(){var model=this.model;var canSearchGlobally=!!this.searchInput;var data={name:model.get("name"),canShare:permissions.check("share.dashboard",model),canEdit:permissions.check("edit.dashboard",model),canApplyFilters:permissions.check("see.dashboard.controls.advancedFilters",model),canApplyDateRange:permissions.check("see.dashboard.controls.dateRange",model),canExport:dashboardExportsAccessHelper.userCanExport(),canSearchGlobally:canSearchGlobally,shareIconTooltip:getShareIconTooltip(),lastSaved:makePrettyDate(model.get("lastSaved"))};this.$el.html(template(data));this.$el.customtip();if(canSearchGlobally){var $searchListItemEl=this.$el.find("li.js-search");if(!this.$el.find(".searchBoxContainer").length){$searchListItemEl.html('<div class="searchBoxContainer" />')}this.$el.find(".searchBoxContainer").append(this.searchInput.el);this.searchInput.render()}if(model.isNew()){this.showUnsavedState()}if(model.get("dashboardType")==="logos"&&moment.utc(model.get("creationDate")).isBefore(moment.utc("2017-12-11"))){this.guider.render(this.$(VIEW_SELECTORS.GUIDER))}},showSavedState:function showSavedState(){unsetDirty(this);this.$(".js-save-indicator").spin(false).find("a").removeClass("saving icon-bwsave").addClass("saved disabled disabledcolor icon-bwsave-ok").attr("title","Dashboard was last saved "+makePrettyDate(this.model.get("lastSaved"))).customtip()},showUnsavedState:function showUnsavedState(){setDirty(this);if(dashboardExportsHelper.confirmExportModal){this.stopListening(this.model,"sync",dashboardExportsHelper.confirmExportModal)}this.$(".js-save-indicator").find("a").removeClass("saving saved disabled disabledcolor icon-bwsave-ok").addClass("icon-bwsave").attr("title","Save Dashboard").customtip()},isDirty:function isDirty(){return this._dirty}})});define("mustache!templates/tabRenameForm",["lib/mustache"],function(mustache){var escapedTemplate='<form class="singlepadding-horizontal">\n<input name="dashboardTabName" class="field name validation-wrapper" value="{{name}}"/>\n<button class="defaultbutton rename">Rename</button>\n<button class="button cancel">Cancel</button>\n</form>\n';return function(data,partials,wrap){return mustache.render(escapedTemplate,data,partials,wrap)}});define("src/views/TabRenameFormView",["src/views/ValidatingFormView","src/analytics/Analytics","mustache!templates/tabRenameForm"],function(ValidatingFormView,Analytics,tabRenameFormTemplate){"use strict";return ValidatingFormView.extend({className:"tabRenameFormView",events:{"click .rename":"onRename","click .cancel":"onCancel"},initialize:function initialize(options){options=options||{};if(!options.model){throw new Error("TabRenameFormView must be instantiated with a Tab model")}ValidatingFormView.prototype.initialize.call(this)},render:function render(){var templateData={name:this.model.get("name")};this.$el.html(tabRenameFormTemplate(templateData))},onRename:function onRename(e){e.preventDefault();this.rename()},onCancel:function onCancel(e){e.preventDefault();this.trigger("closing")},rename:function rename(){var originalName=this.model.get("name"),newName=this.$(".name").val();if(this.model.set({name:newName},{validate:true})){this.trigger("closing");Analytics.trackEvent({name:"Miscellaneous.Tabs",action:"Rename_"+originalName+"_"+this.model.get("name"),origin:"Application"})}},remove:function remove(){ValidatingFormView.prototype.remove.call(this)}})});define("mustache!templates/tabContextMenu",["lib/mustache"],function(mustache){var escapedTemplate='<ul>\n<li class="context-menu--item js-rename"><a><span class="icon-pencil lightgrey smallmargin-right"></span>Rename tab</a></li>\n<li class="context-menu--item js-duplicate"><a><span class="icon-bwcopy lightgrey smallmargin-right"></span>Duplicate tab</a></li>\n<li class="context-menu--item js-close"><a><span class="icon-trash lightgrey smallmargin-right"></span>Delete tab</a></li>\n<li class="context-menu--item separator"></li>\n<li class="context-menu--item js-filter"><a><span class="icon-bwfilter lightgrey smallmargin-right"></span>Tab Filters</a></li>\n<li class="context-menu--item js-date-picker"><a><span class="icon-bwcalendar lightgrey smallmargin-right"></span>Tab Date Range</a></li>\n<li class="context-menu--item js-data-source"><a><span class="icon-bwdata lightgrey smallmargin-right"></span>Tab Data Source</a></li>\n<li class="context-menu--item separator"></li>\n<li class="context-menu--item js-show-component-menu" data-at="add-component-tab-menu"><a><span class="icon-plus lightgrey smallmargin-right"></span>Add a Component</a></li>\n<li class="context-menu--item js-add-notes-component"><a><span class="icon-edit lightgrey smallmargin-right"></span>Add a Note</a></li>\n<li class="context-menu--item js-copy-components"><a><span class="icon-bwcopy lightgrey smallmargin-right"></span>Copy Components</a></li>\n<li class="context-menu--item js-paste-components"><a><span class="icon-paste lightgrey smallmargin-right"></span>Paste Components</a></li>\n{{#canExport}}\n<li class="context-menu--item separator"></li>\n<li class="context-menu--item js-export"><a><span class="icon-bwdownload lightgrey smallmargin-right"></span>Export</a></li>\n{{/canExport}}\n</ul>\n';return function(data,partials,wrap){return mustache.render(escapedTemplate,data,partials,wrap)}});define("src/views/TabContextMenuView",["src/views/ContextMenuView","src/helpers/dashboardExports/access","mustache!templates/tabContextMenu","jquery.showRelativeTo"],function(ContextMenuView,dashboardExportsAccessHelper,template){"use strict";return ContextMenuView.extend({tagName:"nav",className:"tabContextMenu context-menu popupframe",attributes:{"data-at":"tab-menu-open"},initialize:function initialize(options){options=options||{};if(!options.$target){throw new Error("TabContextMenuView must be initialized with options.$target")}this.$target=options.$target;this._isShown=false},events:function events(){var events={"click li.js-rename":"onClickRename","click li.js-duplicate":"onClickDuplicate","click li.js-close":"onClickClose","click li.js-show-component-menu":"onClickShowComponentMenu","click li.js-add-notes-component":"onClickAddNotesComponent","click li.js-filter":"onClickFilter","click li.js-date-picker":"onClickDatePicker","click li.js-data-source":"onClickDataSource","click li.js-copy-components":"onClickCopyComponents","click li.js-paste-components":"onClickPasteComponents"};if(dashboardExportsAccessHelper.userCanExport()){events["click li.js-export"]="onClickExportTab"}return events},remove:function remove(){this._isShown=false;ContextMenuView.prototype.remove.call(this)},render:function render(){this.$el.html(template({canExport:dashboardExportsAccessHelper.userCanExport()}));this._isShown=true},onClickRename:function onClickRename(){this.trigger("rename",{target:this.$target});this.remove()},onClickDuplicate:function onClickDuplicate(){this.trigger("duplicate",{target:this.$target});this.remove()},onClickClose:function onClickClose(){this.trigger("close",{target:this.$target});this.remove()},onClickShowComponentMenu:function onClickShowComponentMenu(e){e.stopPropagation();this.trigger("showComponentMenu",{target:this.$target});this.remove()},onClickAddNotesComponent:function onClickAddNotesComponent(){this.trigger("addNotesComponent",{target:this.$target});this.remove()},onClickFilter:function onClickFilter(){this.trigger("filter",{target:this.$target});this.remove()},onClickDatePicker:function onClickDatePicker(){this.trigger("dateRangePicker",{target:this.$target});this.remove()},onClickDataSource:function onClickDataSource(){this.trigger("dataSource",{target:this.$target});this.remove()},onClickCopyComponents:function onClickCopyComponents(){this.trigger("copyComponents",{target:this.$target});this.remove()},onClickPasteComponents:function onClickPasteComponents(){this.trigger("pasteComponents",{target:this.$target});this.remove()},onClickExportTab:function onClickExportTab(){this.trigger("exportTab",{target:this.$target});this.remove()},isShown:function isShown(){return this._isShown}})});define("mustache!src/components/channelsanalytics/templates/multipleChannelInputs",["lib/mustache"],function(mustache){var escapedTemplate='<div class="multipleChannelInputs singlepadding-top singlepadding-horizontal relative">\n<a class="help icon-bwhelp" data-key="multiple-channel-select-input"></a>\n<label class="db">{{inputLabel}}</label>\n<fieldset class="query">\n<select class="query field" name="queryId" multiple>\n{{#queries}}\n<option value="{{id}}" {{selected}} data-readonly={{isReadOnly}} {{#typeIconClass}}data-typeiconclass="{{typeIconClass}}"{{/typeIconClass}}>{{name}}</option>\n{{/queries}}\n</select>\n</fieldset>\n</div>\n';return function(data,partials,wrap){return mustache.render(escapedTemplate,data,partials,wrap)}});define("mustache!src/components/channelsanalytics/templates/multipleChannelInputsFooter",["lib/mustache"],function(mustache){var escapedTemplate='<a class="js-create-query"><span class="iconsmaller icon-plus smallpadding-right" />New {{label}}</a>\n';return function(data,partials,wrap){return mustache.render(escapedTemplate,data,partials,wrap)}});define("src/components/channelsanalytics/views/MultipleChannelInputs",["underscore","jquery","src/Workbench","src/permissions","src/globals/queries","src/globals/currentProject","src/QueryFormManager","src/DataSourceManager","src/analytics/Analytics","src/views/ControlsViewInputs","src/controls/lib/viewHelpers","mustache!src/components/channelsanalytics/templates/multipleChannelInputs","mustache!src/components/channelsanalytics/templates/multipleChannelInputsFooter","text!src/controls/templates/sellecktItemEdit.template","src/packages/selleckt","src/packages/customtip"],function(_,$,Workbench,permissions,queries,currentProject,QueryFormManager,DataSourceManager,Analytics,ControlsViewInputs,viewHelpers,template,footerTemplate,sellecktItemEditTemplate){"use strict";function getFooterTemplate(label){if(!permissions.check("edit.queries")){return}return footerTemplate({label:label})}return ControlsViewInputs.extend({className:"combinedQueryInputs modular",events:function events(){return _.extend({"click .deselect":"onDeselectQuery","click .js-edit":"onEditQuery"},ControlsViewInputs.prototype.events.call(this))},initialize:function initialize(options){if(options){this.queryTypes=options.queryTypes;this.selectPlaceholder=options.selectPlaceholder}if(this.queryTypes&&!_(this.queryTypes).isArray()){this.queryTypes=[].concat(this.queryTypes)}this.listenTo(this.model,"change",this.updateValues);this.listenTo(this.model,"invalid",this.showValidationErrors);this.listenTo(queries,"reset change add",this.render)},updateValues:function updateValues(){var queryId=[].concat(this.model.get("queryId")||[]),$queryId=this.$("[name=queryId]");this.$(".invalid").removeClass("invalid");if(!_.isEqual($queryId.val(),queryId)){$queryId.val(queryId).change()}},render:function render(){var templateData=this.getTemplateData();var data=templateData.data;var onCreateQuery=_.bind(this.onCreateQuery,this);this.$el.html(template(data));this.querySelect=this.$('[name="queryId"]').selleckt({selectionTemplate:sellecktItemEditTemplate,placeholderText:this.selectPlaceholder||"Select a Channel",alternatePlaceholder:"Select another",unselectItemClass:"remove",enableSearch:true,showEmptyList:true,popupTemplateData:{footer:getFooterTemplate(this.getInputLabel())}});this.sellecktInstance=this.querySelect.data("selleckt");this.sellecktInstance.on("onPopupCreated",function(popup){popup.$popup.on("click",".js-create-query",function(){onCreateQuery()})});this.$el.customtip()},getTemplateData:function getTemplateData(){var self=this;var queryIds=[].concat(this.$("[name=queryId]").val()||this.model.get("queryId")||[]);var selectedQueries=_(queryIds).map(function(id){return parseInt(id,10)});var data={inputLabel:"Select "+this.getInputLabel(),queries:self.getQueryList(selectedQueries)};return{selectedQueries:selectedQueries,data:data}},getValues:function getValues(){var queryId=this.$("[name=queryId]").val();queryId=queryId&&queryId.length?queryId:null;var queryIds=_([].concat(queryId||this.model.get("queryId")||[])).chain().map(function(val){return parseInt(val,10)}).compact().value();return{queryId:queryIds}},getInputLabel:function getInputLabel(){var queryTypes=this.queryTypes?this.queryTypes:this.getDefaultQueryTypes();var queryType=queryTypes[0];var labelMap=DataSourceManager.getChannels();if(queryTypes.length>1||!labelMap[queryType]){return"Channel"}return labelMap[queryType].name+" Channel"},getQueryList:function getQueryList(selectedQueries){var queryTypes=this.queryTypes?this.queryTypes:this.getDefaultQueryTypes();return queries.chain().map(function(query){if(_(queryTypes).contains(query.get("type"))){return{id:query.id,name:query.get("name"),selected:_(selectedQueries).include(query.id)?"selected":"",isReadOnly:!permissions.check("edit.queries"),typeIconClass:viewHelpers.getIconClassGivenType(query.get("type"))}}}).compact().sortBy(function(query){return query.name.toLowerCase()}).value()},getDefaultQueryTypes:function getDefaultQueryTypes(){return DataSourceManager.getChannelsNames()},selectChanged:function selectChanged(e){var $target=$(e.target);if($target.hasClass("query")&&$target.val()&&$target.val().length){this.$(".selleckt").removeClass("invalid")}else{this.$(".selleckt").addClass("invalid")}this.trigger("querySelectionChange",this.getValues().queryId);$(".tooltip").hide();this.$el.customtip();ControlsViewInputs.prototype.selectChanged.call(this)},onDeselectQuery:function onDeselectQuery(){this.trigger("querySelectionChange",this.getValues().queryId)},remove:function remove(){if(this.sellecktInstance){this.sellecktInstance.destroy()}ControlsViewInputs.prototype.remove.call(this)},showValidationErrors:function showValidationErrors(model,errors){if(errors&&(errors.queryId||_(errors).isArray()&&_(errors).include("queryId"))){this.$(".selleckt").addClass("invalid")}},removeValidationErrors:function removeValidationErrors(){this.$(".selleckt").removeClass("invalid")},onEditQuery:function onEditQuery(event){var $target=$(event.target);var queryId=$target.closest("li[data-value]").data("value");this.editQuery(queryId)},editQuery:function editQuery(queryId){var queryModel=queries.get(queryId);QueryFormManager.showEditQueryForm({query:queryModel,project:currentProject,withinDashboard:true});Analytics.trackEvent({name:"Miscellaneous.QueryInputs",action:"Edit_Query",origin:"Application"})},onCreateQuery:function onCreateQuery(){this.createQuery()},createQuery:function createQuery(){this.stopListening(queries,"add",this.onQueryCreated);this.listenToOnce(queries,"add",this.onQueryCreated);QueryFormManager.showCreateQueryForm({project:currentProject,userData:Workbench.userData,allowedQueryTypes:this._getAllowedQueryTypes()});Analytics.trackEvent({name:"Miscellaneous.QueryInputs",action:"Add_Query",origin:"Application"})},onQueryCreated:function onQueryCreated(model){this.render();this.selectQuery(model.id)},selectQuery:function selectQuery(queryId){var querySelect=this.querySelect;var selection=[queryId].concat(querySelect.val());querySelect.val(selection).trigger("change")},_getAllowedQueryTypes:function _getAllowedQueryTypes(){var types=[].concat(this.queryTypes||this.getDefaultQueryTypes());return types.length?types:undefined}})});define("src/components/historycomparison/models/DateRange",["backbone","underscore","moment","src/globals/currentDashboard","bw-fe-helpers/dateHelper","bw-fe-helpers/timezoneDateHelper"],function(Backbone,_,moment,currentDashboard,dateHelper,timezoneDateHelper){"use strict";var URL_TEMPLATE="/projects/{projectId}/queries/{queryId}/date-range/{dateRangeId}";var DATES_SYNC_FORMAT="YYYY-MM-DDTHH:mm:ss.SSSZ";return Backbone.Validations.Model.extend({validate:{name:{required:true},startDate:{required:true,custom:"validateDateOrDateString"},endDate:{required:true,custom:"validateDateOrDateString"},eventDate:{custom:"validateEventDate"}},validateDateOrDateString:function validateDateOrDateString(attrName,attrValue){var isDate=_.isDate(attrValue),isDateString=dateHelper.isIsoDateString(attrValue)||dateHelper.isLocaleDateString(attrValue),VALIDATION_FAIL="date";return isDate||isDateString?undefined:VALIDATION_FAIL},validateEventDate:function validateEventDate(attrName,attrValue){var eventDate=attrValue,startDate=dateHelper.parse(this.get("startDate")),endDate=dateHelper.parse(this.get("endDate"));if(!eventDate){return undefined}if(_.isString(attrValue)){eventDate=dateHelper.parse(attrValue)}if(!_.isDate(eventDate)){return"invalid"}if(eventDate<startDate||eventDate>endDate){return"outOfRange"}},url:function url(){var queryId=this.get("queryId"),dateRangeId=this.id||"";if(!queryId){throw new TypeError("Could not generate url, queryId attribute must be set")}return URL_TEMPLATE.replace("{queryId}",queryId).replace("{dateRangeId}",dateRangeId)},parse:function parse(options){var timezone=currentDashboard.getTimezone();var endDateISOString=timezoneDateHelper.replaceTimezoneOffset(options.endDate,timezone);var inclusiveEndDate=moment.tz(endDateISOString,timezone).subtract(1,"days").format(DATES_SYNC_FORMAT);options.endDate=inclusiveEndDate;options.eventDate=options.eventDate?timezoneDateHelper.replaceTimezoneOffset(options.eventDate,timezone):"";options.startDate=timezoneDateHelper.replaceTimezoneOffset(options.startDate,timezone);return options},sync:function sync(method,model,options){var timezone=currentDashboard.getTimezone();options.data=model.toJSON();options.data.startDate=moment.tz(options.data.startDate,timezone).format(DATES_SYNC_FORMAT);options.data.endDate=moment.tz(options.data.endDate,timezone).add({d:1}).format(DATES_SYNC_FORMAT);if(options.data.eventDate){options.data.eventDate=moment.tz(options.data.eventDate,timezone).format(DATES_SYNC_FORMAT)}return Backbone.sync.call(this,method,model,options)}})});define("mustache!src/components/historycomparison/templates/createEditDate",["lib/mustache"],function(mustache){var escapedTemplate='{{^deleting}}\n<h1 class="popuptitletext singlemargin-bottom draggable">{{title}}</h1>\n<form class="controls">\n<div class="errorPane notification-error rounded smallpadding-vertical singlepadding-horizontal singlemargin-bottom hidden"></div>\n<fieldset class="singlemargin-bottom">\n<p>\n<label>Date range name</label>\n<input class="validation-wrapper field" name="name" type="text" placeHolder="E.g. Product Launch" value="{{dateName}}" data-validationmessage-required="You must give the date range a name" required>\n</p>\n</fieldset>\n<fieldset class="singlemargin-bottom">\n<p>\n<label>Select a date range</label>\n<input class="validation-wrapper field" name="dateRange" type="text" class="range" placeHolder="E.g. Jan 1, {{year}} - Jan 5, {{year}}" value="{{dateValue}}" data-validationmessage-required="You must choose a valid date range" data-validationmessage-date="The date range should be in the following format: Jan 1, {{year}} - Jan 5, {{year}}">\n</p>\n</fieldset>\n<fieldset class="singlemargin-bottom">\n<p>\n<label>Select event date (optional)</label>\n<input class="validation-wrapper field" name="eventDate" type="text" class="range" placeHolder="E.g. Jan 1, {{year}}" value="{{eventDate}}" data-validationmessage-required="You must choose a valid date range" data-validationmessage-date="The date should be in the following format: Jan 1, {{year}}" data-validationmessage-range="The given date is not within the range specified above">\n<a class="help icon-bwhelp" data-key="historycomparison:history-comparison-event-date" ></a>\n</p>\n</fieldset>\n<fieldset>\n<button class="save defaultbutton">{{buttonLabel}}</button>\n<button class="cancel button singlemargin-left">Cancel</button>\n</fieldset>\n{{#dateId}}\n<fieldset class="delete singlemargin-top">\n<p>Or</p>\n<a ><span class="icon"></span>Delete this date range</a>\n</fieldset>\n{{/dateId}}\n</form>\n{{/deleting}}\n{{#deleting}}\n<h1 class="popuptitletext singlemargin-bottom draggable">{{titleDelete}}</h1>\n<div class="confirm">\nAre you sure you want to delete "{{dateName}}"?\n<p><button class="yes defaultbutton">Yes</button><button class="no button singlemargin-left">No</a></p>\n</div>\n{{/deleting}}\n<div class="overlay hidden"></div>\n';return function(data,partials,wrap){return mustache.render(escapedTemplate,data,partials,wrap)}});define("css!css/daterangepicker.css",["css!css/compiled.css"],function(){});define("src/packages/daterangepicker",["underscore","jquery","daterangepicker","css!css/daterangepicker.css"],function(_,$){"use strict";var oldFunc=$.fn.daterangepicker;$.fn.daterangepicker=function(options){return oldFunc.call(this,_.extend({closeButtonCssClass:"singlemargin-left singlemargin-right lightgrey icon-remove",doneButtonCssClass:"defaultbutton"},options))}});define("css!src/components/historycomparison/css/createEditDateView.css",["css!src/components/historycomparison/css/compiled.css"],function(){});define("src/components/historycomparison/views/CreateEditDateView",["moment-timezone","src/globals/currentDashboard","src/views/ValidatingFormView","mustache!src/components/historycomparison/templates/createEditDate","bw-fe-helpers/dateHelper","src/packages/daterangepicker","src/packages/modalDialogs","css!src/components/historycomparison/css/createEditDateView.css"],function(moment,currentDashboard,ValidatingFormView,createEditTemplate,dateHelper){"use strict";var CreateEditDateView=ValidatingFormView.extend({className:"createEditDate",events:{"click button.cancel":"onCancel","click button.save":"onSave","click fieldset.delete a":"onDeleteDate","click .confirm button.yes":"onConfirmDelete","click .confirm button.no":"onCancelDelete"},initialize:function initialize(options){options=options||{};ValidatingFormView.prototype.initialize.call(this,options);this.render();this.$('input[name="name"]').focus()},remove:function remove(){if(this.eventDatePicker){this.eventDatePicker.unbind();this.eventDatePicker.destroy()}if(this.dateRangePicker){this.dateRangePicker.unbind();this.dateRangePicker.destroy()}ValidatingFormView.prototype.remove.call(this)},onCancel:function onCancel(e){e.preventDefault();this.remove()},onSave:function onSave(e){e.preventDefault();this.save()},save:function save(){var self=this;var $dateRange=this.$("input[name=dateRange]");var name=this.$("input[name=name]").val().trim();var eventDateStr=this.$("input[name=eventDate]").val();var model=this.model;var dateRange;var startDate;var endDate;var eventDate;var parsedEventDate;var timezone=currentDashboard.getTimezone();try{dateRange=dateHelper.parseDateRange($dateRange.val(),timezone);parsedEventDate=eventDateStr?dateHelper.parse(eventDateStr,timezone):undefined}catch(e){}if(dateRange&&dateRange.start){startDate=moment.tz(dateRange.start,timezone).toISOString()}if(dateRange&&dateRange.end){endDate=moment.tz(dateRange.end,timezone).toISOString()}if(parsedEventDate){eventDate=moment.tz(parsedEventDate,timezone).toISOString()}if(eventDateStr&&!eventDate){return this.showInputValidation(this.$('[name="eventDate"]'),{eventDate:"date"})}if(eventDate&&(startDate>eventDate||eventDate>endDate)){return this.onModelError(model,{eventDate:"range"})}this.updateSavingMode(true);this.model.save({name:name,startDate:startDate,endDate:endDate,eventDate:eventDate},{success:function success(){self.trigger("success");self.remove()},error:function error(model,response){self.updateSavingMode(false);self.onServerError(model,response)}});if(this.model.validationError){self.updateSavingMode(false)}},updateSavingMode:function updateSavingMode(saving){var button=this.$("button.save"),overlay=this.$(".overlay");if(saving){overlay.removeClass("hidden");button.data("original-text",button.html()).prop("disabled",true).html("Saving...")}else{overlay.addClass("hidden");button.prop("disabled",false).html(button.data("original-text"))}},onModelError:function onModelError(model,response){var errors=response;ValidatingFormView.prototype.onModelError.apply(this,arguments);if(response.startDate||response.endDate){errors.dateRange=response.startDate||response.endDate;this.showInputValidation(this.$('[name="dateRange"]'),errors)}},onDeleteDate:function onDeleteDate(){this.deleteDate()},deleteDate:function deleteDate(){this.render({deleting:true})},onConfirmDelete:function onConfirmDelete(){this.confirmDelete()},confirmDelete:function confirmDelete(){var self=this;this.updateSavingMode(true);this.model.destroy({success:function success(){self.trigger("success");self.remove()},error:function error(model,response){this.updateSavingMode(false);self.onServerError(model,response)}})},onCancelDelete:function onCancelDelete(){this.render()},updateClassName:function updateClassName(deleting){if(deleting){this.$el.attr("class",this.className+" deleting")}else if(this.model.id){this.$el.attr("class",this.className+" editing")}},setDateRangePicker:function setDateRangePicker(deleting,startDate,endDate,eventDate){var timezone=currentDashboard.getTimezone();var dateFormatter=function dateFormatter(startDate,endDate){return startDate.format("MMM DD, YYYY")+" - "+endDate.format("MMM DD, YYYY")};var singleDateFormatter=function singleDateFormatter(date){return date.format("MMM DD, YYYY")};var zIndex=10010;if(!deleting){this.dateRangePicker=this.$('[name="dateRange"]').daterangepicker({startDate:startDate,endDate:endDate,dateFormatter:dateFormatter,zIndex:zIndex,timezone:timezone}).data("picker");this.eventDatePicker=this.$("[name=eventDate]").daterangepicker({startDate:eventDate,dateFormatter:singleDateFormatter,zIndex:zIndex,singleDate:true,timezone:timezone}).data("picker")}},appendTemplate:function appendTemplate(deleting,startDate,endDate,eventDate){var timezone=currentDashboard.getTimezone();this.$el.html(createEditTemplate({deleting:!!deleting,dateId:this.model.id||"",dateName:this.model.get("name"),dateValue:startDate&&endDate?dateHelper.makeDateRange(startDate,endDate,{timezone:timezone}):"",eventDate:eventDate?dateHelper.format(eventDate,"MMM DD, YYYY",{timezone:timezone}):"",title:this.model.id?"Edit or Delete Custom Date Range":"Create Custom Date Range",titleDelete:this.model.id?"Delete "+this.model.get("name"):"",buttonLabel:this.model.id?"Update Date Range":"Create Date Range",year:(new Date).getFullYear()}))},render:function render(options){var startDate=this.model.get("startDate"),endDate=this.model.get("endDate"),eventDate=this.model.get("eventDate");options=options||{};this.updateClassName(options.deleting);this.appendTemplate(options.deleting,startDate,endDate,eventDate);this.setDateRangePicker(options.deleting,startDate,endDate,eventDate);return this}},{show:function show(options){var model=options.model,settings=options.model.settings,popup=new CreateEditDateView({settings:settings,model:model}),remove;popup.render();popup.$el.showModal({draggable:".createEditDate > h1:first",className:"popup smallpopup",onClose:function onClose(){popup.trigger("close");popup.remove()}});remove=popup.remove;popup.remove=function(){this.$el.removeModal();remove.call(this)};return popup}});return CreateEditDateView});define("src/components/historycomparison/models/DateRangeCollection",["backbone","underscore","src/globals/queries","src/components/historycomparison/models/DateRange"],function(Backbone,_,queries,DateRange){"use strict";var URL_TEMPLATE="/projects/{projectId}/queries/{queryId}/date-range/",dateRangeCache={};queries.on("reset",function(){dateRangeCache={}});queries.on("remove",function(query){if(dateRangeCache[query.id]){delete dateRangeCache[query.id]}});return Backbone.Collection.extend({model:DateRange,initialize:function initialize(models,options){options=options||{};this.id=options.id},comparator:function comparator(model){return(model.get("name")||"").toLowerCase()},url:function url(){var queryId=this.id;if(!queryId){throw new Error("Could not generate url, id option must be set")}return URL_TEMPLATE.replace("{queryId}",queryId)},fetch:function fetch(options){var self=this;if(this.fetched){return _.defer(function(){options.success.call(undefined,self,{},options)})}this.fetched=true;Backbone.Collection.prototype.fetch.apply(this,arguments)}},{forQuery:function forQuery(queryId){var DateRangeCollection=this;return dateRangeCache[queryId]||(dateRangeCache[queryId]=new DateRangeCollection([],{id:queryId}))}})});define("mustache!src/components/historycomparison/templates/historyComparisonControlsViewQueryAndDateInput",["lib/mustache"],function(mustache){var escapedTemplate='<div class="query inputWrapper relative smallmargin-top">\n<label class="dib smallpadding-vertical">Date Range</label>\n{{#canRemoveQuery}}\n\x3c!--a class="remove" title="Remove Query / Channel">Remove Query / Channel</a--\x3e\n<a class="remove absright iconsmaller icon-remove hugeline grey smallpadding-left customtip" title="Remove Query / Channel"></a>\n{{/canRemoveQuery}}\n<div>\n{{#canChangeQuery}}\n<select class="query" name="queries">\n<option value></option>\n{{#allQueries}}\n<option value="{{id}}" {{#typeIconClass}}data-typeiconclass="{{typeIconClass}}"{{/typeIconClass}} {{selected}}>{{name}}</option>\n{{/allQueries}}\n</select>\n{{/canChangeQuery}}\n\n{{^canChangeQuery}}\n<input class="query field" name="queries" type="text" value="{{queryName}}" readonly>\n<input type="hidden" name="queryId" value="{{queryId}}">\n{{/canChangeQuery}}\n</div>\n<select name="dates" class="date smallmargin-top selectfield" {{dateDisabled}} data-queryid="{{queryId}}">\n<option value="">Select Date</option>\n{{#canCreateDateRange}}\n<option value disabled>--------------------</option>\n<option value="newDateRange">+ New date range</option>\n<option value disabled>--------------------</option>\n{{/canCreateDateRange}}\n{{#dateRanges}}\n<option value="{{value}}" class="date" {{selected}} {{disabled}}>{{name}}</option>\n{{/dateRanges}}\n</select>\n{{#renderEditDateLink}}\n\x3c!--p class="date edit"><a data-id="{{dateId}}" {{^showEditDateLink}}class="hidden"{{/showEditDateLink}} data-queryid="{{queryId}}" title="Edit or delete this date range">edit</a></p--\x3e\n<a data-id="{{dateId}}" class="date edit icon-pencil grey smallpadding-left customtip {{^showEditDateLink}}hidden{{/showEditDateLink}}" data-queryid="{{queryId}}" title="Edit or delete this date range"></a>\n{{/renderEditDateLink}}\n</div>\n';return function(data,partials,wrap){return mustache.render(escapedTemplate,data,partials,wrap)}});define("text!templates/queryselection/querySelectorItemsPopup.template",[],function(){return'<div class="{{itemsClass}} keepMinWidth lightshadow">\n    <ul class="{{itemslistClass}}">\n        {{#items}}\n        <li class="{{itemClass}} smallpadding relative db textellipsis ellipsistooltip customtip" title="{{label}}" data-text="{{label}}" data-value="{{value}}">\n            {{#data.typeiconclass}}\n            <span class="{{className}}__icon {{data.typeiconclass}}"></span>\n            {{/data.typeiconclass}}\n            <span class="{{itemTextClass}}">{{label}}</span>\n        </li>\n        {{/items}}\n        {{^items}}\n        <li class="empty smallpadding relative db textellipsis">\n            <span class="{{itemTextClass}} lightgrey">No items</span>\n        </li>\n        {{/items}}\n    </ul>\n    {{#showFooter}}\n    <footer class="footer smallpadding relative db">\n        <a class="js-add-query"><span class="iconsmaller icon-plus smallpadding-right"></span>New Query / Channel</a>\n    </footer>\n    {{/showFooter}}\n</div>\n'});define("text!src/components/historycomparison/templates/historyComparisonQuerySelectorMain.template",[],function(){return'<div class="{{className}}" tabindex=1>\n    <div class="{{selectedClass}} js-query-selector-trigger rounded darkgrey smallpadding-horizontal relative">\n        <span class="{{selectedTextClass}} dib doublepadding-right fullwidth textellipsis">{{selectedItemText}}</span><i class="icon-chevron-down rounded linkblue absright hugeline smallmargin-right"></i>\n    </div>\n    {{#canEditQuery}}\n    <a class="js-edit smallpadding-left icon-pencil grey customtip"></a>\n    {{/canEditQuery}}\n    {{^canEditQuery}}\n    <i class="action-icon readonly icon-lock grey customtip" title="Contact your admin for access"></i>\n    {{/canEditQuery}}\n</div>\n'});define("css!src/components/historycomparison/css/historyComparisonComponent.css",["css!src/components/historycomparison/css/compiled.css"],function(){});define("src/components/historycomparison/views/HistoryComparisonControlsViewQueryAndDateInput",["backbone","underscore","jquery","src/permissions","src/globals/queries","src/globals/currentProject","src/controls/lib/viewHelpers","src/QueryFormManager","src/analytics/Analytics","src/components/historycomparison/models/DateRange","src/components/historycomparison/views/CreateEditDateView","src/components/historycomparison/models/DateRangeCollection","mustache!src/components/historycomparison/templates/historyComparisonControlsViewQueryAndDateInput","text!templates/queryselection/querySelectorItemsPopup.template","text!src/components/historycomparison/templates/historyComparisonQuerySelectorMain.template","src/packages/selleckt","src/packages/customtip","css!src/components/historycomparison/css/historyComparisonComponent.css"],function(Backbone,_,$,permissions,queries,currentProject,viewHelpers,QueryFormManager,Analytics,DateRange,CreateEditDateView,DateRangeCollection,historyComparisonControlsViewQueryAndDateInput,querySelectorItemsPopup,historyComparisonQuerySelectorMainTemplate){"use strict";var DATE_RANGE_SELECTED="dateRangeSelected",DATE_RANGE_UNSELECTED="dateRangeUnSelected";function formatDateRangesForTemplate(queryId,selectedDateId,selectedDates){var dates=DateRangeCollection.forQuery(queryId)||[];return dates.map(function(dateRange){var selected=selectedDateId===dateRange.id;return{name:dateRange.get("name"),value:dateRange.id,selected:selected?"selected":"",disabled:!selected&&selectedDates.indexOf(dateRange.id)>-1?"disabled":"",separator:", "}})}function getProjectQueries(selectedQueryId){selectedQueryId=parseInt(selectedQueryId,10);return _(queries.toJSON()).chain().sortBy(function(query){return query.name.toLowerCase()}).map(function(q){var id=parseInt(q.id,10);return{id:id,name:q.name,selected:id===selectedQueryId?"selected":"",typeIconClass:viewHelpers.getIconClassGivenType(q.type)}}).value()}function handleDateRangeSelected(view,dateRangeId){var option=view.$el.find("option[value="+dateRangeId+"]");if(!option.prop("selected")){option.prop("disabled",true)}}function handleDateRangeUnSelected(view,dateRangeId){var option=view.$el.find("option[value="+dateRangeId+"]");option.prop("disabled",false)}function makeSelectedDateRangeAvailable(view){if(!view.dateId){return}if(view.model.has("queries")){view.model.get("queries").forEach(function(modelQuery){if(modelQuery.dateId===view.dateId){delete modelQuery.dateId}})}view._mediator.trigger(DATE_RANGE_UNSELECTED,view.dateId)}return Backbone.View.extend({events:{"change select[name=dates]":"onDateChanged","change select[name=queries]":"onQueryChanged","click .remove":"onClickRemove","click .date.edit":"onClickEditDate","click .js-edit":"onEditQuery"},constructor:function HistoryComparisonControlsViewQueryAndDateInput(options,mediator){Backbone.View.apply(this,arguments);if(!options||!options.dashboard){throw new Error("options.dashboard must be set!")}if(!this.model){throw new Error("options.model must be set!")}if(!mediator){throw new TypeError("missing mediator argument")}this.listenTo(queries,"add",this.render);this.dashboard=options.dashboard;this.dateId=options.dateId;this.queryId=options.queryId;this.queryName=options.queryName;this.bindDates();this.listenTo(mediator,DATE_RANGE_SELECTED,_.partial(handleDateRangeSelected,this));this.listenTo(mediator,DATE_RANGE_UNSELECTED,_.partial(handleDateRangeUnSelected,this));this._mediator=mediator},remove:function remove(){makeSelectedDateRangeAvailable(this);this.closeCreateEditDateView();this.unbindDates();if(this.sellecktInstance){this.sellecktInstance.destroy()}Backbone.View.prototype.remove.call(this)},bindDates:function bindDates(){var dates=DateRangeCollection.forQuery(this.queryId);dates.on("reset add change",this.render,this);dates.on("remove",this.onQueryDateRemoved,this)},unbindDates:function unbindDates(){var dates=DateRangeCollection.forQuery(this.queryId);dates.off("reset add change",this.render,this);dates.off("remove",this.onQueryDateRemoved,this)},onQueryDateRemoved:function onQueryDateRemoved(model){var id=model.id;if(this.dateId===id){this.dateId=undefined}this.render()},render:function render(){var data=this.getTemplateData(),onAddQuery=_.bind(this.onAddQuery,this);this.$el.html(historyComparisonControlsViewQueryAndDateInput(data,true));if(permissions.check("edit.historyComparison.controls.query",this.dashboard)){this.querySelect=this.$("select.query").selleckt({placeholderText:"Select Query/Channel",mainTemplate:historyComparisonQuerySelectorMainTemplate,mainTemplateData:{canEditQuery:permissions.check("edit.queries",this.dashboard)},popupTemplate:querySelectorItemsPopup,popupTemplateData:{showFooter:permissions.check("edit.queries")}});this.sellecktInstance=this.querySelect.data("selleckt");this.sellecktInstance.on("onPopupCreated",function(popup){popup.$popup.on("click",".js-add-query",function(){onAddQuery()})});this.setupQueryEditing()}this.$el.customtip()},setupQueryEditing:function setupQueryEditing(){var $link=this.$("a.js-edit"),toggleEditing=function toggleEditing(){var $this=$(this),queryId=$this.val(),queryName=$(this).find(":selected").text();if(queryId){$link.addClass("active").data("queryid",queryId).attr("title",'Edit "'+queryName+'"')}else{$link.removeClass("active").removeData("queryid").removeAttr("title")}};this.querySelect.change(toggleEditing);toggleEditing.call(this.querySelect)},showValidationErrors:function showValidationErrors(errors){var self=this;_(errors).each(function(err){self.$("[name="+err+"]").addClass("invalid");if(err==="queries"){self.$(".query .selleckt").addClass("invalid")}})},onQueryChanged:function onQueryChanged(e){var $target=$(e.target),queryId=$target.val();this.$(".query .selleckt").toggleClass("invalid",!!queryId);this.unbindDates();this.queryId=parseInt(queryId,10)||undefined;this.queryName=this.queryId?queries.get(queryId).get("name"):undefined;this.bindDates();makeSelectedDateRangeAvailable(this);delete this.dateId;this.render();this.fetchDatesIfNecessary()},onDateChanged:function onDateChanged(e){var self=this,$target=$(e.target),queryId=this.queryId,value=$target.val(),editLink=this.$(".date.edit");$target.removeClass("invalid");editLink.addClass("hidden");if(this.dateId&&String(this.dateId)!==value){this._mediator.trigger(DATE_RANGE_UNSELECTED,this.dateId)}if(value==="newDateRange"){if(!queryId){return this.showValidationErrors(["queries"])}this.openCreateEditDateView(new DateRange({queryId:queryId}));this.createEditDateView.on("success",function(){DateRangeCollection.forQuery(queryId).add(self.createEditDateView.model)})}else{this.dateId=parseInt(value,10)||undefined;if(this.dateId){editLink.removeClass("hidden");editLink.data("id",this.dateId);this._mediator.trigger(DATE_RANGE_SELECTED,this.dateId)}}},onClickRemove:function onClickRemove(){this.trigger("removed",this);this.remove()},onClickEditDate:function onClickEditDate(e){var $target=$(e.target),dateId=$target.data("id"),queryId=$target.data("queryid");this.openCreateEditDateView(DateRangeCollection.forQuery(queryId).get(dateId))},openCreateEditDateView:function openCreateEditDateView(model){this.closeCreateEditDateView();this.createEditDateView=CreateEditDateView.show({model:model});this.createEditDateView.on("close",this.closeCreateEditDateView,this)},closeCreateEditDateView:function closeCreateEditDateView(){if(!this.createEditDateView){return}this.createEditDateView.off("success");this.createEditDateView.off("close",this.closeCreateEditDateView);this.createEditDateView.remove();delete this.createEditDateView},fetchDatesIfNecessary:function fetchDatesIfNecessary(){if(!this.queryId){return}var dates=DateRangeCollection.forQuery(this.queryId),$dates=this.$("select[name=dates]");if(!dates.length){$dates.prop("disabled",true);dates.fetch({success:function success(){$dates.prop("disabled",false)}})}},getTemplateData:function getTemplateData(){var queryId=this.queryId,dateId=this.dateId,selectedDates=_(this.model.get("queries")||[]).pluck("dateId"),dateRanges=formatDateRangesForTemplate(queryId,dateId,selectedDates)||[],renderEditDateLink=permissions.check("see.historyComparison.controls.editDateRange",this.dashboard),showEditDateLink=dateId!==undefined;return{queryId:this.queryId,queryName:this.queryName,dateId:this.dateId,canCreateDateRange:permissions.check("see.historyComparison.controls.createDateRange",this.dashboard),canRemoveQuery:permissions.check("see.historyComparison.controls.removeQuery",this.dashboard),canChangeQuery:permissions.check("edit.historyComparison.controls.query",this.dashboard),renderEditDateLink:renderEditDateLink?_.extend({queryId:queryId},renderEditDateLink):false,showEditDateLink:showEditDateLink,allQueries:getProjectQueries(queryId),dateRanges:dateRanges}},getValues:function getValues(){return{queryId:this.queryId,queryName:this.$("select.query option[selected]").text(),dateId:this.dateId}},onEditQuery:function onEditQuery(e){e.stopPropagation();var $target=$(e.target),queryId=$target.data("queryid");this.editQuery(queryId)},editQuery:function editQuery(queryId){var queryModel=queries.get(queryId);QueryFormManager.showEditQueryForm({query:queryModel,project:currentProject,withinDashboard:true});Analytics.trackEvent({name:"Miscellaneous.QueryInputs",action:"Edit_Query",origin:"Application"})},onAddQuery:function onAddQuery(){this.addQuery()},addQuery:function addQuery(){this.stopListening(queries,"add",this.onQueryCreated);this.listenToOnce(queries,"add",this.onQueryCreated);QueryFormManager.showCreateQueryForm({project:currentProject});Analytics.trackEvent({name:"Miscellaneous.QueryInputs",action:"Add_Query",origin:"Application"})},onQueryCreated:function onQueryCreated(model){this.render();this.selectQuery(model.id)},selectQuery:function selectQuery(queryId){this.querySelect.val(queryId).trigger("change")}})});define("mustache!src/components/historycomparison/templates/historyComparisonQueryInputs",["lib/mustache"],function(mustache){var escapedTemplate='<label class="db">Compare different Date Ranges</label>\n<div class="queries smallpadding-bottom singlemargin-bottom">\n</div>\n{{#canAddQuery}}\n<a class="addQuery dib singlemargin-bottom"><span class="icon-plus smallpadding-right grey"></span>Add another Date Range</a>\n{{/canAddQuery}}\n';return function(data,partials,wrap){return mustache.render(escapedTemplate,data,partials,wrap)}});define("src/components/historycomparison/views/HistoryComparisonControlsViewQueryInputs",["backbone","underscore","src/permissions","src/globals/queries","src/components/historycomparison/views/HistoryComparisonControlsViewQueryAndDateInput","src/controls/views/ControlsViewQueryInputs","mustache!src/components/historycomparison/templates/historyComparisonQueryInputs"],function(Backbone,_,permissions,queries,ControlsViewQueryAndDateInput,ControlsViewQueryInputs,historyQueryInputsTemplate){"use strict";return ControlsViewQueryInputs.extend({events:function events(){return _.extend(ControlsViewQueryInputs.prototype.events.call(this),{"click a.addQuery":"addQuery"})},createEditDateView:null,constructor:function HistoryComparisonControlsViewQueryInputs(options){ControlsViewQueryInputs.apply(this,arguments);this.listenTo(this.model,"invalid",this.showValidationErrors);this.listenTo(queries,"change",this.render);this.dashboard=options.dashboard;this.views=[];this._mediator=_.clone(Backbone.Events)},remove:function remove(){_(this.views).each(function(view){view.remove()});this.views=[];ControlsViewQueryInputs.prototype.remove.call(this)},showValidationErrors:function showValidationErrors(model,errors){var views=this.views;this.hasValidationErrors=true;_(errors).each(function(key){var index;if(key.indexOf("query")===0){index=key.length>5?key.slice(5):0;views[index].showValidationErrors(["queries"])}else if(key.indexOf("date")===0){index=key.length>4?key.slice(4):0;views[index].showValidationErrors(["dates"])}})},addQuery:function addQuery(){var viewOptions={dashboard:this.dashboard,model:this.model},view=new ControlsViewQueryAndDateInput(viewOptions,this._mediator);this.views.push(view);view.on("removed",this.removeQuery,this);this.$(".queries").append(view.el);view.render();this.model.set(this.getValues())},removeQuery:function removeQuery(view){var index=this.views.indexOf(view);this.views.splice(index,1);if(this.views.length===0){this.addQuery()}else{this.model.set(this.getValues())}},getValues:function getValues(){return{queries:_(this.views).map(function(view){return view.getValues()})}},render:function render(){var self=this,modelData=this.model.toJSON(),$container,views=this.views;if(this.$el.is(":empty")){this.$el.html(historyQueryInputsTemplate({canAddQuery:permissions.check("see.historyComparison.controls.addQuery",this.dashboard)},true))}$container=this.$(".queries");modelData.queries=_(modelData.queries).filter(function(query){return queries.get(query.queryId)});_(modelData.queries.length?modelData.queries:[{}]).each(function(dateQuery,i){var viewOptions={dashboard:self.dashboard,model:self.model,queryId:dateQuery.queryId,dateId:dateQuery.dateId,queryName:dateQuery.queryName};if(views[i]){views[i].queryId=viewOptions.queryId;views[i].dateId=viewOptions.dateId;views[i].queryName=viewOptions.queryName}else{views[i]=new ControlsViewQueryAndDateInput(viewOptions,self._mediator);views[i].on("removed",self.removeQuery,self);$container.append(views[i].el)}views[i].render()});if(this.hasValidationErrors){this.hasValidationErrors=!this.model.validate.call(this.model,this.getValues(),{})}}})});define("mustache!src/controls/templates/combinedQueryInputs",["lib/mustache"],function(mustache){var escapedTemplate='<a class="help icon-bwhelp" data-type="query" data-key="multiple-query-select-input" tabindex="-1"></a>\n<a class="help icon-bwhelp" data-type="queryGroup" data-key="filters-query-group" tabindex="-1"></a>\n<ul class="tabs">\n<li data-type="query"><a tabindex="-1">Data</a></li>\n<li data-type="queryGroup"><a tabindex="-1">Group</a></li>\n</ul>\n<div class="panes smallmargin-bottom">\n<fieldset class="query tab hidden"></fieldset>\n<fieldset class="queryGroup tab hidden"></fieldset>\n</div>\n';return function(data,partials,wrap){return mustache.render(escapedTemplate,data,partials,wrap)}});define("css!src/controls/css/combinedQueryInputs.css",["css!src/controls/css/compiled.css"],function(){});define("src/controls/views/ControlsViewCombinedQueryInputs",["underscore","jquery","src/controls/views/ControlsViewInputs","src/controls/views/QueryInputs","src/controls/views/QueryGroupInputs","mustache!src/controls/templates/combinedQueryInputs","css!src/controls/css/combinedQueryInputs.css","customtip"],function(_,$,ControlsViewInputs,QueryInputs,QueryGroupInputs,combinedQueryInputsTemplate){"use strict";return ControlsViewInputs.extend({className:"combinedQueryInputs modular singlepadding-horizontal singlepadding-top",events:function events(){return _.extend({"click ul.tabs li":"onClickTab","click .query .js-edit":"onEditQuery","click .js-create-query":"onCreateQuery"},ControlsViewInputs.prototype.events.call())},constructor:function ControlsViewCombinedQueryInputs(options){ControlsViewInputs.apply(this,arguments);if(!options||!options.queries){throw new TypeError("options.queries must be set")}if(!options.queryGroups){throw new TypeError("options.queryGroups must be set")}if(!options||!options.hasOwnProperty("canEditQueries")){throw new TypeError("options.canEditQueries must be supplied")}this.queries=options.queries;this.queryGroups=options.queryGroups;this.listenTo(this.model,"change",this.updateValues);this.listenTo(this.model,"invalid",this.showErrors);this.isEnabled="isEnabled"in options?options.isEnabled:true;this.queryInputs=new QueryInputs({model:this.model,queries:options.queries,isEnabled:this.isEnabled,inputLabel:options.inputLabel,selectPlaceholder:options.selectPlaceholder,allowedQueryTypes:options.allowedQueryTypes,canEditQueries:options.canEditQueries,queryColourOptions:options.queryColourOptions});this.queryGroupInputs=new QueryGroupInputs({model:this.model,queryGroups:options.queryGroups,isEnabled:this.isEnabled,showLabel:false,showHelpKey:false,canSelectMultiple:options.canSelectMultipleQueryGroups,canEditQueries:options.canEditQueries})},remove:function remove(){this.queryInputs.remove();this.queryGroupInputs.remove();ControlsViewInputs.prototype.remove.call(this)},updateValues:function updateValues(){var currentMode=this.model.get("currentMode");this.showTab(currentMode)},render:function render(){if(!this.isEnabled){this.$el.empty();return}var selectedQueryGroupId=this.$("[name=queryGroupId]").val()||this.model.get("queryGroupId"),currentMode=this.model.get("currentMode")||(selectedQueryGroupId?"queryGroup":"query");if(this.$(".panes .query").length){currentMode=this.$(".panes .query").hasClass("hidden")?"queryGroup":"query"}this.queryInputs.$el.detach();this.queryGroupInputs.$el.detach();this.$el.html(combinedQueryInputsTemplate());this.queryInputs.render();this.$(".query").append(this.queryInputs.el);this.queryGroupInputs.render();this.$(".queryGroup").append(this.queryGroupInputs.el);this.toggleHelp(currentMode);this.showTab(currentMode);this.$el.customtip()},onClickTab:function onClickTab(e){e.preventDefault();var $target=$(e.target).closest("li"),newMode=$target.data("type")==="query"?"query":"queryGroup";this.showTab(newMode);this.model.set(_.extend(this.getValues(),{currentMode:newMode}));if(this.model.validationError&&this.model.validationError.length){this.$("."+newMode+" .selleckt").addClass("invalid")}else{this.$("."+newMode+" .selleckt").removeClass("invalid")}this.toggleHelp(newMode)},showTab:function showTab(type){type=type||"query";this.$("ul.tabs li").each(function(i,el){var $el=$(el),$a=$el.find("a");$a.toggleClass("current active",$el.data("type")===type)});this.$("div.panes fieldset").each(function(i,el){var $el=$(el);$el.toggleClass("hidden",!$el.hasClass(type))})},toggleHelp:function toggleHelp(currentMode){this.$(".help").hide().filter("[data-type="+currentMode+"]").show()},getValues:function getValues(){if(!this.isEnabled){return{currentMode:this.model.get("currentMode"),queryId:this.model.get("queryId")||[],queryName:"",queryGroupId:this.model.get("queryGroupId")||""}}var currentMode=this.$("ul.tabs li a.current").parent().data("type"),query=this.queryInputs.getValues(),queryGroupId=this.queryGroupInputs.getValues().queryGroupId;return{currentMode:currentMode,queryId:query.queryId,queryName:"",queryGroupId:queryGroupId}},selectChanged:function selectChanged(e){var $target=$(e.target);var currentMode=this.model.get("currentMode");var isQueryOrGroupSelect=$target.hasClass("query")||$target.hasClass("queryGroup");if(isQueryOrGroupSelect){if($target.val()&&$target.val().length){this.$("."+currentMode+" .selleckt").removeClass("invalid")}else{this.$("."+currentMode+" .selleckt").addClass("invalid")}}$(".tooltip").hide();this.$el.customtip();ControlsViewInputs.prototype.selectChanged.call(this)}})});function _typeof(obj){if(typeof Symbol==="function"&&typeof Symbol.iterator==="symbol"){_typeof=function _typeof(obj){return typeof obj}}else{_typeof=function _typeof(obj){return obj&&typeof Symbol==="function"&&obj.constructor===Symbol&&obj!==Symbol.prototype?"symbol":typeof obj}}return _typeof(obj)}define("src/helpers/componentSettingsHelper",["backbone","src/globals/queries","src/DataSourceManager","src/components/channelsanalytics/views/MultipleChannelInputs","src/components/historycomparison/views/HistoryComparisonControlsViewQueryInputs","src/controls/views/ControlsViewCombinedQueryInputs","src/controls/views/ControlsViewQueryInputs","src/controls/views/QueryGroupInputs"],function(Backbone,queries,DataSourceManager,MultipleChannelInputs,HistoryComparisonControlsViewQueryInputs,ControlsViewCombinedQueryInputs,ControlsViewQueryInputs,QueryGroupInputs){"use strict";function getAllowMultipleSelection(Component){if(Component.ControlsViewClass===Backbone.View){return true}switch(Component.ControlsViewClass.QueryInputsClass){case ControlsViewCombinedQueryInputs:case MultipleChannelInputs:return true;case ControlsViewQueryInputs:return Component.ControlsViewClass.allowMultipleSelection}}function getAllowedQueryTypes(Component){if(Component.ControlsViewClass===Backbone.View){return null}switch(Component.ControlsViewClass.QueryInputsClass){case ControlsViewQueryInputs:case ControlsViewCombinedQueryInputs:return Component.ControlsViewClass.allowedQueryTypes;case MultipleChannelInputs:return Component.ControlsViewClass.allowedQueryTypes||DataSourceManager.getChannelsNames()}}function logUnknownQueryInputClassError(ControlsViewClass){console.error("Unknown QueryInputsClass: please update this helper to make the filters work");console.error("ControlsViewClass is:",ControlsViewClass);console.error("QueryInputsClass is:",ControlsViewClass.QueryInputsClass)}function getFilteredQueryIdSettings(Component){var settings=arguments.length>1&&arguments[1]!==undefined?arguments[1]:{};var newSettings=Object.assign({},settings);var validQueryInputs=[ControlsViewQueryInputs,ControlsViewCombinedQueryInputs,MultipleChannelInputs];var knownQueryInputs=validQueryInputs.concat([HistoryComparisonControlsViewQueryInputs,QueryGroupInputs]);var newQueryId;if(!Component.ControlsViewClass){delete settings.queryId;return settings}if(Component.ControlsViewClass!==Backbone.View){if(!validQueryInputs.includes(Component.ControlsViewClass.QueryInputsClass)){if(!knownQueryInputs.includes(Component.ControlsViewClass.QueryInputsClass)){logUnknownQueryInputClassError(Component.ControlsViewClass)}delete settings.queryId;return settings}}var allowedQueryTypes=getAllowedQueryTypes(Component);var allowMultipleSelection=getAllowMultipleSelection(Component);newQueryId=queries.getAllowedQueryIds(settings.queryId,allowedQueryTypes);if(!allowMultipleSelection&&newQueryId){switch(newQueryId.length){case 1:newQueryId=newQueryId[0];break;default:newQueryId=null}}newSettings.queryId=newQueryId;return newSettings}function getLockedSettings(Component){var settings=arguments.length>1&&arguments[1]!==undefined?arguments[1]:{};if(_typeof(Component.LOCKED_SETTINGS)==="object"){return Object.assign({},settings,Component.LOCKED_SETTINGS)}return settings}function getCorrectedSettings(Component){var settings=arguments.length>1&&arguments[1]!==undefined?arguments[1]:{};var filteredQueryIdSettings=getFilteredQueryIdSettings(Component,settings);var lockedSettings=getLockedSettings(Component,filteredQueryIdSettings);return Object.assign({},settings,lockedSettings)}return{getCorrectedSettings:getCorrectedSettings}});define("src/helpers/componentsHelper",["underscore","src/globals/categories","src/globals/tags","src/globals/flags","src/globals/flagNames"],function(_,categories,tags,flags,FLAG_NAMES){"use strict";function generateSortBy(dimension){return function(data){if(dimension==="categories"){return categories.getCategoryOrdering(data.id)}if(dimension==="tags"){return tags.getTagOrdering(data.id)}if(dimension==="mozRank"){return parseInt(data.id,10)}return data.name.toString().toLowerCase()}}function isDisabledByFeatureToggle(type){var enableComponentFlag="ENABLE_"+type.toUpperCase()+"_COMPONENT";var isFlaggedEnabledDefined=!_.isUndefined(FLAG_NAMES[enableComponentFlag]);if(isFlaggedEnabledDefined){return!flags.variation(FLAG_NAMES[enableComponentFlag])}return false}return{generateSortBy:generateSortBy,isDisabledByFeatureToggle:isDisabledByFeatureToggle}});define("src/componentBuilder",["src/componentDefinitions","src/helpers/componentSettingsHelper","src/helpers/componentsHelper","src/globals/flags","src/globals/flagNames","src/helpers/componentsMappingHelper"],function(componentDefinitions,componentSettingsHelper,componentsHelper,flags,FLAGS){"use strict";function getComponentConfiguration(spec){var definition=componentDefinitions.getDefinition(spec.type);var isDisabled=componentsHelper.isDisabledByFeatureToggle(spec.type);return{spec:spec,isDisabled:isDisabled,definition:definition}}function getFilteredSpec(Component,spec){var newSpec=Object.assign({},spec);newSpec.settings=componentSettingsHelper.getCorrectedSettings(Component,spec.settings);return newSpec}function build(spec,fn){var config=getComponentConfiguration(spec);if(!config.definition){console.warn("Couldn't find a",config.spec.type,"component");config.definition={src:"src/components/disabled/DisabledComponent",name:"Disabled"}}if(config.isDisabled){config.definition={src:"src/components/disabled/TemporarilyDeactivatedComponent",name:"TemporarilyDeactivated"}}if(!flags.variation(FLAGS.ENABLE_YOUTUBEANALYTICS_COMPONENT)&&config.spec.type==="youtubeanalytics"){config.definition={title:"YouTube Analytics",src:"src/components/disabled/DisabledYouTubeAnalyticsComponent"}}config.spec.componentName=config.definition.componentName;config.spec.isPrototype=config.definition.isPrototype;config.spec.isBeta=config.definition.isBeta;require([config.definition.src],function(Component){var filteredSpec=getFilteredSpec(Component,config.spec);var obj=new Component(filteredSpec);setTimeout(function(){return fn(null,obj)},1)})}return{build:build}});define("src/views/ComponentPickerView",["backbone","src/ReactAppLoader","src/globals/me","src/models/MyUser","src/helpers/componentEventsHelper","src/controls/lib/paramAssert","src/globals/queries","src/components/imagewall/helpers/logoqueriesEnabledHelper","src/components/imagewall/components/promo/PromotionPopup"],function(Backbone,ReactAppLoader,me,MyUser,componentEventsHelper,paramAssert,queries,logoqueriesEnabledHelper,LogoDetectionPromotionPopup){"use strict";var FAVORITES_KEY="component-picker-favorites";function isLogoQueriesEnabled(){return logoqueriesEnabledHelper.isEnabled()}function projectHasLogoQueries(){return isLogoQueriesEnabled()&&queries.containsLogoQueryIds(queries.pluck("id"))}function showLogoQueriesPopup(){return LogoDetectionPromotionPopup.show({calledFrom:LogoDetectionPromotionPopup.CALLED_FROM.QUERY_INPUT})}var ComponentPickerView=Backbone.View.extend({constructor:function constructor(){var _this=this;var options=arguments.length>0&&arguments[0]!==undefined?arguments[0]:{};paramAssert.isType(options.callback,"function","ComponentPickerView requires options.callback to be a function");this.myUser=new MyUser;this.componentPicker=new ReactAppLoader("componentPicker");this.messageBus=Object.assign({},Backbone.Events);this.listenTo(this.messageBus,"update-favorites",function(){var favorites=arguments.length>0&&arguments[0]!==undefined?arguments[0]:[];_this.myUser.saveTag(FAVORITES_KEY,favorites.join("&"))});this.listenTo(this.messageBus,"add-component",function(spec){options.callback(null,spec);componentEventsHelper.triggerComponentAddedTrackingEvent(spec.type);_this.remove()});this.listenTo(this.messageBus,"closed",function(){options.callback();_this.remove()});Backbone.View.apply(this,arguments)},render:function render(){var favorites=me.getTag(FAVORITES_KEY);this.componentPicker.render({favorites:favorites?favorites.split("&"):[],messageBus:this.messageBus,isLogoQueriesEnabled:isLogoQueriesEnabled(),projectHasLogoQueries:projectHasLogoQueries(),showPopup:showLogoQueriesPopup})},remove:function remove(){if(this.componentPicker){this.componentPicker.remove()}}},{show:function show(options){var view=new ComponentPickerView(options);view.render();return view}});return ComponentPickerView});define("mustache!templates/tabView",["lib/mustache"],function(mustache){var escapedTemplate='<div class="tab-components"></div>\n{{#canAddComponents}}\n<div class="component-menu">\n<a class="show-component-menu smallpadding-vertical singlepadding-horizontal rounded link">\n<span class="icon-plus smallpadding-right"></span><span>Add a Component</span>\n</a>\n<span class="divider singlepadding-left singlemargin-left"></span>\n<a class="add-notes-component smallpadding-vertical singlepadding-horizontal rounded link" title="Add a Note">\n<span class="icon-pencil smallpadding-right"></span><span>Add a Note</span>\n</a>\n</div>\n{{/canAddComponents}}\n';return function(data,partials,wrap){return mustache.render(escapedTemplate,data,partials,wrap)}});define("mustache!templates/tabs/tabRowTemplate",["lib/mustache"],function(mustache){var escapedTemplate='{{#rowSpec}}\n<div class="tabRow">\n{{#cids}}\n<div id="{{.}}"></div>\n{{/cids}}\n</div>\n{{/rowSpec}}\n';return function(data,partials,wrap){return mustache.render(escapedTemplate,data,partials,wrap)}});define("src/views/componentDragging",["underscore","jquery","src/events/dashboardEvents","lib/jquery.event.drag-2.2"],function(_,$,dashboardEvents){"use strict";var BASE_DRAG_MARGIN=36;function makeRow(component,rowClass){var $row=$('<div class="'+rowClass+'"/>');if(component){$row.append(component)}return $row}function getComponentPositions($components,offsetTop,margin){offsetTop=offsetTop||0;margin=margin||0;return _($components).map(function(component){var $component=$(component),offset=$component.offset(),data={$component:$component,top:offset.top+offsetTop-margin[0],bottom:offset.top+$component.height()+offsetTop+margin[2],left:offset.left-margin[3],right:offset.left+$component.width()+margin[1]};data.xTolerance=(data.right-data.left)*.45;return data})}function findCollision(positions,x,y,componentEl){var side=null,collision=_(positions).detect(function(data){var top=data.top,bottom=data.bottom,left=data.left,right=data.right,xTolerance=data.xTolerance,yTolerance=116;if(x<left||x>right||y<top||y>bottom){return false}if(y<top+yTolerance){side="top";return true}if(data.$component[0]===componentEl[0]){return false}if(x<left+xTolerance){side="left";return true}if(x>right-xTolerance){side="right";return true}return false});if(!collision){return null}return{$el:collision.$component,side:side}}return{init:function init(container,opts){var $container=$(container),debouncedDragCollisionCheck;opts=_.extend({rowClass:"row",componentClass:"component",handleSelector:".component:not(.draggable-disabled) .draggable",placeholderClass:"placeholder",dragModeClass:"dragging",proxyEl:null,scrollableContainer:null,scrollAmount:24,componentMargin:[BASE_DRAG_MARGIN*3,BASE_DRAG_MARGIN,-BASE_DRAG_MARGIN*1.5,BASE_DRAG_MARGIN],onBeforePlaceholderMoved:function onBeforePlaceholderMoved(){return true},onPlaceholderMoved:function onPlaceholderMoved(){},onDragEnd:null},opts||{});function updateCachedPositions(dd){dd.containerSize={width:dd.$container.width(),height:dd.$container.height()};dd.componentPositions=getComponentPositions(dd.$components,dd.$scrollable.scrollTop()-dd.$scrollable.offset().top,opts.componentMargin)}function moveComponentTo(component,targetComponent,targetSide){var $sourceRow=component.closest("."+opts.rowClass),$targetRow=targetComponent.closest("."+opts.rowClass);if(!opts.onBeforePlaceholderMoved(component,targetComponent,targetSide,$sourceRow,$targetRow)){return}if(targetSide==="top"||targetSide==="bottom"){if(targetSide==="top"){$targetRow.before(makeRow(component,opts.rowClass))}else{$targetRow.after(makeRow(component,opts.rowClass))}}else{if(targetSide==="left"){targetComponent.before(component)}else{targetComponent.after(component)}}if($sourceRow.is(":empty")){$sourceRow.remove()}opts.onPlaceholderMoved(component,targetComponent,targetSide,$sourceRow,$targetRow)}function dragCollisionCheck(dd,x,y){var collision;if(y<0){collision={side:"top",$el:dd.$components.first()}}else if(y>dd.containerSize.height){collision={side:"bottom",$el:dd.$components.last()}}else{collision=findCollision(dd.componentPositions,x,y,dd.componentEl)}if(!collision){return}dd.targetComponent=collision.$el;dd.side=collision.side;if(dd.previousTargetComponent!==dd.targetComponent||dd.previousSide!==dd.side){dd.previousTargetComponent=dd.targetComponent;dd.previousSide=dd.side;moveComponentTo(dd.componentEl,dd.targetComponent,dd.side);updateCachedPositions(dd);dashboardEvents.trigger("componentMoved_onTab_"+opts.tabCid,dd.componentEl,dd.$sourceRow,dd.componentEl.closest("."+opts.rowClass))}}function onDragComponentStart(ev,dd){var $target=$(ev.target),componentEl=$target.closest("."+opts.componentClass),$components=$container.find("."+opts.componentClass),componentPositions,proxyEl,$scrollable=opts.scrollableContainer||$container;if(!$components.length){return}if(_.isFunction($scrollable)){$scrollable=$scrollable($container)}$components.addClass(opts.dragModeClass);componentEl.addClass(opts.placeholderClass);if(_.isFunction(opts.onDragStart)){opts.onDragStart(componentEl)}if(opts.proxyEl){proxyEl=opts.proxyEl;if(_.isFunction(proxyEl)){proxyEl=proxyEl(componentEl)}proxyEl.appendTo("body").css({top:dd.clientY,left:dd.clientX});dd.proxyOffsetX=proxyEl.width()/2;dd.proxyOffsetY=componentEl.find("header").height()||0;dd.proxyHeight=proxyEl.height()}_.extend(dd,{$container:$container,$components:$components,$scrollable:$scrollable,$sourceRow:componentEl.closest("."+opts.rowClass),componentEl:componentEl,proxyEl:proxyEl,proxyHeight:dd.proxyHeight||0,componentPositions:componentPositions});updateCachedPositions(dd);$container.on("updatePositions.dnd",function(){updateCachedPositions(dd)})}function onDragComponent(ev,dd){if(!dd||!dd.componentPositions){return}var yWindowPointer=dd.startY+dd.deltaY-dd.$scrollable.offset().top,scrollTop=dd.$scrollable.scrollTop();if(dd.proxyEl){dd.proxyEl.css({left:dd.startX+dd.deltaX-dd.proxyOffsetX,top:dd.startY+dd.deltaY-dd.proxyOffsetY})}ev.stopPropagation();if(yWindowPointer<24){dd.$scrollable.scrollTop(scrollTop-opts.scrollAmount)}else if(yWindowPointer+dd.proxyHeight>dd.$scrollable.height()){dd.$scrollable.scrollTop(scrollTop+opts.scrollAmount)}debouncedDragCollisionCheck(dd,dd.startX+dd.deltaX,yWindowPointer+scrollTop)}function onDragComponentEnd(ev,dd){var componentEl=dd.componentEl,$targetRow;if(!dd||!dd.componentPositions){return}if(dd.proxyEl){dd.proxyEl.remove()}componentEl.removeClass(opts.placeholderClass+" "+opts.placeholderVerticalClass);dd.$components.removeClass(opts.dragModeClass);$targetRow=componentEl.closest("."+opts.rowClass);dd.$container.find("."+opts.rowClass+":empty").remove();if(_.isFunction(opts.onDragEnd)){opts.onDragEnd(componentEl,dd.$sourceRow,$targetRow)}$container.off("updatePositions.dnd")}debouncedDragCollisionCheck=_.debounce(dragCollisionCheck,75,true);$container.on("dragstart",opts.handleSelector,{distance:6},onDragComponentStart);$container.on("drag",opts.handleSelector,onDragComponent);$container.on("dragend",opts.handleSelector,onDragComponentEnd)}}});define("src/views/TabView",["async","backbone","underscore","jquery","src/helpers/componentSettingsHelper","src/permissions","src/helpers/componentsMappingHelper","src/globals/queries","src/globals/currentDashboard","src/globals/currentProject","src/events/globalEventNames","src/events/dashboardEvents","src/events/componentEvents","src/componentBuilder","src/views/ComponentPickerView","mustache!templates/tabView","mustache!templates/tabs/tabRowTemplate","src/views/componentDragging","src/storageProvider","lib/jquery.notify"],function(async,Backbone,_,$,componentSettingsHelper,permissions,componentsMappingHelper,queries,currentDashboard,currentProject,globalEventNames,dashboardEvents,componentEvents,componentBuilder,ComponentPickerView,tabView,tabRowTemplate,componentDragging,storageProvider){"use strict";var WIDTHRATIO_CLASS=["fullwidth","halfwidth","thirdwidth"],WIDTHRATIO_ALLCLASSES=WIDTHRATIO_CLASS.join(" "),ROW_HTML='<div class="tabRow"></div>',SCALE_ANIMATION_DURATION=75,FACEBOOK_COMPONENT_TYPES=["facebookanalytics","facebookposts","facebookcomments","facebookfans"];var COMPONENT_EVENT_NAMES=globalEventNames.COMPONENTS;var DASHBOARD_EVENT_NAMES=globalEventNames.DASHBOARDS;var QUICK_NOTIFICATION_DURATION=2e3;function getComponentStoreKey(){return currentProject.get("id")+":components"}function getCopyPasteNotificationMessage(numSpecs,suffix){var notificationMessage=["Component",suffix];if(numSpecs!==1){notificationMessage[0]=notificationMessage[0]+"s";notificationMessage.unshift(numSpecs)}return notificationMessage.join(" ")}function updateRowWidths($row,reflow){var $rowComponents=$row.children(".component"),widthRatio=$rowComponents.length;if(!widthRatio){return}$rowComponents.removeClass(WIDTHRATIO_ALLCLASSES).addClass(WIDTHRATIO_CLASS[widthRatio-1]);if(reflow){$rowComponents.each(function(){var componentView=$(this).data("componentView");componentView.trigger("resize",componentView,widthRatio)})}}function getComponentModelFromComponentView(components,componentViewMap,componentView){var model;Object.keys(componentViewMap).forEach(function(componentCid){if(componentViewMap[componentCid]!==componentView){return}model=components.get(componentCid)});return model}function isFacebookChannel(ids){ids=[].concat(ids);return queries.areFacebookQueries(ids)}function isFacebookComponent(component){var type=component.get("type");return _.contains(FACEBOOK_COMPONENT_TYPES,type)}function removeComponentAnnotation(view,componentView){var model=getComponentModelFromComponentView(view.components,view.componentViewMap,componentView);if(!model){return}view.settingComponent=true;model.unset("annotation");view.settingComponent=false}function removeAllComponentAnnotations(view){view.components.removeAllAnnotations();Object.keys(view.componentViewMap).forEach(function(cid){var componentView=view.componentViewMap[cid];componentView.removeAnnotationElement()})}function onCopyComponent(componentView){this.copyComponents({type:componentView.type,title:componentView.title,activeView:componentView.currentViewKey,settings:componentView.settings.toJSON()})}function onPasteComponent(componentView){var rowIndex=componentView.$el.closest(".tabRow").index()+1;var componentIndex=this.$("article.component").index(componentView.$el)+1;this.pasteComponents({fromRowIndex:rowIndex,at:componentIndex})}return Backbone.View.extend({tagName:"section",className:"tab",events:function events(){return{"click a.show-component-menu":"onShowComponentsMenu","click a.add-notes-component":"onAddNotesComponents"}},initialize:function initialize(){this.components=this.model.components;this.components.on("add",this.addComponent,this);this.components.on("remove",this.removeComponent,this);this.components.on("change",this.changeComponent,this);this.listenTo(componentEvents,COMPONENT_EVENT_NAMES.ANNOTATION_REMOVED,_.partial(removeComponentAnnotation,this));this.listenTo(componentEvents,COMPONENT_EVENT_NAMES.ANNOTATION_REMOVED_ALL,_.partial(removeAllComponentAnnotations,this));this.componentViewMap={}},initDragging:function initDragging(){var self=this,$container=this.$el.find(".tab-components");if(!permissions.check("edit.dashboard",currentDashboard)){return}componentDragging.init($container,{tabCid:this.cid,rowClass:"tabRow",dragModeClass:"minimised",scrollableContainer:function scrollableContainer(){return self.getScrollingContainer()},proxyEl:function proxyEl(component){var headerText=component.find("header h1").first().text();return $('<div class="componentDragProxy popupframe singlepadding">'+'<div class="icon-move dib normal smallpadding-right"></div>'+'<div class="header h1 bold dib textellipsis threecol">'+_.escape(headerText)+"</div>"+"</div>")},onBeforePlaceholderMoved:function onBeforePlaceholderMoved(component,targetComponent,targetSide,sourceRow,targetRow){if(targetSide!=="left"&&targetSide!=="right"){return true}return targetRow.children(".component:not(.placeholder)").length<3},onPlaceholderMoved:function onPlaceholderMoved(component,targetComponent,targetSide,sourceRow,targetRow){if(targetSide==="left"||targetSide==="right"){component.addClass("vertical")}else{component.removeClass("vertical "+WIDTHRATIO_ALLCLASSES).addClass("fullwidth")}updateRowWidths(sourceRow);updateRowWidths(targetRow)},onDragStart:function onDragStart(component){if(!component.hasClass("fullwidth")){component.addClass("vertical")}setTimeout(function(){$container.trigger("updatePositions")},SCALE_ANIMATION_DURATION)},onDragEnd:function onDragEnd(component,$sourceRow,$targetRow){updateRowWidths($sourceRow,true);updateRowWidths($targetRow,true)}});self.listenTo(dashboardEvents,"componentMoved_onTab_"+this.cid,function updateMovedComponent(component){self.updateComponentIndex(component);self.scrollToComponent(component)})},remove:function remove(){if(this.componentsMenu){this.componentsMenu.remove()}this.components.off("add",this.addComponent,this);this.components.off("remove",this.removeComponent,this);this.components.off("change",this.changeComponent,this);_(this.componentViewMap).each(function(view){view.remove()});Backbone.View.prototype.remove.call(this)},_createComponentRowTemplateSpec:function _createComponentRowTemplateSpec(){return this.components.reduce(function(memo,component,index){var widthRatio=component.get("widthRatio")||1;if(index===0||widthRatio===1||widthRatio!==memo.previousWidthRatio||memo.rowSpec[memo.rowSpec.length-1].cids.length===widthRatio){memo.rowSpec.push({cids:[]})}memo.rowSpec[memo.rowSpec.length-1].cids.push(component.cid);memo.previousWidthRatio=widthRatio;return memo},{rowSpec:[]})},render:function render(callback){var self=this;this.$el.append(tabView({canAddComponents:permissions.check("edit.dashboard",currentDashboard)}));this.$(".tab-components").append(tabRowTemplate(this._createComponentRowTemplateSpec()));async.forEach(this.components,function(component,callback){self.addComponent(component,self.components,{callback:callback})},function(){if(callback){callback()}});this.initDragging()},shown:function shown(){_(this.componentViewMap).each(function(view){view.shown()});this.visible=true;if(this.needsReload){this.refresh()}},hidden:function hidden(){_(this.componentViewMap).each(function(view){view.hidden()});this.visible=false},resize:function resize(){_(this.componentViewMap).each(function(view){view.resize()})},addRow:function addRow(){var $el=this.$el,$row=$(ROW_HTML);$el.find(".tab-components").append($row);return $row},insertRowAt:function insertRowAt(targetIndex){var $el=this.$el,$row,$target=[];$target=$el.find(".tabRow").eq(targetIndex);if($target.length){$row=$(ROW_HTML);$target.before($row);return $row}return this.addRow()},addComponent:function addComponent(component,collection,options){var self=this,$el=$(this.el),$componentsHolder,clonedSettings,spec;options=options||{};if(isFacebookComponent(component)&&!isFacebookChannel(component.get("settings").queryId)){clonedSettings=_.clone(component.get("settings"));clonedSettings.queryId=[];clonedSettings.queryName=null;component.set("settings",clonedSettings)}spec=component.toJSON();spec.tabName=this.model.get("name");if(options.optionsDisplayed){spec.optionsDisplayed=true}else{spec.optionsDisplayed=undefined}var $componentContainer=self.$("#"+component.cid);if(options.atRowIndex){$componentsHolder=this.insertRowAt(options&&options.atRowIndex)}else if(!$componentContainer.length){$componentsHolder=this.insertRowAt($el.find(".tabRow").length)}componentBuilder.build(spec,function addComponent(err,componentView){componentView.$el.addClass(WIDTHRATIO_CLASS[spec.widthRatio-1]||"fullwidth");componentView.$el.data("componentView",componentView);if($componentContainer.length){$componentContainer.replaceWith(componentView.$el)}else{$componentsHolder.prepend(componentView.$el)}componentView.$el.attr("data-component-cid",component.cid);self.bindToComponentEvents(componentView);self.componentViewMap[component.cid]=componentView;componentView.render();if(options.callback){options.callback(componentView)}})},removeComponent:function removeComponent(component){var componentView=this.componentViewMap[component.cid],$row=componentView.$el.closest(".tabRow");this.unbindFromComponentEvents(componentView);delete this.componentViewMap[component.cid];_.defer(function(){if($row.is(":empty")){$row.remove()}else{updateRowWidths($row,true)}})},changeComponent:function changeComponent(component){var attrs=component.changedAttributes();var componentView=this.componentViewMap[component.cid];var correctedSettings;if(!this.settingComponent&&componentView&&attrs&&attrs.settings){correctedSettings=componentSettingsHelper.getCorrectedSettings(componentView.constructor,attrs.settings);componentView.settings.set(correctedSettings)}},getScrollingContainer:function getScrollingContainer(){var mq=window.matchMedia&&window.matchMedia("(min-height: 800px)");if(mq&&!mq.matches){return $("#wrapper")}return this.$el.closest(".panes")},scrollToComponent:function scrollToComponent($component,callback){var $scrollable,componentOffset,scrollTop;callback=callback||function(){};if(!$component||!$component.length){return}$scrollable=this.getScrollingContainer();componentOffset=$component.offset().top;scrollTop=$scrollable.scrollTop();componentOffset+=scrollTop-$scrollable.offset().top-36;if(componentOffset>=scrollTop&&componentOffset<=scrollTop+$scrollable.height()){return callback()}$scrollable.animate({scrollTop:componentOffset},{complete:callback})},bindToComponentEvents:function bindToComponentEvents(componentView){componentView.on("closed",this.onComponentClosed,this);componentView.on("switchView",this.onComponentSwitchedView,this);componentView.on("settingsChanged",this.onComponentSettingsChanged,this);componentView.on("titleChanged",this.onComponentTitleChanged,this);componentView.on("duplicate",this.onDuplicateComponent,this);componentView.on("resize",this.onResizeComponent,this);componentView.on("copy",onCopyComponent,this);componentView.on("paste",onPasteComponent,this);componentView.on("customizeBarToggled",this.onCustomizeBarToggled,this);componentView.on("insightsSidebarActiveToggled",this.onInsightsSidebarToggled,this)},unbindFromComponentEvents:function unbindFromComponentEvents(componentView){componentView.off("closed",this.onComponentClosed,this);componentView.off("switchView",this.onComponentSwitchedView,this);componentView.off("settingsChanged",this.onComponentSettingsChanged,this);componentView.off("titleChanged",this.onComponentTitleChanged,this);componentView.off("duplicate",this.onDuplicateComponent,this);componentView.off("resize",this.onResizeComponent,this);componentView.off("copy",onCopyComponent,this);componentView.off("paste",onPasteComponent,this);componentView.off("customizeBarToggled",this.onCustomizeBarToggled,this);componentView.off("insightsSidebarActiveToggled",this.onInsightsSidebarToggled,this)},onComponentClosed:function onComponentClosed(componentView){var model=getComponentModelFromComponentView(this.components,this.componentViewMap,componentView);this.components.remove(model)},onComponentSwitchedView:function onComponentSwitchedView(componentView,viewKey){var model=getComponentModelFromComponentView(this.components,this.componentViewMap,componentView);model.set({activeView:viewKey})},onComponentSettingsChanged:function onComponentSettingsChanged(componentView,settings){var model=getComponentModelFromComponentView(this.components,this.componentViewMap,componentView);this.settingComponent=true;model.set({settings:settings});this.settingComponent=false},onComponentTitleChanged:function onComponentTitleChanged(componentView,title){var model=getComponentModelFromComponentView(this.components,this.componentViewMap,componentView);this.settingComponent=true;model.set({title:title});this.settingComponent=false},onShowComponentsMenu:function onShowComponentsMenu(e){e.preventDefault();e.stopPropagation();var $target=$(e.target);if($target.is("div.component-menu")){$target=$target.find("a.show-component-menu")}this.showComponentsMenu($target)},showComponentsMenu:function showComponentsMenu(){var _this=this;var addComponentCallback=function addComponentCallback(err,spec){delete _this.componentsMenu;if(err){return $.notify({text:"Failed to add new component. Please try again!",className:"notification-error"})}if(!spec){return}_this.setupAndAddComponent(spec)};if(this.componentsMenu){this.componentsMenu.remove();delete this.componentsMenu;return}this.componentsMenu=ComponentPickerView.show({callback:addComponentCallback})},setupAndAddComponent:function setupAndAddComponent(spec){var defaultSettings=_.extend({},currentDashboard.get("settings"),this.model.get("settings"));var componentSpec=_.extend({index:999,tabName:this.model.get("name")},spec);componentSpec.settings=_.defaults(componentSpec.settings||{},defaultSettings);this.components.add(componentsMappingHelper.map(componentSpec),{optionsDisplayed:true})},onAddNotesComponents:function onAddNotesComponents(){if(!permissions.check("edit.dashboard",currentDashboard)){return}this.setupAndAddComponent({type:"note",title:"Note"})},onDuplicateComponent:function onDuplicateComponent(component){var self=this,$row=component.$el.closest(".tabRow"),newIndex=this.components.indexOf(this.components.get($row.children(".component:last").attr("data-component-cid")))+1,duplicateSpec={id:undefined,type:component.type,title:component.title,activeView:component.currentViewKey,settings:$.extend(true,{},component.settings.toJSON()),widthRatio:1};this.components.add(duplicateSpec,{at:newIndex,atRowIndex:$row.index()+1,callback:function callback(component){self.scrollToComponent(component.$el)}})},copyComponents:function copyComponents(specs){var toCopy;function cleanComponentSpec(spec){return $.extend(true,{},_.omit(spec,"data","id"),{widthRatio:1})}toCopy=[].concat(specs).map(cleanComponentSpec);storageProvider.set(getComponentStoreKey(),toCopy);$.notify({text:getCopyPasteNotificationMessage(toCopy.length,"copied"),duration:QUICK_NOTIFICATION_DURATION,className:"notification-info"});dashboardEvents.trigger(DASHBOARD_EVENT_NAMES.COMPONENTS_COPIED,{numberOfComponents:toCopy.length})},pasteComponents:function pasteComponents(location){var self=this;var toPaste=storageProvider.get(getComponentStoreKey());if(!toPaste){return $.notify({text:"Please copy a Component first",duration:QUICK_NOTIFICATION_DURATION,className:"notification-info"})}function getPasteLocation(index){if(!location){return{}}return{at:location.at+index,atRowIndex:location.fromRowIndex+index}}toPaste.map(function(spec,index){self.components.add(spec,$.extend({},getPasteLocation(index)))});$.notify({text:getCopyPasteNotificationMessage(toPaste.length,"pasted"),duration:QUICK_NOTIFICATION_DURATION,className:"notification-success"});dashboardEvents.trigger(DASHBOARD_EVENT_NAMES.COMPONENTS_PASTED,{numberOfComponents:toPaste.length})},onCustomizeBarToggled:function onCustomizeBarToggled(componentView,open){var model=getComponentModelFromComponentView(this.components,this.componentViewMap,componentView);this.settingComponent=true;model.set({customizeBarOpen:open});this.settingComponent=false},onInsightsSidebarToggled:function onInsightsSidebarToggled(componentView,active){var model=getComponentModelFromComponentView(this.components,this.componentViewMap,componentView);this.settingComponent=true;model.set({insightsSidebarActive:active});this.settingComponent=false},onResizeComponent:function onResizeComponent(componentView,widthRatio){var model=getComponentModelFromComponentView(this.components,this.componentViewMap,componentView);model.set({widthRatio:widthRatio});componentView.resize({widthRatio:widthRatio})},updateComponentIndex:function updateComponentIndex($componentEl){var componentCid=$componentEl.attr("data-component-cid"),components=this.components,componentToMove=components.get(componentCid),$componentElements,newIndex;$componentElements=this.$("article.component");newIndex=$componentElements.index($componentEl);components.remove(componentToMove,{silent:true});components.add(componentToMove,{at:newIndex,silent:true});components.trigger("change",componentToMove,this.components)},refresh:function refresh(){if(!this.visible){this.needsReload=true;return}_.each(this.componentViewMap,function(componentView){(componentView.model||componentView.collection).fetch();if(typeof componentView.refresh==="function"){componentView.refresh()}});this.needsReload=false}})});define("src/TabManager",["backbone","underscore","src/models/Tab","src/models/TabCollection","src/views/TabView","src/analytics/Analytics"],function(Backbone,_,Tab,TabCollection,TabView,Analytics){"use strict";var TabManager=function TabManager(collection){var self=this;this.tabViews=[];if(!collection||!(collection instanceof TabCollection)){throw new Error("TabManager must be instantiated with a TabCollection")}this.collection=collection;collection.each(function(model,index){self.createViewForTab(model);model.index=index});collection.on("reset",this.onResetTabs,this)};TabManager.prototype.count=function(){return this.collection.size()};TabManager.prototype.getTabsWithViews=function(){var tabViews=this.tabViews;return this.collection.map(function(model,index){return{model:model,view:tabViews[index]}})};TabManager.prototype.onResetTabs=function(collection){this.resetTabs(collection)};TabManager.prototype.resetTabs=function(){};TabManager.prototype.remove=function(){this.collection.off("reset",this.onResetTabs,this);_(this.tabViews).each(function(view){view.remove()});this.tabViews=[]};TabManager.prototype.createTab=function(tabOptions,index){var tabCollection=this.collection,tab,tabView,options={};if(_.isNumber(tabOptions)){index=tabOptions;tabOptions=undefined}tabOptions=tabOptions||{};tab=new Tab(tabOptions);if(_.isNumber(index)){options.at=index;tab.index=index}else{tab.index=tabCollection.size()}tabCollection.add(tab,options);tabView=this.createViewForTab(tab);this.collection.trigger("change");this.trigger("tabCreated",{tab:tab,view:tabView,index:tab.index});Analytics.trackEvent({name:"Miscellaneous.Tabs",action:"Add",origin:"Application"})};TabManager.prototype.duplicateTab=function(cid){var tabCollection=this.collection,tabToDuplicate=tabCollection.get(cid),index=tabCollection.indexOf(tabToDuplicate)+1,data=tabToDuplicate.toJSON();delete data.id;data.name="Copy of "+data.name;this.createTab(data,index);Analytics.trackEvent({name:"Miscellaneous.Tabs",action:"Duplicate_Tab",origin:"Application"})};TabManager.prototype.createViewForTab=function(tabModel){var tabCollection=this.collection,tabView,viewIndex;tabView=new TabView({model:tabModel});viewIndex=tabCollection.models.indexOf(tabModel);this.tabViews.splice(viewIndex,0,tabView);return tabView};TabManager.prototype.removeTab=function(index){var tabCollection=this.collection,tabViews=this.tabViews,tabToRemove=tabCollection.at(index);tabCollection.remove(tabToRemove);tabViews.splice(index,1)[0].remove();this.collection.trigger("change");this.trigger("tabRemoved",{tab:tabToRemove,index:index});Analytics.trackEvent({name:"Miscellaneous.Tabs",action:"Remove_"+tabToRemove.get("name"),origin:"Application"})};TabManager.prototype.moveTab=function(oldIndex,newIndex){var tabCollection=this.collection,tabViews=this.tabViews,tabViewToMove=tabViews[oldIndex],tabToMove=tabCollection.at(oldIndex);tabCollection.remove(tabToMove,{silent:true});tabCollection.add(tabToMove,{at:newIndex,silent:true});tabViews.splice(oldIndex,1);tabViews.splice(newIndex,0,tabViewToMove);this.collection.trigger("change");this.trigger("tabMoved")};TabManager.prototype.refreshTabs=function(){_.each(this.tabViews,function(tabView){tabView.refresh()})};_.extend(TabManager.prototype,Backbone.Events);return TabManager});define("src/models/BackfillCollection",["backbone","src/models/Backfill"],function(Backbone,Backfill){"use strict";return Backbone.Collection.extend({model:Backfill,initialize:function initialize(models,options){options=options||{};if(!options.projectId){throw new Error("BackfillCollection must be initialized with a projectId")}if(!options.queryId){throw new Error("BackfillCollection must be initialized with a queryId")}this.projectId=options.projectId;this.queryId=options.queryId;this.page=options.page>-1?options.page:-1;this.pageSize=options.pageSize||-1},getQueryData:function getQueryData(){return{page:this.page,pageSize:this.pageSize}},url:function url(){return"/projects/{projectId}/queries/"+this.queryId+"/backfill"},parse:function parse(results){return results.results}})});define("src/models/BackfillPolling",["backbone","underscore","src/models/BackfillCollection"],function(Backbone,_,BackfillCollection){"use strict";var BACKFILL_MENTIONS_REGEXP=new RegExp("([0-9]*) mentions[^0-9]*([0-9]*) remaining");var DEFAULT_POLLING_DELAY=2e3;function isBackfillPending(backfill){return[BackfillPolling.BACKFILL_STATUS_WAIT,BackfillPolling.BACKFILL_STATUS_RUN].indexOf(backfill.get("status").toLowerCase())>-1}function getBackfillWithHighestPriority(collection){var pendingBackfills=collection.filter(isBackfillPending);var firstQueryBackfill=_(pendingBackfills).find();if(firstQueryBackfill){return firstQueryBackfill}}function getPercentageCompleted(pendingBackfill){var percentage=0;var totalMentions;var mentionsProcessed;var matches;matches=BACKFILL_MENTIONS_REGEXP.exec(pendingBackfill.get("statusMessages"));if(matches&&matches.length===3){mentionsProcessed=parseInt(matches[1],10);totalMentions=mentionsProcessed+parseInt(matches[2],10);if(totalMentions>0){percentage=Math.floor(100*mentionsProcessed/totalMentions)}}return percentage}function poll(backfillPolling){backfillPolling.collection.fetch()}function schedulePolling(backfillPolling){backfillPolling.stopPolling();backfillPolling.timer=setTimeout(poll.bind(null,backfillPolling),backfillPolling.pollingDelay)}function onSync(backfillPolling){var currentPendingBackfill=getBackfillWithHighestPriority(backfillPolling.collection);if(!currentPendingBackfill&&!backfillPolling.lastPendingBackfill){backfillPolling.trigger("noBackfillsRunning");return}if(!currentPendingBackfill){backfillPolling.trigger("complete",{progress:100,type:backfillPolling.lastPendingBackfill.get("backfillType")});backfillPolling.lastPendingBackfill=null;return}backfillPolling.trigger("change",{progress:getPercentageCompleted(currentPendingBackfill),type:currentPendingBackfill.get("backfillType")});backfillPolling.lastPendingBackfill=currentPendingBackfill;schedulePolling(backfillPolling)}function BackfillPolling(options){this.initialize(options||{})}_.extend(BackfillPolling.prototype,Backbone.Events,{initialize:function initialize(options){this.collection=new BackfillCollection([],{queryId:options.queryId,projectId:options.projectId,page:0,pageSize:1});this.pollingDelay=options.pollingDelay||DEFAULT_POLLING_DELAY;this.listenTo(this.collection,"sync",onSync.bind(null,this))},startPolling:function startPolling(){if(this.timer){return}poll(this)},stopPolling:function stopPolling(){if(this.timer){clearTimeout(this.timer);this.timer=null}}});BackfillPolling.BACKFILL_STATUS_WAIT="wait_b";BackfillPolling.BACKFILL_STATUS_RUN="run_b";BackfillPolling.BACKFILL_STATUS_DONE="done";BackfillPolling.BACKFILL_STATUS_CANCEL="cancel";return BackfillPolling});define("src/helpers/QueryCompletionPolling",["backbone","underscore","src/models/Query"],function(Backbone,_,Query){"use strict";var DEFAULT_POLLING_DELAY=2e3;function poll(polling){polling.model.fetch()}function schedulePolling(polling){polling.stopPolling();polling.timer=setTimeout(poll.bind(null,polling),polling.pollingDelay)}function onSync(polling){var percentComplete=polling.model.get("percentComplete");var wasFirstFetch=polling.model.firstFetch;polling.model.firstFetch=false;if(percentComplete==100){if(wasFirstFetch){polling.trigger("noBackfillsRunning")}else{polling.trigger("complete",{progress:100})}return}polling.trigger("change",{progress:percentComplete});schedulePolling(polling)}function QueryCompletionPolling(options){this.initialize(options||{})}_.extend(QueryCompletionPolling.prototype,Backbone.Events,{initialize:function initialize(options){if(!options.projectId){throw new Error("Query must be initialized with a projectId")}if(!options.queryId){throw new Error("Query must be initialized with a queryId")}this.model=new Query({id:options.queryId,projectId:options.projectId});this.pollingDelay=options.pollingDelay||DEFAULT_POLLING_DELAY;this.listenTo(this.model,"sync",onSync.bind(null,this))},startPolling:function startPolling(){if(this.timer){return}this.model.firstFetch=true;poll(this)},stopPolling:function stopPolling(){if(this.timer){clearTimeout(this.timer);this.timer=null}}});return QueryCompletionPolling});define("src/pageUnloadManager",["underscore"],function(_){"use strict";function PageUnloadManager(){this.prompts=[]}_.extend(PageUnloadManager.prototype,{defaultUnloadMessage:"Any unsaved changes to your dashboards will be lost!",clear:function clear(){this.prompts.splice(0,this.prompts.length);window.onbeforeunload=null},enablePromptOnUnload:function enablePromptOnUnload(prompt){var self=this;if(this.prompts.indexOf(prompt)===-1){this.prompts.push(prompt)}if(!window.onbeforeunload){window.onbeforeunload=function(){return self.prompts.join("\n")}}},disablePromptOnUnload:function disablePromptOnUnload(prompt){while(this.prompts.indexOf(prompt)>-1){this.prompts.splice(this.prompts.indexOf(prompt),1)}if(this.prompts.length===0){window.onbeforeunload=null}}});return new PageUnloadManager});define("mustache!templates/dashboardTabPlaceholder",["lib/mustache"],function(mustache){var escapedTemplate='<li data-tabCid="{{tabCid}}" class="{{liClass}} horizontal-navigation--item navbuttonshade dib">\n<a href="{{tabLink}}" class="textellipsis fourcolmax dib singlepadding-left {{tabClass}} customtip" data-at="tab-name" title="Drag to reorder or double click to rename">{{title}}</a>\n{{#canUserEdit}}\n<a class="js-tabcontextmenu icon-chevron-down fadeopacity smallmargin-right" data-at="tab-context-menu"></a>\n{{/canUserEdit}}\n</li>\n';return function(data,partials,wrap){return mustache.render(escapedTemplate,data,partials,wrap)}});define("css!css/dashboard.css",["css!css/compiled.css"],function(){});define("src/views/DashboardView",["backbone","underscore","jquery","q","bw-fe-helpers/promiseHelper","src/globals/theme","app","src/events/dashboardEvents","src/globals/flags","src/globals/flagNames","src/events/globalEventNames","src/permissions","src/helpers/dashboardExports/export","src/globals/me","src/globals/queries","src/globals/currentProject","src/globals/currentDashboard","src/views/DashboardToolbarView","src/views/TabRenameFormView","src/views/TabContextMenuView","src/views/GlobalFilterInputsView","src/views/GlobalDateInputsView","src/views/GlobalQueryInputsView","src/TabManager","src/models/Dashboard","src/pageTour","src/models/BackfillPolling","src/helpers/QueryCompletionPolling","src/pageUnloadManager","src/analytics/Analytics","mustache!templates/dashboardTabPlaceholder","src/appNotifications","src/packages/drag","src/packages/customtip","src/packages/waitmask","lib/jquery.notify","css!css/dashboard.css"],function(Backbone,_,$,Q,promiseHelper,theme,app,dashboardEvents,flags,FLAGS,globalEventNames,permissions,dashboardExportsHelper,me,queries,currentProject,currentDashboard,DashboardToolbarView,TabRenameFormView,TabContextMenuView,GlobalFilterInputsView,GlobalDateInputsView,GlobalQueryInputsView,TabManager,Dashboard,pageTour,BackfillPolling,QueryCompletionPolling,pageUnloadManager,Analytics,renderDashboardTabPlaceholder,appNotifications){"use strict";var DASHBOARD_EVENT_NAMES=globalEventNames.DASHBOARDS,_saveWarningText="Any unsaved changes to your dashboards will be lost!",DRAGDATA_DEFAULTS={relative:true,distance:5,click:false},TIMEZONE_CHANGED_MSG="The time zone for this Project has changed. Reload&nbsp;to see these changes.&nbsp;"+'<a href="" class="js-reload appNotification__action">Reload Now</a>';function findTabIndexById(tabs,tabId){return tabs.pluck("id").indexOf(tabId)}function getTabPositions($tabs){return _($tabs).map(function(tab){var $tab=$(tab),width=$tab.width(),offset=$tab.position(),left=offset.left,top=offset.top;return{$tab:$tab,left:left,right:left+width,mid:left+width/2,top:top}})}function _isChannel(queryModel){return["twitter","publicfacebook"].indexOf(queryModel.get("type"))>-1}function trackTimezoneChangePromise(oldTZ,newTZ){return Analytics.trackMixpanelEvent(globalEventNames.DASHBOARDS.NEW_TIMEZONE_CHOSEN,{oldTimezone:oldTZ||"",newTimezone:newTZ||""})}return Backbone.View.extend({tagName:"section",className:function className(){var className="dashboard";if(!permissions.check("see.mentions")){className+=" no-mentions"}return className},attrs:{id:"components"},events:function events(){if(!this.userCanEdit()){return{"click ul.tabs > li a.open":"onClickTab"}}return{"click ul.tabs > li.add":"onCreateTab","click ul.tabs > li a.js-tabcontextmenu":"onClickTabContextMenu","click ul.tabs > li a.open":"onClickTab","dblclick ul.tabs li[data-tabcid]":"onRenameTab","drag .dragHandle":"onDragTab","dragstart .dragHandle":"onDragTabStart","dragend .dragHandle":"onDragTabEnd"}},initialize:function initialize(options){var model=this.model,queryId=model.getQueryId();this.onResize=_.throttle(this.onResize,100);this.currentTabIndex=0;if(options&&options.tabId){this.currentTabIndex=findTabIndexById(model.tabs,options.tabId);if(this.currentTabIndex<0){this.currentTabIndex=0}}if(queryId&&queries.get(queryId)){var pollingOptions={queryId:queryId,projectId:currentProject.id,pollingDelay:2e3};if(queries.get(queryId).get("type")=="monitor"){this.backfillPolling=new QueryCompletionPolling(pollingOptions)}else{this.backfillPolling=new BackfillPolling(pollingOptions)}this.listenTo(this.backfillPolling,"change",this.onBackfillChange);this.listenTo(this.backfillPolling,"complete",this.onBackfillComplete);this.listenTo(this.backfillPolling,"noBackfillsRunning",this.onNoBackfillsRunning)}_(this).bindAll("onResize");$([window,document]).on("resize",this.onResize);this.storeModelAttributes();this.listenToViews(model);if(model.isNew()){this.setDirty()}},listenToViews:function listenToViews(model){var tabManager=this.tabManager=new TabManager(this.model.tabs),dashboardToolbar=this.dashboardToolbar=new DashboardToolbarView({model:model});this.listenTo(model,"saved",this.storeModelAttributes);this.listenTo(model,"change",this.setDirty);this.listenTo(model,"sync",this.unsetDirty);this.listenTo(tabManager,"tabCreated",this.onTabCreated);this.listenTo(tabManager,"tabRemoved",this.onTabRemoved);this.listenTo(dashboardToolbar,"closeRequested",this.onCloseRequested);this.listenTo(dashboardToolbar,"saveRequested",this.onSaveRequested);this.listenTo(dashboardToolbar,"copyRequested",this.onCopyRequested);this.listenTo(dashboardToolbar,"refreshRequested",this.refresh);this.listenTo(dashboardToolbar,"loadFromTemplate",this.loadFromTemplate);this.listenTo(queries,"add",this.onDataSourceCreated);this.listenTo(queries,"change",this.onQueryOrChannelChanged);this.listenTo(dashboardEvents,DASHBOARD_EVENT_NAMES.TAB_CREATED,this.onCreateTab);this.listenTo(dashboardEvents,DASHBOARD_EVENT_NAMES.TIMEZONE_UPDATED,this.onTimeZoneUpdated)},onTimeZoneUpdated:function onTimeZoneUpdated(payload){var self=this;var closeOptions={withReloadIntention:true,source:payload.source,oldDashboardTimezone:payload.oldDashboardTimezone};payload.isHandled=true;this.close(function(canNavigate){if(canNavigate){return payload.action()}if(payload.source!=="project"){return}return appNotifications.show({key:"timezoneReload",messageHtml:TIMEZONE_CHANGED_MSG,cssClass:"notification-warning"}).on("click",".js-reload",function(e){e.preventDefault();self.close(function(canNavigateNow){if(canNavigateNow){payload.action()}},closeOptions)})},closeOptions)},onDataSourceCreated:function onDataSourceCreated(model){var isChannel=_isChannel(model),name=model.get("name"),text=isChannel?'Channel "'+name+'" created':'Query "'+name+"\" created. We'll email you when data is complete.";this.showTemporaryNotification({text:text,className:"notification-"+(isChannel?"success":"info")})},onQueryOrChannelChanged:function onQueryOrChannelChanged(model){if(_isChannel(model)&&model.changedAttributes().name){return this.onChannelChanged(model)}if(!_isChannel(model)&&model.changedAttributes().lastModificationDate){return this.onQueryChanged(model)}},onQueryChanged:function onQueryChanged(model){this.showTemporaryNotification({text:'Updating Query "'+model.get("name")+"\". We'll email you when ready."})},onChannelChanged:function onChannelChanged(model){if(!_isChannel(model)){return}this.showTemporaryNotification({text:'Channel "'+model.get("name")+'" updated',className:"notification-success"})},showTemporaryNotification:function showTemporaryNotification(options){options=options||{};$.notify({text:options.text,duration:options.duration||7e3,className:options.className||"notification-info"})},delegateEvents:function delegateEvents(){Backbone.View.prototype.delegateEvents.call(this);var dragData=this.$el.data("dragdata");if(!dragData){return}dragData=_.extend(dragData,DRAGDATA_DEFAULTS);this.$el.data("dragdata",dragData)},storeModelAttributes:function storeModelAttributes(){this.modelSavedAttributes=this.model.toJSON()},restoreModelToSavedState:function restoreModelToSavedState(){this.model.clear({silent:true});this.model.set(this.modelSavedAttributes,{silent:true});this.model.trigger("sync",this.model);currentDashboard.trigger("sync",currentDashboard)},onCloseRequested:function onCloseRequested(){var projectId=this.model.get("projectId");app.navigate("project/"+projectId+"/dashboards",{trigger:true})},onSaveRequested:function onSaveRequested(){this.save()},onCopyRequested:function onCopyRequested(){this.saveAs()},close:function close(callback,options){var self=this;var model=this.model;var remove=this.remove.bind(this);var showRenameDialog=this.showRenameDialog.bind(this);var restoreModelToSavedState=this.restoreModelToSavedState.bind(this);var forceCloseDirty=options&&options.forceCloseDirty;var withReloadIntention=options&&options.withReloadIntention;var emittedByDashboard=options&&options.source==="dashboard";var buttons=[{text:withReloadIntention?"Save and Reload":"Save Dashboard",className:"confirmBtn",value:"confirm",keyCode:13},{text:withReloadIntention?"Reload without Saving":"Close without Saving",className:"closeBtn",value:"close"},{text:"Cancel",className:"cancelBtn",value:false,keyCode:27}];if(withReloadIntention&&options&&options.source==="dashboard"){buttons.splice(1,1)}callback=callback||function(){};if(!this._needsSave||forceCloseDirty||!permissions.check("edit.dashboard",currentDashboard)){restoreModelToSavedState();remove();return callback(true)}$.confirm({dialogClass:"popup smallpopup",closeButtonClass:"popup--close singlepadding",title:"Unsaved Changes",text:'Your Dashboard "'+this.model.escape("name")+'" has <strong>unsaved changes</strong>, do you want to <strong>save them</strong>?',escape:false,buttons:buttons},function(value){var save=function save(){var isNew=model.isNew();return new Q(model.save()).then(function(){if(withReloadIntention&&isNew){return self.navigateToDashboard(model,{trigger:false,replace:true,tabId:self.currentTab.model.id})}}).then(function(){if(emittedByDashboard){return trackTimezoneChangePromise(options.oldDashboardTimezone,model.get("dashboardTimezone"))}return new Q}).then(function(){remove();callback(true)})};if(value==="confirm"){if(!Dashboard.isDefaultName(model.get("name"))){return save()}return showRenameDialog(function(name){if(!name){return callback(true)}return save()})}else if(value==="close"){restoreModelToSavedState();remove();return callback(true)}else{if(emittedByDashboard){model.set("dashboardTimezone",options.oldDashboardTimezone)}callback(false)}})},showRenameDialog:function showRenameDialog(callback){var model=this.model;var dashboardToolbar=this.dashboardToolbar;$.prompt({text:"Name Dashboard",intro:"Please enter a new name for this Dashboard",okText:"Rename",maxLength:model.dashboardNameMaxLength,validate:model.validateDashboardName.bind(model)},model.get("name"),function(err,newName){if(err||!newName){dashboardToolbar.showUnsavedState();return}model.set({name:newName});callback(newName)})},saveDashboard:function saveDashboard(options){if(!options||!_.isFunction(options.save)||!_.isFunction(options.saveAs)){throw new Error("saveDashboard must be called with the callback functions option.save and options.saveAs")}return options.save()},remove:function remove(){this.unsetDirty();this.tabManager.remove();if(this.dashboardToolbar){this.dashboardToolbar.off();this.dashboardToolbar.remove()}$([window,document]).off("resize",this.onResize);dashboardEvents.trigger(DASHBOARD_EVENT_NAMES.DASHBOARD_HIDDEN);if(this.backfillPolling){this.backfillPolling.stopPolling()}if(this.tabContextMenuView){this.tabContextMenuView.remove();this.tabContextMenuView=null}this.removeGlobalFilterInputView();if(this.tabRenameFormView){this.removeTabRenameFormView()}this.currentTab=null;Backbone.View.prototype.remove.call(this)},removeGlobalFilterInputView:function removeGlobalFilterInputView(){if(this.globalFilterInputView){this.globalFilterInputView.remove();this.globalFilterInputView=null}},refresh:function refresh(){this.tabManager.refreshTabs()},loadFromTemplate:function loadFromTemplate(args){this.trigger("loadFromTemplate",args)},onBackfillChange:function onBackfillChange(data){var self=this;var $notificationArea=this.dashboardToolbar.$(".dashboard-toolbar-notifications");var queryName=this.model.get("settings").queryName;var progress=data.progress==undefined?"Starting":data.progress+"%";var message='Gathering data for Query "'.concat(_.escape(queryName),'" (').concat(progress,") ...");var $currentNotification=$notificationArea.find(".backfillnotification");$currentNotification.remove();$notificationArea.showNotification({text:'<span class="text">'+message+"</span>"+'<a data-key="backfillStatus" class="smallmargin-left help icon-question-sign"></a>',cssClass:"notification-warning backfillnotification",actions:[{text:"Reload Data",action:function action(){self.refresh()}}],onRemoved:function onRemoved(){if(self.backfillPolling){self.backfillPolling.stopPolling();self.backfillPolling=null}}})},onBackfillComplete:function onBackfillComplete(){var self=this;var $notificationArea=this.dashboardToolbar.$(".dashboard-toolbar-notifications");var queryName=this.model.get("settings").queryName;var queryBackfillText='Data for Query "'+_.escape(queryName)+'" now complete.';var $currentNotification=$notificationArea.find(".backfillnotification");if($currentNotification.length){$currentNotification.remove();$notificationArea.showNotification({text:queryBackfillText,cssClass:"notification-success backfillnotification",actions:[{text:"Refresh the Dashboard",action:function action(){self.refresh();$notificationArea.find(".backfillnotification").remove()}}]})}this.backfillPolling=null},onNoBackfillsRunning:function onNoBackfillsRunning(){this.backfillPolling=null},save:function save(){var self=this,model=this.model,isNew=model.isNew(),hasDefaultName=Dashboard.isDefaultName(model.get("name")),navigateToDashboard=_.bind(this.navigateToDashboard,this),doSave=function doSave(){model.save(undefined,{success:function success(){if(isNew){navigateToDashboard(model,{trigger:false,replace:true,tabId:self.currentTab.model.id})}if(flags.variation(FLAGS.ENABLE_DASHBOARD_SCREENSHOTS)){var firstTabHasChanges=Object.keys(model.tabs.models[0].changed).length!==0;if(firstTabHasChanges){var url="/project/".concat(model.get("projectId"),"/dashboard/").concat(model.id,"/")+"export?format=screenshot&email=".concat(me.get("username"));promiseHelper.ajax({method:"POST",url:url})}}},error:function error(){self.dashboardToolbar.showUnsavedState()}})},showRenameDialog=_.bind(this.showRenameDialog,this);if(hasDefaultName){showRenameDialog(function(newName){if(newName){doSave()}});return}doSave()},saveAs:function saveAs(options){var self=this,$el=this.$el,navigateToDashboard=_.bind(this.navigateToDashboard,this);options=options||{};_.defaults(options,{defaultDashboardName:"Copy of "+self.model.get("name"),title:"Make a Copy",intro:"Save Dashboard as",forceCloseDirty:true});$.prompt({text:options.title,intro:options.intro,okText:"Save"},options.defaultDashboardName,function(err,newName){var newModel;if(err){return}if(!newName||newName===self.model.get("name")){return}$el.showWaitmask("Creating Copy...");newModel=self.model.clone();newModel.unset("id",{silent:true});newModel.unset("viewUsers",{silent:true});newModel.unset("analystUsers",{silent:true});newModel.set({name:newName,userId:me.id,username:me.get("username"),sharedWith:"none"});newModel.save({},{success:function success(){newModel.off();$el.hideWaitmask();navigateToDashboard(newModel,options);$.notify({text:'Created and opened "'+newModel.get("name")+'"',className:"notification-success"})},error:function error(e){$el.hideWaitmask();alert("error occurred:"+e)}})})},navigateToDashboard:function navigateToDashboard(model,options){options=_.extend({trigger:true},options);return app.navigateToDashboard(model.get("projectId"),model.id,options.tabId,options)},needsSave:function needsSave(){return!!this._needsSave},setDirty:function setDirty(){if(this._needsSave){return}this._needsSave=true;this.dashboardToolbar.showUnsavedState();if(permissions.check("edit.dashboard",this.model)){pageUnloadManager.enablePromptOnUnload(_saveWarningText)}},unsetDirty:function unsetDirty(){this._needsSave=false;this.dashboardToolbar.showSavedState();pageUnloadManager.disablePromptOnUnload(_saveWarningText)},showTab:function showTab(index){this.$("ul.tabs > li a.open").eq(index||0).click()},onClickTab:function onClickTab(e){var $target=$(e.target).closest("li"),tabIndex=$target.index(),tab=this.tabManager.getTabsWithViews()[tabIndex],tabView=tab.view,dragData=$target.data("dragdata");e.preventDefault();if(!tabView){return}if(this.currentTab){this.currentTab.$el.addClass("hidden");this.currentTab.hidden()}if(!tabView.rendered){tabView.render();tabView.rendered=true}if(this.rendered){Analytics.trackEvent({name:"Miscellaneous.Tabs",action:"Switch_to_"+tabView.model.get("name"),origin:"Application"})}if(dragData){$target.data("dragdata",_.extend(dragData,DRAGDATA_DEFAULTS))}tabView.$el.removeClass("hidden");tabView.shown();$target.addClass("current active").siblings().removeClass("current active");this.currentTab=tabView;this.currentTabIndex=tabIndex;this.model.currentTabId=tabView.model.id;this.trigger("tabSelected",this,tab.model.id)},getTabHeaders:function getTabHeaders(){return this.$("> .tabs > li")},getTabPaneContainer:function getTabPaneContainer(){return this.$("> .panes")},hide:function hide(){dashboardEvents.trigger(DASHBOARD_EVENT_NAMES.DASHBOARD_HIDDEN);if(this.currentTab){this.currentTab.hidden()}this.$el.hide()},render:function render(){var self=this,model=this.model,tabHeaders=$('<ul class="tabs pagepadding-horizontal horizontal-navigation" data-at="dashboard-tab-container">'+'<li class="horizontal-navigation--item navbuttonshade dib add customtip" title="Add new tab">'+'<a class="icon-plus singlepadding-horizontal"></a></li></ul><div class="clearleft"></div>'),tabComponents=$('<div class="panes pagepadding-horizontal doublepadding-top pagepadding-bottom" />'),renderTabPlaceholder=_.bind(this.renderTabPlaceholder,this);if(!this.userCanEdit()){tabHeaders.find(".add").addClass("hidden")}this.dashboardToolbar.render();this.$el.html(this.dashboardToolbar.$el);this.$el.append(tabHeaders);this.$el.append(tabComponents);_(this.tabManager.getTabsWithViews()).each(renderTabPlaceholder);tabHeaders.customtip({predelay:1e3,onBeforeShow:function onBeforeShow(event){if(self.dragging){event.preventDefault()}}});this.showTab(this.currentTabIndex);this.rendered=true;if(this.backfillPolling){this.backfillPolling.startPolling()}Analytics.trackEvent({name:"Dashboard."+_.capitalize(model.get("dashboardType")),action:"View"});dashboardEvents.trigger(DASHBOARD_EVENT_NAMES.DASHBOARD_SHOWN,{dashboardId:model.id,queryId:model.getQueryId(),dashboardType:_.capitalize(model.get("dashboardType")),projectId:currentProject.id});if(currentDashboard.isNew()&&theme.isBrandwatchOrGreyLabelTheme()&&currentDashboard.get("dashboardType")==="demographics"){pageTour.setTourMark("demographics-dashboard")}window.dispatchEvent(new CustomEvent("tti:complete"))},renderTabPlaceholder:function renderTabPlaceholder(item){var tab=item.model,tabView=item.view,index=tab.index,json=tab.toJSON(),liClass=this.userCanEdit()?"dragHandle":"",data={title:json.name,tabIndex:index,tabLink:"#tab-"+tab.cid},$el,$tabHeaders=this.getTabHeaders(),$tabHeaderAfter=$tabHeaders.eq(index),$tabPaneContainer=this.getTabPaneContainer(),$tabPaneAfter=$tabPaneContainer.children().eq(index),html;html=renderDashboardTabPlaceholder({tabCid:tab.cid,liClass:liClass,tabClass:this.tabClass(),title:data.title,tabLink:data.tabLink,canUserEdit:this.userCanEdit()});$el=$(html).data("index",index);tabView.$el.attr("data-tabCid",_.escape(tab.cid));tabView.$el.addClass("hidden");if($tabHeaderAfter.length){$tabHeaderAfter.before($el)}else{$tabHeaders.append($el)}if($tabPaneAfter.length){$tabPaneAfter.before(tabView.$el)}else{$tabPaneContainer.append(tabView.$el)}return $el},tabClass:function tabClass(){return this.userCanEdit()?"open singlepadding-right":"open paddedTab singlepadding-right"},userCanEdit:function userCanEdit(){return permissions.check("edit.dashboard",this.model)},buildContextMenuIcon:function buildContextMenuIcon(){return this.userCanEdit()?'<a class="js-tabcontextmenu icon-chevron-down fadeopacity smallmargin-right"></a>':""},onClickTabContextMenu:function onClickTabContextMenu(e){var $target=$(e.target),tabcid=$target.closest(".current").data("tabcid");e.preventDefault();e.stopPropagation();if(this.tabContextMenuView&&this.tabContextMenuView.isShown()){this.tabContextMenuView.remove();this.tabContextMenuView=undefined;return}if(tabcid){this.tabContextMenuView=TabContextMenuView.show({$target:$target});this.listenTo(this.tabContextMenuView,"rename",this.onRenameTab);this.listenTo(this.tabContextMenuView,"duplicate",this.onDuplicateTab);this.listenTo(this.tabContextMenuView,"close",this.onRemoveTab);this.listenTo(this.tabContextMenuView,"showComponentMenu",this.onShowComponentMenu);this.listenTo(this.tabContextMenuView,"addNotesComponent",this.onAddNotesComponent);this.listenTo(this.tabContextMenuView,"filter",this.onFilter);this.listenTo(this.tabContextMenuView,"dateRangePicker",this.onDateRange);this.listenTo(this.tabContextMenuView,"dataSource",this.onDataSource);this.listenTo(this.tabContextMenuView,"copyComponents",this.onCopyComponents);this.listenTo(this.tabContextMenuView,"pasteComponents",this.onPasteComponents);this.listenTo(this.tabContextMenuView,"exportTab",this.onExportTab)}},onDuplicateTab:function onDuplicateTab(e){var tabcid=$(e.target).closest(".current").data("tabcid");if(tabcid){this.tabManager.duplicateTab(tabcid)}},getCurrentTabView:function getCurrentTabView(){return this.currentTab},showTabById:function showTabById(tabId){var index=findTabIndexById(this.model.tabs,tabId);this.showTab(index)},onCreateTab:function onCreateTab(options){if(!this.userCanEdit()){throw new Error("You do not have permission to perform this action")}options=_.clone(options||{});if(options.target&&options.preventDefault){options={}}var maxPage=this.tabManager.count()?_(this.tabManager.getTabsWithViews()).chain().map(function(item){return parseInt(item.model.get("name").replace(/^Tab ([0-9]+)$/,"$1"),10)||0}).max().value()||0:0,tabName="Tab "+(maxPage+1);options=_.defaults(options,{name:tabName,settings:currentDashboard.get("settings")});this.tabManager.createTab(options)},onRemoveTab:function onRemoveTab(e){var self=this,$li,index,pageName;if(!this.userCanEdit()){throw new Error("You do not have permission to perform this action")}$li=$(e.target).closest("li");index=this.getTabHeaders().index($li);pageName=$li.find("a").text();this.removeGlobalFilterInputView();$.confirm({title:"Delete Tab",text:'Are you sure you want to delete the tab <span class="nowrap">"'+_.escape(pageName)+'" ?</span>',escape:false},function(result){if(result){self.tabManager.removeTab(index)}})},onShowComponentMenu:function onShowComponentMenu(){var tabView,$addComponentTrigger;if(!this.userCanEdit()){throw new Error("You do not have permission to perform this action")}tabView=this.currentTab;$addComponentTrigger=tabView.$(".show-component-menu");tabView.scrollToComponent($addComponentTrigger,function(){tabView.showComponentsMenu($addComponentTrigger)})},onAddNotesComponent:function onAddNotesComponent(){if(!this.userCanEdit()){throw new Error("You do not have permission to perform this action")}this.currentTab.setupAndAddComponent({type:"note",title:"Note"})},onFilter:function onFilter(e){if(!this.userCanEdit()){throw new Error("You do not have permission to perform this action")}this.globalFilterInputView=GlobalFilterInputsView.show({model:this.currentTab.model,target:e.target,title:"Apply Filters",subtitle:"Tab Filters",tabWideIsEnabled:true,ownerId:this.model.getOwner()})},onDateRange:function onDateRange(e){if(!this.userCanEdit()){throw new Error("You do not have permission to perform this action")}var tabName=this.currentTab.model.get("name");this.currentTab.model.set("tabTimezone",this.model.getTimezone());GlobalDateInputsView.show({model:this.currentTab.model,target:e.target,title:"Apply Date Range to tab: "+tabName,tabWideIsEnabled:true})},onDataSource:function onDataSource(e){if(!this.userCanEdit()){throw new Error("You do not have permission to perform this action")}var tabName=this.currentTab.model.get("name");GlobalQueryInputsView.show({model:this.currentTab.model,target:e.target,title:"Apply Data Source to tab: "+tabName,tabWideIsEnabled:true})},onCopyComponents:function onCopyComponents(){var tab=this.currentTab;tab.copyComponents(tab.components.toJSON())},onPasteComponents:function onPasteComponents(){this.currentTab.pasteComponents()},onExportTab:function onExportTab(){var options={tabId:this.currentTab.model.id};dashboardExportsHelper.confirmExportDashboard(this.dashboardToolbar,options)},onRenameTab:function onRenameTab(e){if(!this.userCanEdit()){throw new Error("You do not have permission to perform this action")}var tabRenameFormView=this.tabRenameFormView,clickedTab,tabModel,$tabNameInput;if(tabRenameFormView){this.removeTabRenameFormView()}clickedTab=$(e.target).closest("li");tabModel=this.model.tabs.get(clickedTab.data("tabcid"));tabRenameFormView=this.tabRenameFormView=new TabRenameFormView({model:tabModel});tabRenameFormView.on("closing",this.removeTabRenameFormView,this);tabRenameFormView.render();clickedTab.addClass("editing").append(tabRenameFormView.$el);$tabNameInput=tabRenameFormView.$(".name");$tabNameInput.focus();$tabNameInput.select()},removeTabRenameFormView:function removeTabRenameFormView(){var tabRenameFormView=this.tabRenameFormView,oldTab=tabRenameFormView.$el.parent(),tabModel=this.model.tabs.get(oldTab.data("tabcid"));tabRenameFormView.off();tabRenameFormView.remove();this.tabRenameFormView=null;oldTab.removeClass("editing");oldTab.find("a.open").text(tabModel.get("name"))},onDragTabStart:function onDragTabStart(ev,dd){var $target;if(!this.userCanEdit()){throw new Error("You do not have permission to perform this action")}$target=$(ev.target);if(!$target.is("li")){$target=$target.closest("li")}return this.dragTabStart($target,dd)},dragTabStart:function dragTabStart(currentTabEl,dd){var currentTabElWidth=currentTabEl.outerWidth(),tolerance=10,$container=this.$(">.tabs"),containerOffset={left:36,top:0},$tabs=this.$(">.tabs li").not(currentTabEl),addTab=$tabs.filter(".add"),tabHeight=currentTabEl.outerHeight(true),positions=getTabPositions($tabs);_.extend(dd,{container:$container,currentTabEl:currentTabEl,tabWidth:currentTabElWidth,tabHeight:tabHeight,positions:positions,minX:containerOffset.left-tolerance,maxX:$container.innerWidth()+tolerance-36,minY:containerOffset.top,maxY:$container.innerHeight(),addTab:addTab,containerOffset:containerOffset,initialTabIndex:currentTabEl.index(),placeholder:currentTabEl.clone()});currentTabEl.after(dd.placeholder.css({visibility:"hidden"}).removeClass("current"));currentTabEl.addClass("dragging");this.dragging=true;$("#customtip").hide()},onDragTab:function onDragTab(ev,dd){if(!this.userCanEdit()){throw new Error("You do not have permission to perform this action")}var tabX=dd.offsetX,tabX2=tabX+dd.tabWidth,tabY=dd.containerOffset.top+Math.round(dd.offsetY/dd.tabHeight)*dd.tabHeight,tabRowIndex,tabToMove,collision,pos;if(tabY+dd.tabHeight>dd.maxY){tabY=dd.maxY-dd.tabHeight}else if(tabY<dd.minY){tabY=dd.minY}tabRowIndex=parseInt(tabY/dd.tabHeight,10);if(tabX<dd.minX){tabX=dd.minX}else if(tabX+dd.tabWidth>dd.maxX){tabX=dd.maxX-dd.tabWidth}tabX2=tabX+dd.tabWidth;collision=_(dd.positions).detect(function(tabData){var row=parseInt(tabData.top/dd.tabHeight,10);if(tabRowIndex!==row||tabX2<tabData.left||tabX>tabData.right){return false}if(tabData.$tab.is(dd.currentTabEl)||tabData.$tab.is(dd.placeholder)||tabData.$tab.is(dd.addTab)){return false}return tabData.mid>=tabX&&tabData.mid<=tabX2});if(collision){pos=dd.placeholder.position();tabToMove=collision.$tab;if(pos.left<collision.left||pos.top<collision.top){tabToMove.after(dd.placeholder)}else{tabToMove.before(dd.placeholder)}dd.positions=getTabPositions(dd.container.find("li"))}dd.currentTabEl.css({left:tabX,top:tabY})},onDragTabEnd:function onDragTabEnd(ev,dd){if(!this.userCanEdit()){throw new Error("You do not have permission to perform this action")}this.dragging=false;dd.placeholder.replaceWith(dd.currentTabEl.detach().removeClass("dragging").css({left:"",top:""}));var newIndex=dd.currentTabEl.index(),oldIndex=dd.initialTabIndex,tabPanes=this.$("section.tab"),oldPane=tabPanes.eq(oldIndex),targetPane=tabPanes.eq(newIndex);if(oldIndex===newIndex){return}if(oldIndex<newIndex){oldPane.insertAfter(targetPane)}else{oldPane.insertBefore(targetPane)}this.tabManager.moveTab(oldIndex,newIndex);this.currentTabIndex=this.$("li.current").index();this.showTab(this.currentTabIndex)},onTabCreated:function onTabCreated(data){var self=this,index=data.index;this.renderTabPlaceholder({model:data.tab,view:data.view}).customtip({predelay:1e3,onBeforeShow:function onBeforeShow(event){if(self.dragging){event.preventDefault()}}});this.showTab(index)},onTabRemoved:function onTabRemoved(data){var index=data.index,tabCount=this.tabManager.count(),tabHeader=this.$(".tabs li").eq(index),tabToShow=tabHeader.next().is("li.add")?tabHeader.prev():tabHeader.next(),isSelected=tabHeader.hasClass("current");tabHeader.remove();if(isSelected){if(tabCount>0){this.showTab(tabToShow.index())}else{this.onCreateTab()}}},onResize:function onResize(){var self=this;_(this.tabManager.getTabsWithViews()).each(function(item){if(item.view===self.currentTab){item.view.resize()}})}})});define("src/helpers/documentTitleHelper",["underscore","src/globals/theme","src/globals/currentProject"],function(_,theme,currentProject){"use strict";return{document:document,setDashboardTitle:function setDashboardTitle(dashboardView){var tabView=dashboardView.getCurrentTabView(),prefix=tabView?tabView.model.get("name")+" - ":"",tabName=prefix+"Dashboard: "+dashboardView.model.get("name");this.setProjectTitle(tabName)},setProjectTitle:function setProjectTitle(title){this.document.title=_([title,"Project: "+currentProject.get("name"),theme.productName]).compact().join(" - ")},setAdminTitle:function setAdminTitle(title){this.document.title=_([title,"Administration",theme.productName]).compact().join(" - ")},clearTitle:function clearTitle(){this.document.title=theme.productName}}});define("src/routes/dashboardRoute",["underscore","jquery","app","appLayout","src/globals/me","src/globals/currentProject","src/globals/currentDashboard","src/models/Dashboard","src/models/DashboardCollection","src/views/DashboardView","src/models/Query","src/helpers/documentTitleHelper","bw-fe-helpers/urlHelper"],function(_,$,app,appLayout,me,currentProject,currentDashboard,Dashboard,DashboardCollection,DashboardView,Query,documentTitleHelper,urlHelper){"use strict";function buildDashboardUrl(projectId,dashboardId,tabId){var path="/project/"+projectId+"/dashboards/"+dashboardId,hash=tabId?"#"+tabId:"",url=path+hash;return url}function getDashboardUrl(dashboardView){var tabView=dashboardView.getCurrentTabView(),tabId=tabView?tabView.model.id:"",projectId=dashboardView.model.get("projectId"),modelId=dashboardView.model.id,url=buildDashboardUrl(projectId,modelId,tabId);return url}return{buildDashboardUrl:buildDashboardUrl,loadDefaultDashboard:function loadDefaultDashboard(projectId){var self=this,queryString=urlHelper.parseQuery(urlHelper.getSearch()),queryId=queryString.queryId,type=queryString.type,showAnnotations=queryString.showAnnotations==="true",query;projectId=parseInt(projectId,10);if(!_.isNumber(projectId)){throw new Error("projectId is not defined")}appLayout.blockUI();query=new Query({id:queryId,projectId:projectId});query.fetch({success:function success(query){function complete(){appLayout.unblockUI()}appLayout.showProject(query.projectId,{showFooter:false},function(e){if(e){appLayout.unblockUI();return appLayout.showProjectError()}Dashboard.create({query:query,dashboardType:type,showAnnotations:showAnnotations,dateRange:queryString.dateRange},function(err,dashboard){dashboard.on("add remove change",self._onCurrentDashboardChanged,self);dashboard.on("sync",self._onCurrentDashboardSync,self);currentDashboard.reset(dashboard.toJSON());self._loadDashboardView(dashboard);appLayout.showPageContainer("dashboard");appLayout.setCurrentPageView(self.dashboardView);return complete(dashboard)})})},error:function error(){appLayout.unblockUI();app.navigate("",{trigger:true});$.notify({text:"Could not load your Query, you might not have access to it or it may have been moved or deleted.",className:"notification-error"})}})},loadDashboard:function loadDashboard(projectId,id,forceCloseOpenDashboard){var self=this,dashboard,tabId=urlHelper.getHash();if(tabId&&tabId.indexOf("/")>=0){tabId=null}id=urlHelper.trimHash(id);if(this.dashboardView&&this.dashboardView.model.id===id&&!forceCloseOpenDashboard){this.preventNavigate=true;this.dashboardView.showTabById(tabId);this.preventNavigate=false;appLayout.showPageContainer("dashboard");appLayout.setCurrentPageView(this.dashboardPageView);appLayout.hideFooter();return}function onError(){app.navigate("project/"+projectId,{trigger:true});$.notify({text:"Could not load your Dashboard, it may have been moved or deleted.",className:"notification-error"})}function onSuccess(dashboard){if(!dashboard){return onError()}self._loadDashboardView(dashboard,tabId,forceCloseOpenDashboard);appLayout.showPageContainer("dashboard");appLayout.setCurrentPageView(self.dashboardView);appLayout.unblockUI()}if(!id){$.notify("Invalid URL!");return app.navigate("",{trigger:true})}appLayout.blockUI();return appLayout.showProject(projectId,{showFooter:false},function(e){if(e){appLayout.unblockUI();return appLayout.showProjectError()}dashboard=new Dashboard({id:id});dashboard.fetch({success:function success(){onSuccess(dashboard)},error:function error(){var dashboards=new DashboardCollection([],{filter:id});dashboards.fetch({success:function success(){if(!this.size()){return onError()}onSuccess(this.at(0))},error:onError})}})})},loadDashboardFromTemplate:function loadDashboardFromTemplate(args){var template=args.template,queryId=args.queryId,projectId=currentProject.id;appLayout.blockUI();Dashboard.createFromTemplate(template,queryId,projectId,function(err,dashboard){dashboard.save({userId:me.id,dashboardType:args.dashboardType},{success:function success(){var url="project/"+projectId+"/dashboards/"+dashboard.id;app.navigate(url,{trigger:true});appLayout.unblockUI()},error:function error(){$.notify({text:"Could not create a dashboard from the template.",className:"notification-error"});appLayout.unblockUI()}})})},_onSelectDashboardTab:function _onSelectDashboardTab(dashboardView){documentTitleHelper.setDashboardTitle(dashboardView);if(dashboardView.model.isNew()){return}app.navigate(getDashboardUrl(dashboardView),{trigger:false,replace:true})},_onCurrentDashboardChanged:function _onCurrentDashboardChanged(dashboard){currentDashboard.reset(dashboard.toJSON())},_onCurrentDashboardSync:function _onCurrentDashboardSync(){currentDashboard.trigger("sync")},_loadDashboardView:function _loadDashboardView(dashboard,tabId,forceCloseOpenDashboard){var self=this,$container=appLayout.getPageContainer("dashboard"),dashboardView=this.dashboardView,onSelectDashboardTab=this._onSelectDashboardTab,doLoad=_.bind(function(){currentDashboard.reset(dashboard.toJSON());dashboardView=this.dashboardView=new DashboardView({model:dashboard,tabId:tabId});dashboardView.$el.attr("id","components").appendTo($container);dashboardView.render();if(!dashboardView.model.isNew()&&(!tabId||dashboardView.getCurrentTabView().model.id!==tabId)){app.navigate(getDashboardUrl(dashboardView),{trigger:false,replace:true})}dashboardView.on("tabSelected",onSelectDashboardTab);documentTitleHelper.setDashboardTitle(dashboardView);dashboard.on("add remove change",self._onCurrentDashboardChanged,self);dashboard.on("sync",self._onCurrentDashboardSync,self)},this);if(!dashboardView){return doLoad()}dashboardView.close(function(wasClosed){if(!wasClosed){return}return doLoad()},{forceCloseDirty:forceCloseOpenDashboard})},close:function close(callback){var self=this;if(!this.dashboardView){if(_.isFunction(callback)){callback(true)}return}this.dashboardView.close(function(wasClosed){if(wasClosed){self.dashboardView=null}callback(wasClosed)})},unload:function unload(){if(this.dashboardView){this.dashboardView.remove();this.dashboardView=null}}}})})();