define(["underscore","q","bw-fe-helpers/promiseHelper","src/models/DataModel","src/components/keyinsights/helpers/keyInsightsHelper","src/components/keyinsights/helpers/constants","src/components/keyinsights/helpers/keyInsightsModelDataHelper","src/models/CombinedQueryControls","src/helpers/componentRestrictions"],function(_,Q,promiseHelper,DataModel,keyInsightsHelper,constants,modelDataHelper,CombinedQueryControls,componentRestrictions){"use strict";var MENTIONS_COUNT_PATH="data/mentions/count";var UNIQUE_AUTHORS_PATH="data/authors/all/all";var UNIQUE_IMAGES_PATH="data/logoimages";var TRENDING_TOPICS_PATH="data/topics";var TOP_STORIES_PATH="data/mentions";var TOP_HASHTAGS_PATH="data/hashtags";function convertKeysAndResponsesIntoObject(requests,responses){var obj={};requests.forEach(function(request,index){obj[request.key]=responses[index]});return obj}function isSolrData(jqXHR){if(jqXHR&&jqXHR.getResponseHeader){return jqXHR.getResponseHeader("x-solr-mentions")==="true"}return false}function getMentionsCountRequest(queryData){var mentionsCountFilter={excludeNotes:true};return modelDataHelper.makeAjaxRequest(MENTIONS_COUNT_PATH,Object.assign({},queryData,mentionsCountFilter))}function getUniqueAuthorsRequest(queryData){return modelDataHelper.makeAjaxRequest(UNIQUE_AUTHORS_PATH,queryData)}function getUniqueImagesRequest(queryData){return modelDataHelper.makeAjaxRequest(UNIQUE_IMAGES_PATH,queryData)}function getTopHashtagsRequest(queryData){var topHashtagsFilters={limit:3};return modelDataHelper.makeAjaxRequest(TOP_HASHTAGS_PATH,Object.assign({},queryData,topHashtagsFilters))}function getTrendingTopicsRequest(queryData){if(componentRestrictions.isRestricted("topics")){return Q.Promise.resolve(null)}var trendingTopicsFilters={limit:3,orderBy:"trending",orderDirection:"desc",extract:"phrases",metrics:["volume","trending"]};return modelDataHelper.makeAjaxRequest(TRENDING_TOPICS_PATH,_.extend({},queryData,trendingTopicsFilters))}function getTopStoriesRequest(queryData){var topStoriesFilters={orderBy:"impact",orderDirection:"desc",pageSize:3,pageType:"news"};return modelDataHelper.makeAjaxRequest(TOP_STORIES_PATH,_.extend({},queryData,topStoriesFilters))}return DataModel.extend({constructor:function KeyInsightsModel(){DataModel.apply(this,arguments)},controlsModel:CombinedQueryControls,getDataRequests:function getDataRequests(){var currentPeriodQueryData=this.getQueryData();var previousPeriodQueryData=modelDataHelper.mapToPreviousPeriod(currentPeriodQueryData);var queryTypes=keyInsightsHelper.getQueryTypes(currentPeriodQueryData);var requests=[];requests.push({key:"currentTotalMentionsResponse",request:getMentionsCountRequest(currentPeriodQueryData)});requests.push({key:"previousTotalMentionsResponse",request:getMentionsCountRequest(previousPeriodQueryData)});requests.push({key:"currentUniqueAuthorsResponse",request:getUniqueAuthorsRequest(currentPeriodQueryData)});requests.push({key:"previousUniqueAuthorsResponse",request:getUniqueAuthorsRequest(previousPeriodQueryData)});requests.push({key:"trendingTopicsResponse",request:getTrendingTopicsRequest(currentPeriodQueryData)});if(keyInsightsHelper.isLogoQuery(queryTypes)){requests.push({key:"currentUniqueImagesResponse",request:getUniqueImagesRequest(currentPeriodQueryData)});requests.push({key:"previousUniqueImagesResponse",request:getUniqueImagesRequest(previousPeriodQueryData)})}if(keyInsightsHelper.isTextQuery(queryTypes)){requests.push({key:"topStoriesResponse",request:getTopStoriesRequest(currentPeriodQueryData)})}if(keyInsightsHelper.isTwitterOrInstagramQuery(queryTypes)||currentPeriodQueryData.pageType&&(currentPeriodQueryData.pageType.includes("instagram")||currentPeriodQueryData.pageType.includes("twitter"))){requests.push({key:"topHashtagsResponse",request:getTopHashtagsRequest(currentPeriodQueryData)})}return requests},fetch:function fetch(){this.trigger("request");var dataRequests=this.getDataRequests();var promisifiedRequests=dataRequests.map(function(dataRequest){return dataRequest.request}).map(promiseHelper.wrapJqXHR);return this._handleResponses(dataRequests,promisifiedRequests)},_handleResponses:function _handleResponses(dataRequests,promisifiedRequests){var self=this;return Q.all(promisifiedRequests).then(function(responses){var requests=dataRequests.map(function(dataRequest){return dataRequest.request});if(requests.every(isSolrData)){self.hasSolrData=true}else if(requests.some(isSolrData)){self.hasPartialSolrData=true}var results=convertKeysAndResponsesIntoObject(dataRequests,responses);var parsedData=self.parse(results);self.set(parsedData);self.trigger("sync")}).catch(function(error){self.trigger("error",error)})},parse:function parse(results){var data={};this.backfillDetails=results.currentTotalMentionsResponse.backfillDetails;data[constants.totalMentions]=modelDataHelper.buildTotalMentions(results.currentTotalMentionsResponse,results.previousTotalMentionsResponse);data[constants.uniqueAuthors]=modelDataHelper.buildUniqueAuthors(results.currentUniqueAuthorsResponse,results.previousUniqueAuthorsResponse);if(results.currentUniqueImagesResponse&&results.previousUniqueImagesResponse){data[constants.uniqueImages]=modelDataHelper.buildUniqueImages(results.currentUniqueImagesResponse,results.previousUniqueImagesResponse)}data[constants.trendingTopics]=modelDataHelper.buildTrendingTopics(results.trendingTopicsResponse);if(results.topStoriesResponse){data[constants.topStories]=modelDataHelper.buildTopStories(results.topStoriesResponse)}if(results.topHashtagsResponse){data[constants.topHashtags]=modelDataHelper.buildTopHashtags(results.topHashtagsResponse)}return data}})});