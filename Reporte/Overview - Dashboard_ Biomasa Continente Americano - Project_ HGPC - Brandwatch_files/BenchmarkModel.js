function _toConsumableArray(arr){return _arrayWithoutHoles(arr)||_iterableToArray(arr)||_nonIterableSpread()}function _nonIterableSpread(){throw new TypeError("Invalid attempt to spread non-iterable instance")}function _iterableToArray(iter){if(Symbol.iterator in Object(iter)||Object.prototype.toString.call(iter)==="[object Arguments]")return Array.from(iter)}function _arrayWithoutHoles(arr){if(Array.isArray(arr)){for(var i=0,arr2=new Array(arr.length);i<arr.length;i++){arr2[i]=arr[i]}return arr2}}function _slicedToArray(arr,i){return _arrayWithHoles(arr)||_iterableToArrayLimit(arr,i)||_nonIterableRest()}function _nonIterableRest(){throw new TypeError("Invalid attempt to destructure non-iterable instance")}function _iterableToArrayLimit(arr,i){var _arr=[];var _n=true;var _d=false;var _e=undefined;try{for(var _i=arr[Symbol.iterator](),_s;!(_n=(_s=_i.next()).done);_n=true){_arr.push(_s.value);if(i&&_arr.length===i)break}}catch(err){_d=true;_e=err}finally{try{if(!_n&&_i["return"]!=null)_i["return"]()}finally{if(_d)throw _e}}return _arr}function _arrayWithHoles(arr){if(Array.isArray(arr))return arr}define(["jquery","moment","src/Workbench","src/components/benchmark/models/BenchmarkControls","src/globals/currentDashboard","src/models/DataModel","bw-fe-helpers/dateRangeFormatter","bw-fe-helpers/isoDateHelper","bw-fe-helpers/validationHelpers"],function($,moment,Workbench,BenchmarkControls,currentDashboard,DataModel,dateRangeFormatter,isoDateHelper,validationHelpers){"use strict";var SORT_FUNCTIONS={alphabeticalAsc:function alphabeticalAsc(a,b){return a.name.localeCompare(b.name)},alphabeticalDesc:function alphabeticalDesc(a,b){return-a.name.localeCompare(b.name)},percentageChange:function percentageChange(a,b){return b.percentageChange-a.percentageChange},volume:function volume(a,b){return b.currentValue-a.currentValue}};var FILTER_KEYS={pageTypes:{includeKey:"pageType",excludeKey:"xpageType"},sentiment:{includeKey:"sentiment"},emotions:{includeKey:"classifications",excludeKey:"xclassifications"},profession:{includeKey:"profession",excludeKey:"xprofession"},gender:{includeKey:"gender"},interest:{includeKey:"interest",excludeKey:"xinterest"}};function calculatePercentageChange(currentValue,previousValue){if(previousValue===0&&currentValue===0){return 0}var changeFactor=previousValue!==0?currentValue/previousValue:2;return-100+changeFactor*100}function calculatePreviousTimespan(startDate,endDate){var diffInterval=moment(endDate).diff(startDate)>864e5?"days":"seconds";var diff=moment(endDate).diff(startDate,diffInterval);var newStart=moment(startDate).subtract(diff,diffInterval).toISOString();return{startDate:newStart,endDate:startDate}}function getValueSum(){var _ref=arguments.length>0&&arguments[0]!==undefined?arguments[0]:{values:[]},values=_ref.values;return values.reduce(function(currentSum,value){return currentSum+value.value},0)}function filterResults(){var results=arguments.length>0&&arguments[0]!==undefined?arguments[0]:[];var settings=arguments.length>1?arguments[1]:undefined;var dimension=arguments.length>2?arguments[2]:undefined;var _ref2=FILTER_KEYS[dimension]||{},includeKey=_ref2.includeKey,excludeKey=_ref2.excludeKey;var filteredResults=results;if(includeKey||excludeKey){var includes=settings.get(includeKey)||[];var excludes=settings.get(excludeKey)||[];if(includes.length>0){filteredResults=results.filter(function(_ref3){var id=_ref3.id;return includes.includes(id)})}if(excludes.length>0){filteredResults=filteredResults.filter(function(_ref4){var id=_ref4.id;return!excludes.includes(id)})}}return filteredResults}function filterEmptyResults(){var results=arguments.length>0&&arguments[0]!==undefined?arguments[0]:[];return results.filter(function(_ref5){var currentValue=_ref5.currentValue,previousValue=_ref5.previousValue;return currentValue>0||previousValue>0})}var BenchmarkModel=DataModel.extend({controlsModel:BenchmarkControls,doNotFetchOnSettingsChange:["orderBy"],constructor:function BenchmarkModel(){DataModel.apply(this,arguments)},url:function url(){var dimension=this.settings.get("dimension");var aggregate=this.settings.get("aggregate");if(["authorCities","authorCounties","authorStates","authorCountries","authorContinents"].includes(dimension)){dimension=dimension.replace("author","").toLowerCase()}return"/projects/{projectId}/data/".concat(aggregate,"/").concat(dimension,"/days")},getData:function getData(queryData){var requestUrl=Workbench.buildApiUrl(this.url());return $.ajax(requestUrl,{data:queryData})},getUniqueAuthorData:function getUniqueAuthorData(queryData){var dimension=this.settings.get("dimension");var requestUrl=Workbench.buildApiUrl("/projects/{projectId}/data/authors/".concat(dimension,"/all"));return $.ajax(requestUrl,{data:queryData})},getPreviousQueryData:function getPreviousQueryData(){var queryData=this.getQueryData();var startDate=queryData.startDate,endDate=queryData.endDate;var comparisonTimespan=calculatePreviousTimespan(startDate,endDate);return Object.assign({},queryData,comparisonTimespan)},getRequests:function getRequests(){var queryData=this.getQueryData();var previousQueryData=this.getPreviousQueryData();var requests=[this.getData(queryData),this.getData(previousQueryData)];var aggregate=this.settings.get("aggregate");if(aggregate==="authors"){requests.push(this.getUniqueAuthorData(queryData));requests.push(this.getUniqueAuthorData(previousQueryData))}return requests},getDateRangeLabels:function getDateRangeLabels(){var _this$settings$toJSON=this.settings.toJSON(),dateRange=_this$settings$toJSON.dateRange,specifyTime=_this$settings$toJSON.specifyTime;var timezone=currentDashboard.getTimezone();var dateRangeFormattingOptions={timezone:timezone,specifyTime:specifyTime,addTimezoneOffsetInfo:currentDashboard.isProjectsTimezoneOverriden()};var currentDateRangeLabel;var previousDateRangeLabel;if(isoDateHelper.isISODatePeriod(dateRange)){currentDateRangeLabel=dateRangeFormatter.format(dateRange,dateRangeFormattingOptions);previousDateRangeLabel=currentDateRangeLabel.replace("Last","Previous").replace("Today","Yesterday")}else{var _isoDateHelper$parseI=isoDateHelper.parseISODateRange(dateRange),startDate=_isoDateHelper$parseI.startDate,endDate=_isoDateHelper$parseI.endDate;var _calculatePreviousTim=calculatePreviousTimespan(startDate,endDate),previousStartDate=_calculatePreviousTim.startDate,previousEndDate=_calculatePreviousTim.endDate;var previousDateRange=isoDateHelper.makeISODateRange(previousStartDate,previousEndDate);currentDateRangeLabel=dateRangeFormatter.format(dateRange,dateRangeFormattingOptions);previousDateRangeLabel=dateRangeFormatter.format(previousDateRange,dateRangeFormattingOptions)}return{currentDateRangeLabel:currentDateRangeLabel,previousDateRangeLabel:previousDateRangeLabel}},fetch:function fetch(){var _this=this;this.trigger("request");var requests=this.getRequests();return Promise.all(requests).then(function(responses){var parsedData=_this.parse(responses);_this.set(parsedData,{silent:true});_this.sortData();_this.trigger("sync")}).catch(function(error){return _this.trigger("error",error)})},reloadData:function reloadData(){var changedAttributes=this.settings.changedAttributes();if(Object.keys(changedAttributes).length===1&&changedAttributes.orderBy){this.sortData()}if(changedAttributes.currentMode==="queryGroup"&&validationHelpers.isNullOrEmpty(this.settings.get("queryGroupId"))){return}DataModel.prototype.reloadData.call(this)},parse:function parse(_ref6){var _ref7=_slicedToArray(_ref6,4),_ref7$=_ref7[0],currentData=_ref7$===void 0?{results:[]}:_ref7$,_ref7$2=_ref7[1],previousData=_ref7$2===void 0?{results:[]}:_ref7$2,_ref7$3=_ref7[2],currentAuthorData=_ref7$3===void 0?{results:[]}:_ref7$3,_ref7$4=_ref7[3],previousAuthorData=_ref7$4===void 0?{results:[]}:_ref7$4;var filteredCurrentData=filterResults(currentData.results,this.settings,currentData.dimension1);var filteredPreviousData=filterResults(previousData.results,this.settings,previousData.dimension1);var dataIds=Array.from(new Set([].concat(_toConsumableArray(filteredPreviousData),_toConsumableArray(filteredCurrentData)).map(function(item){return item.id})));var groupedData=dataIds.map(function(id){var currentItem=filteredCurrentData.find(function(current){return current.id===id});var previousItem=filteredPreviousData.find(function(previous){return previous.id===id});if(!currentItem){currentItem={id:previousItem.id,name:previousItem.name,values:previousItem.values.map(function(item){return Object.assign({},item,{value:0})})}}if(!previousItem){previousItem={id:currentItem.id,name:currentItem.name,values:currentItem.values.map(function(item){return Object.assign({},item,{value:0})})}}var currentSum;var previousSum;if(currentData.aggregate==="authors"){var currentAuthorItem=currentAuthorData.results.find(function(current){return current.id===id});var previousAuthorItem=previousAuthorData.results.find(function(previous){return previous.id===id});currentSum=getValueSum(currentAuthorItem);previousSum=getValueSum(previousAuthorItem)}else{currentSum=getValueSum(currentItem);previousSum=getValueSum(previousItem)}return{id:id,name:currentItem.name,currentValue:currentSum,previousValue:previousSum,currentDataSet:currentItem.values,previousDataSet:previousItem.values,percentageChange:calculatePercentageChange(currentSum,previousSum)}});return Object.assign({aggregate:currentData.aggregate,dimension1:currentData.dimension1,dimension2:currentData.dimension2,results:currentData.dimension1==="pageTypes"?filterEmptyResults(groupedData):groupedData},this.getDateRangeLabels())},sortData:function sortData(){var orderBy=this.settings.get("orderBy");this.get("results").sort(SORT_FUNCTIONS[orderBy])}});return BenchmarkModel});