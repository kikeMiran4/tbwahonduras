(function(){define("src/helpers/queueEventsHelper",[],function(){"use strict";var queuedEvents=new WeakMap;function retriggerEvents(eventBus){eventBus.off("all");var queueForBus=queuedEvents.get(eventBus)||[];queueForBus.forEach(function(args){eventBus.trigger.apply(eventBus,args)});queuedEvents.set(eventBus,[])}function listenForEvents(eventBus){var ignoreEvents=arguments.length>1&&arguments[1]!==undefined?arguments[1]:[];eventBus.on("all",function(eventName){if(ignoreEvents.includes(eventName)){return}if(!queuedEvents.has(eventBus)){queuedEvents.set(eventBus,[])}var queueForBus=queuedEvents.get(eventBus);for(var _len=arguments.length,args=new Array(_len>1?_len-1:0),_key=1;_key<_len;_key++){args[_key-1]=arguments[_key]}queueForBus.push([eventName].concat(args))})}return{listenForEvents:listenForEvents,retriggerEvents:retriggerEvents}});function _objectSpread(target){for(var i=1;i<arguments.length;i++){var source=arguments[i]!=null?arguments[i]:{};var ownKeys=Object.keys(source);if(typeof Object.getOwnPropertySymbols==="function"){ownKeys=ownKeys.concat(Object.getOwnPropertySymbols(source).filter(function(sym){return Object.getOwnPropertyDescriptor(source,sym).enumerable}))}ownKeys.forEach(function(key){_defineProperty(target,key,source[key])})}return target}function _defineProperty(obj,key,value){if(key in obj){Object.defineProperty(obj,key,{value:value,enumerable:true,configurable:true,writable:true})}else{obj[key]=value}return obj}define("src/components/ComponentWithCustomizeBar",["backbone","src/ReactAppLoader","src/permissions","src/globals/authorGroups","src/globals/currentDashboard","src/globals/siteGroups","src/globals/flags","src/globals/flagNames","src/models/SiteGroup","src/controls/lib/paramAssert","src/components/Component","src/helpers/queueEventsHelper","src/helpers/componentEventsHelper","src/views/AuthorGroupAdministrationView","src/views/CreateEditSiteGroupView"],function(Backbone,ReactAppLoader,permissions,authorGroups,currentDashboard,siteGroups,flags,FLAGS,SiteGroup,paramAssert,Component,queueEventsHelper,componentEventsHelper,AuthorGroupAdministrationView,CreateEditSiteGroupView){"use strict";var CUSTOMIZE_BAR_ACTIONS={TOGGLE_CUSTOMIZE_BAR:"toggleCustomizeBar"};function listenToMessageBus(view){view.listenTo(view.messageBus,"settings:set",function(settings){var controlsSettings=view.mapSettingsDataForControls(settings);view.model.settings.set(controlsSettings);componentEventsHelper.triggerComponentSettingsSetTrackingEvent(view,controlsSettings)});var ignoreEvents=["data:error","data:loading","data:loaded","component:ready"];queueEventsHelper.listenForEvents(view.messageBus,ignoreEvents);view.messageBus.on("component:ready",function(){queueEventsHelper.retriggerEvents(view.messageBus)});view.messageBus.on("data:reload",function(){view.model.fetch()});view.messageBus.on("customizeBar:toggled",function(open){view.customizeBarOpen=open;view.trigger("customizeBarToggled",view,open)});view.messageBus.on("newdimensionpopup:open",function(dimension){view.onNewDimensionValueClick(dimension)})}function emitGlobalsChange(view){view.messageBus.trigger("globals:change",getCustomizeBarGlobalsAsJSON(view))}function getCustomizeBarGlobalsAsJSON(view){var globals=view.getCustomizeBarGlobals();return Object.keys(globals).reduce(function(memo,key){memo[key]=globals[key].toJSON();return memo},{})}return Component.extend({constructor:function ComponentWithCustomizeBar(){var options=arguments.length>0&&arguments[0]!==undefined?arguments[0]:{};if(flags.variation(FLAGS.ENABLE_NEW_CUSTOMIZE_BAR)){paramAssert.isNotDefined(this.customizeBarConfigKey,"this.customizeBarConfigKey must be defined")}Component.apply(this,arguments);this.intializeCustomizeBar(options)},intializeCustomizeBar:function intializeCustomizeBar(options){var _this=this;this.customizeBarOpen=options.customizeBarOpen!==false;if(flags.variation(FLAGS.ENABLE_NEW_CUSTOMIZE_BAR)){this.commonCustomizeBarReactApp=new ReactAppLoader("commonCustomizeBar");this.listenTo(this.model.settings,"change",function(){_this.renderNewCustomizeBar()});this.on("switchView",function(){return _this.renderNewCustomizeBar()})}if(!this.customizeBarAppKey){return}this.customizeBarReactApp=new ReactAppLoader(this.customizeBarAppKey);this.messageBus=Object.assign({},Backbone.Events);this.listenTo(this.model,"sync",function(){_this.messageBus.trigger("data:change",_this.model.toJSON());_this.renderNewCustomizeBar()});this.listenTo(this.model.settings,"change",function(){var customizeBarSettings=_this.mapSettingsDataForCustomizeBar(_this.model.settings.toJSON());_this.messageBus.trigger("settings:change",customizeBarSettings)});listenToMessageBus(this);var globals=this.getCustomizeBarGlobals();Object.keys(globals).forEach(function(key){return _this.listenTo(globals[key],"sync",emitGlobalsChange.bind(null,_this))})},mapSettingsDataForCustomizeBar:function mapSettingsDataForCustomizeBar(controlsSettings){return controlsSettings},mapSettingsDataForControls:function mapSettingsDataForControls(customizeBarSettings){return customizeBarSettings},getCustomizeBarGlobals:function getCustomizeBarGlobals(){return{}},getCustomizeBarRenderProps:function getCustomizeBarRenderProps(){},onSettingsChange:function onSettingsChange(settings){this.model.settings.set(this.mapSettingsDataForControls(settings))},onAction:function onAction(key,value){if(key===CUSTOMIZE_BAR_ACTIONS.TOGGLE_CUSTOMIZE_BAR){this.customizeBarOpen=value;this.trigger("customizeBarToggled",this,value);this.renderNewCustomizeBar()}},renderNewCustomizeBar:function renderNewCustomizeBar(){if(!flags.variation(FLAGS.ENABLE_NEW_CUSTOMIZE_BAR)){return}this.$("[data-reactapp=common-customize-bar]").html(this.commonCustomizeBarReactApp.$el);this.commonCustomizeBarReactApp.render({options:{configKey:this.customizeBarConfigKey,currentViewKey:this.currentViewKey,permissions:{canSeeControls:permissions.check("see.dashboard.controls",currentDashboard)},customizeBarOpen:this.customizeBarOpen,onSettingsChange:this.onSettingsChange.bind(this),onAction:this.onAction.bind(this)},settings:_objectSpread({},this.mapSettingsDataForCustomizeBar(this.model.settings.toJSON()))})},renderCustomizeBar:function renderCustomizeBar(){if(!this.customizeBarReactApp){return}this.$("[data-reactapp=customize-bar]").html(this.customizeBarReactApp.$el);this.customizeBarReactApp.render(_objectSpread({messageBus:this.messageBus,settings:this.mapSettingsDataForCustomizeBar(this.model.settings.toJSON()),data:this.model.toJSON(),globals:getCustomizeBarGlobalsAsJSON(this),customizeBarOpen:this.customizeBarOpen},this.getCustomizeBarRenderProps(),{permissions:{canSeeControls:permissions.check("see.dashboard.controls",currentDashboard)}}))},onNewDimensionValueClick:function onNewDimensionValueClick(dimension){switch(dimension){case"domains":CreateEditSiteGroupView.show({collection:siteGroups,model:new SiteGroup});break;case"authors":AuthorGroupAdministrationView.show({collection:authorGroups});break}},buildCustomizeBar:function buildCustomizeBar(){},render:function render(){var renderResult=Component.prototype.render.apply(this,arguments);this.renderCustomizeBar();this.renderNewCustomizeBar();return renderResult},remove:function remove(){if(this.customizeBarReactApp){this.customizeBarReactApp.remove()}if(this.commonCustomizeBarReactApp){this.commonCustomizeBarReactApp.remove()}if(this.messageBus){this.messageBus.off();this.messageBus=undefined}Component.prototype.remove.call(this)}})})})();